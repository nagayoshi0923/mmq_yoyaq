-- =============================================================================
-- ペネトレーションテスト修正 Round 3 (2026-02-11)
-- =============================================================================
-- 新規テスト K-T で発見された脆弱性を修正
--
-- M-1: customer ロールが他の顧客の電話番号等の個人情報を閲覧可能
-- O-1: customer ロールが顧客レコードを直接 INSERT 可能
-- S-2: 予約データ1000件の一括取得（PostgREST設定の問題。RLSでは対応困難）
-- =============================================================================

-- =============================================================================
-- 1. customers SELECT: _strict ポリシーを staff/admin のみに制限
--    現状: 同組織の全ユーザーが全顧客データを閲覧可能
--    修正: staff/admin のみが組織内の全顧客を閲覧可能
--    ※ customers_select_self_or_admin は残す（自分のデータ閲覧用）
-- =============================================================================

DROP POLICY IF EXISTS "customers_select_strict" ON public.customers;

CREATE POLICY "customers_select_staff_or_admin_org"
  ON public.customers
  FOR SELECT
  USING (
    CASE
      -- staff/admin: 同組織の全顧客を閲覧可能
      WHEN is_staff_or_admin() THEN
        organization_id = get_user_organization_id()
      -- 一般ユーザー（customer）: 自分のデータのみ
      ELSE
        user_id IS NOT NULL AND user_id = auth.uid()
    END
  );

-- =============================================================================
-- 2. customers INSERT: _strict ポリシーを staff/admin のみに制限
--    現状: 同組織の全ユーザーが顧客レコードを作成可能
--    修正: staff/admin のみが顧客レコードを作成可能
--    ※ 公開予約ページからの顧客登録は create_reservation_with_lock_v2
--      (SECURITY DEFINER) 経由で行われるため、RLS をバイパスする
-- =============================================================================

DROP POLICY IF EXISTS "customers_insert_strict" ON public.customers;

CREATE POLICY "customers_insert_staff_or_admin_org"
  ON public.customers
  FOR INSERT
  WITH CHECK (
    CASE
      -- staff/admin: 同組織に顧客レコードを作成可能
      WHEN is_staff_or_admin() THEN
        organization_id = get_user_organization_id()
      -- 一般ユーザー: 自分自身のレコードのみ作成可能
      ELSE
        user_id IS NOT NULL AND user_id = auth.uid()
    END
  );

-- =============================================================================
-- 3. customers UPDATE: _strict ポリシーを staff/admin のみに制限
-- =============================================================================

DROP POLICY IF EXISTS "customers_update_strict" ON public.customers;

CREATE POLICY "customers_update_staff_or_admin_org"
  ON public.customers
  FOR UPDATE
  USING (
    CASE
      WHEN is_staff_or_admin() THEN
        organization_id = get_user_organization_id()
      ELSE
        user_id IS NOT NULL AND user_id = auth.uid()
    END
  )
  WITH CHECK (
    CASE
      WHEN is_staff_or_admin() THEN
        organization_id = get_user_organization_id()
      ELSE
        user_id IS NOT NULL AND user_id = auth.uid()
    END
  );

-- =============================================================================
-- 4. customers DELETE: _strict ポリシーを admin のみに制限
-- =============================================================================

DROP POLICY IF EXISTS "customers_delete_strict" ON public.customers;

CREATE POLICY "customers_delete_admin_org"
  ON public.customers
  FOR DELETE
  USING (
    is_admin() AND organization_id = get_user_organization_id()
  );

-- =============================================================================
-- 5. テストで作成された偽の顧客レコードをクリーンアップ
-- =============================================================================
DELETE FROM public.customers WHERE email = 'fake@attacker.com';

-- =============================================================================
-- NOTE: S-2（予約データ1000件の一括取得）について
-- これは PostgREST の max-rows 設定の問題であり、RLS では対応困難。
-- Supabase ダッシュボード → Settings → API → Max Rows で制限可能。
-- 推奨値: 100〜200
-- ただし、管理ツールのページネーションにも影響するため要検討。
-- =============================================================================
