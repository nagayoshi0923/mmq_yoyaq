-- =============================================================================
-- ペネトレーションテスト修正 Round 5 (2026-02-11)
-- =============================================================================
-- 全87テーブル総検査で発見された漏洩テーブルを修正：
--
-- 1. global_settings: USING(true)で他組織の給与データが丸見え → staff/admin+自組織のみ
-- 2. organization_settings: customerからAPIキーフィールドが見える → admin+自組織のみ
-- 3. gm_availability_responses: 55件のGM空き状況が見える → staff/admin+自組織のみ
-- 4. reservations_history: 予約履歴(個人情報含む)が見える → staff/admin+自組織のみ
-- 5. staff_scenario_assignments: USING(true)でスタッフ情報見える → staff/admin+自組織のみ
-- 6. scenario_masters: 内部データが見える → staff/admin+自組織 or ライセンス管理者
-- 7. organization_scenarios: USING(true)で内部費用データ見える → staff/admin+自組織
-- =============================================================================

-- =============================================================================
-- 1. global_settings: 他組織の給与データ漏洩を修正
-- =============================================================================
-- 問題: "Anyone can read global settings" USING(true) と "global_settings_select_all" USING(true)
-- 結果: customer が他組織(b000...)のgm_base_pay, gm_hourly_rate等を閲覧可能

DROP POLICY IF EXISTS "Anyone can read global settings" ON public.global_settings;
DROP POLICY IF EXISTS "global_settings_select_all" ON public.global_settings;
DROP POLICY IF EXISTS "global_settings_strict" ON public.global_settings;
-- "Authenticated users can update global settings" も危険（全ユーザー更新可能）
DROP POLICY IF EXISTS "Authenticated users can update global settings" ON public.global_settings;

-- staff/admin のみ自組織のデータを閲覧
-- (global_settings_select_admin は別途存在するが念のため作成)
DO $$ BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies 
    WHERE tablename = 'global_settings' AND policyname = 'global_settings_select_staff_org'
  ) THEN
    CREATE POLICY "global_settings_select_staff_org"
      ON public.global_settings
      FOR SELECT
      USING (
        is_staff_or_admin() AND organization_id = get_user_organization_id()
      );
  END IF;
END $$;

-- =============================================================================
-- 2. organization_settings: APIキー漏洩を修正
-- =============================================================================
-- 問題: "organization_settings_select" USING(org match OR is_org_admin)
-- 結果: customer が discord_bot_token, resend_api_key 等のフィールドにアクセス可能

DROP POLICY IF EXISTS "organization_settings_select" ON public.organization_settings;
-- organization_settings_insert も org match で customer が INSERT 可能
DROP POLICY IF EXISTS "organization_settings_insert" ON public.organization_settings;
-- organization_settings_update も同様
DROP POLICY IF EXISTS "organization_settings_update" ON public.organization_settings;

-- =============================================================================
-- 3. gm_availability_responses: GM空き状況漏洩を修正
-- =============================================================================
-- 問題: "gm_availability_responses_read_policy" が org match で customer にも公開
-- 結果: customer が55件のGM空き状況(staff_id含む)を閲覧可能

DROP POLICY IF EXISTS "gm_availability_responses_read_policy" ON public.gm_availability_responses;
DROP POLICY IF EXISTS "gm_availability_responses_select_strict" ON public.gm_availability_responses;

-- staff/admin のみ + 自分のスタッフレスポンス
CREATE POLICY "gm_availability_responses_select_staff_or_admin"
  ON public.gm_availability_responses
  FOR SELECT
  USING (
    (is_staff_or_admin() AND organization_id = get_user_organization_id())
    OR (staff_id IN (SELECT id FROM public.staff WHERE user_id = auth.uid()))
  );

-- =============================================================================
-- 4. reservations_history: 予約履歴漏洩を修正
-- =============================================================================
-- 問題: "reservations_history_select_org_scoped" USING(org match)
-- 結果: customer が他人の予約変更履歴(個人情報含む)を閲覧可能

DROP POLICY IF EXISTS "reservations_history_select_org_scoped" ON public.reservations_history;

-- staff/admin のみ（監査データなので customer には不要）
CREATE POLICY "reservations_history_select_staff_or_admin"
  ON public.reservations_history
  FOR SELECT
  USING (
    is_staff_or_admin() AND organization_id = get_user_organization_id()
  );

-- =============================================================================
-- 5. staff_scenario_assignments: スタッフ情報漏洩を修正
-- =============================================================================
-- 問題: "Enable read access for all users" USING(true)
-- 結果: 全ユーザーがスタッフとシナリオの割り当て情報を閲覧可能

DROP POLICY IF EXISTS "Enable read access for all users" ON public.staff_scenario_assignments;

-- staff/admin のみ自組織のデータを閲覧
CREATE POLICY "staff_scenario_assignments_select_staff_or_admin"
  ON public.staff_scenario_assignments
  FOR SELECT
  USING (
    is_staff_or_admin() AND organization_id = get_user_organization_id()
  );

-- =============================================================================
-- 6. scenario_masters: 内部データ漏洩を修正
-- =============================================================================
-- 問題: "scenario_masters_select" が master_status IN (...) で全ユーザーに公開
-- 結果: customer がシナリオマスターの内部管理データを閲覧可能

DROP POLICY IF EXISTS "scenario_masters_select" ON public.scenario_masters;

-- staff/admin + ライセンス管理者のみ
CREATE POLICY "scenario_masters_select_staff_or_admin"
  ON public.scenario_masters
  FOR SELECT
  USING (
    is_staff_or_admin()
    OR is_license_admin()
  );

-- =============================================================================
-- 7. organization_scenarios: 内部費用データ漏洩を修正
-- =============================================================================
-- 問題: "org_scenarios_select" USING(true)
-- 結果: 全ユーザーが gm_costs, license_amount 等の内部費用データを閲覧可能

DROP POLICY IF EXISTS "org_scenarios_select" ON public.organization_scenarios;

-- staff/admin + ライセンス管理者のみ
CREATE POLICY "org_scenarios_select_staff_or_admin"
  ON public.organization_scenarios
  FOR SELECT
  USING (
    (is_staff_or_admin() AND organization_id = get_user_organization_id())
    OR is_license_admin()
  );

-- =============================================================================
-- NOTE: booking_notices は公開予約ページのお知らせ表示に使用されるため
-- 現在のポリシーを維持（匿名/customer アクセス許可）
-- =============================================================================
