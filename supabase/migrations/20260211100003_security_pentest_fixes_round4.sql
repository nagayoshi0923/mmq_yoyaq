-- =============================================================================
-- ペネトレーションテスト修正 Round 4 (2026-02-11)
-- =============================================================================
-- 攻撃者目線（customer ロール）で発見された重大な問題を修正：
--
-- 1. reservations: customer が他人の予約999件を閲覧可能 → 自分の分だけに
-- 2. staff: customer がスタッフ46人の名前・メール閲覧可能 → staff/admin のみに
-- 3. stores: 公開予約ページで必要（匿名アクセス許可 + staff/admin は全件）
-- 4. scenarios: 公開予約ページで必要（匿名は status='available' のみ）
-- 5. schedule_events: 公開予約ページで必要（匿名アクセス許可）
-- =============================================================================

-- =============================================================================
-- 1. reservations SELECT: customer は自分の予約だけ
-- =============================================================================

-- レガシーポリシー削除（同組織の全予約を見れるポリシー）
DROP POLICY IF EXISTS "reservations_select_strict" ON public.reservations;

-- reservations_select_self_or_admin は残す:
--   is_admin() AND org match → admin は全件
--   customer_id IN (customers WHERE user_id = auth.uid()) → 自分の分

-- staff 用に追加（staff も全件見れる必要あり）
CREATE POLICY "reservations_select_staff_org"
  ON public.reservations
  FOR SELECT
  USING (
    is_staff_or_admin() AND organization_id = get_user_organization_id()
  );

-- =============================================================================
-- 2. staff SELECT: customer には非公開
-- =============================================================================

-- レガシーポリシー削除（同組織の全ユーザーがスタッフを見れるポリシー）
DROP POLICY IF EXISTS "staff_select_org_scoped" ON public.staff;

-- staff/admin のみが組織のスタッフ一覧を閲覧可能
CREATE POLICY "staff_select_staff_or_admin_org"
  ON public.staff
  FOR SELECT
  USING (
    -- staff/admin: 同組織のスタッフを閲覧可能
    (is_staff_or_admin() AND organization_id = get_user_organization_id())
    -- 自分自身のスタッフレコード（プロフィール表示用）
    OR user_id = auth.uid()
  );

-- =============================================================================
-- 3. stores SELECT: 公開予約ページ + staff/admin
-- =============================================================================

-- 現在のポリシーを削除（auth.uid() IS NOT NULL が必要 → 匿名不可）
DROP POLICY IF EXISTS "stores_select_authenticated_org" ON public.stores;

-- 匿名（公開予約ページ）: 全ての stores を閲覧可能
-- ※ 公開予約ページは organization_id でフィルタする
-- ※ 予約に必要な情報（名前、住所、キャパシティ等）は公開情報
CREATE POLICY "stores_select_public_or_org"
  ON public.stores
  FOR SELECT
  USING (
    -- 公開予約ページ（匿名含む全ユーザー）: 閲覧可能
    -- フロントエンドで organization_id フィルタを行う
    true
  );

-- =============================================================================
-- 4. scenarios SELECT: 公開予約ページ + staff/admin
-- =============================================================================

-- 現在のポリシーを削除（auth.uid() IS NOT NULL が必要 → 匿名不可）
DROP POLICY IF EXISTS "scenarios_select_authenticated_org" ON public.scenarios;

-- 匿名: status='available' のシナリオのみ閲覧可能（公開予約ページ用）
-- staff/admin: 同組織の全シナリオを閲覧可能
CREATE POLICY "scenarios_select_public_or_org"
  ON public.scenarios
  FOR SELECT
  USING (
    CASE
      -- staff/admin: 同組織の全シナリオ + 共有シナリオ
      WHEN is_staff_or_admin() THEN
        organization_id = get_user_organization_id() OR is_shared = true
      -- 匿名/customer: 公開シナリオ (status='available') のみ
      ELSE
        status = 'available'
    END
  );

-- =============================================================================
-- 5. schedule_events SELECT: 公開予約ページ + staff/admin
-- =============================================================================

-- 現在のポリシーを削除（auth.uid() IS NOT NULL が必要 → 匿名不可）
DROP POLICY IF EXISTS "schedule_events_select_authenticated_org" ON public.schedule_events;

-- 匿名（公開予約ページ）: 閲覧可能
-- staff/admin: 同組織の全イベントを閲覧可能
CREATE POLICY "schedule_events_select_public_or_org"
  ON public.schedule_events
  FOR SELECT
  USING (
    -- 公開予約ページ（匿名含む全ユーザー）: 閲覧可能
    -- フロントエンドで organization_id, date, category 等のフィルタを行う
    true
  );

-- =============================================================================
-- NOTE: stores と schedule_events は USING (true) で全件 SELECT 可能にしています。
-- これは公開予約ページが匿名ユーザー向けに organization_id フィルタを行うためです。
-- 
-- RLS でさらに制限する場合は、以下のアプローチが考えられます：
-- 1. 公開予約ページ用の SECURITY DEFINER RPC 関数を作成
-- 2. RLS で is_published=true 等の条件を追加
-- 3. PostgREST の function-based routing を使用
--
-- 現時点では、店舗やイベント情報は公開情報として扱い、
-- 機密データ（予約、顧客、スタッフ）の保護を優先しています。
-- =============================================================================
