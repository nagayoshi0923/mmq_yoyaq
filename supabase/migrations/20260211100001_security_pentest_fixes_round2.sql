-- =============================================================================
-- ペネトレーションテスト修正 Round 2 (2026-02-11)
-- =============================================================================
-- 前回の修正で残ったレガシーポリシーを削除
-- =============================================================================

-- =============================================================================
-- 1. scenarios: レガシー "scenarios_strict" ポリシーを削除
--    このポリシーは FOR 指定なし（= ALL操作）で PERMISSIVE なため、
--    新しい restrictive なポリシーを OR で上書きしてしまう。
--    匿名アクセス（status = 'available'）と customer の UPDATE を許可していた。
-- =============================================================================

DROP POLICY IF EXISTS "scenarios_strict" ON public.scenarios;

-- =============================================================================
-- 2. authors: SELECT ポリシーを認証済みユーザーのみに制限
--    "authors_select_all" は USING (true) で匿名含む全員に公開していた。
--    authors は共有マスタデータだが、認証は必要。
-- =============================================================================

DROP POLICY IF EXISTS "authors_select_all" ON public.authors;

CREATE POLICY "authors_select_authenticated"
  ON public.authors
  FOR SELECT
  USING (auth.uid() IS NOT NULL);

-- =============================================================================
-- 3. organizations: 匿名 SELECT ポリシーを認証済みユーザーのみに制限
--    ログイン済みユーザーは自分の組織情報を見る必要がある。
--    匿名ユーザーは組織情報を見る必要がない。
-- =============================================================================

DROP POLICY IF EXISTS "Allow anon read active organizations" ON public.organizations;
DROP POLICY IF EXISTS "organizations_public_read_active" ON public.organizations;
DROP POLICY IF EXISTS "organizations_select_active_public" ON public.organizations;

CREATE POLICY "organizations_select_authenticated"
  ON public.organizations
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND (
      -- 自分が所属する組織
      id = get_user_organization_id()
      -- または admin
      OR is_admin()
    )
  );
