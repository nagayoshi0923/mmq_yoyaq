-- =============================================================================
-- ペネトレーションテストで検出された脆弱性の修正 (2026-02-11)
-- =============================================================================
-- 検出された問題:
--   A-3: customer が reservations の価格フィールドを直接 UPDATE できる
--   I-1: customer が scenarios.participation_fee を直接 UPDATE できる
--   G-anon: 匿名ユーザーが stores, scenarios, schedule_events にアクセスできる
-- =============================================================================

-- =============================================================================
-- 1. reservations: UPDATE ポリシーを修正
--    customer による直接 UPDATE を禁止（RPC 関数経由のみ許可）
-- =============================================================================

-- 既存の UPDATE ポリシーをすべて削除
DROP POLICY IF EXISTS "reservations_update_unified" ON public.reservations;
DROP POLICY IF EXISTS "reservations_update_strict" ON public.reservations;
DROP POLICY IF EXISTS "reservations_update_own_org" ON public.reservations;
DROP POLICY IF EXISTS "reservations_update_admin" ON public.reservations;
DROP POLICY IF EXISTS "reservations_update_policy" ON public.reservations;

-- 新しい UPDATE ポリシー: admin/staff のみ、自分の組織のデータのみ
-- customer は RPC (cancel_reservation_with_lock, update_reservation_participants) 経由で操作
CREATE POLICY "reservations_update_staff_or_admin"
  ON public.reservations
  FOR UPDATE
  USING (
    is_staff_or_admin()
    AND organization_id = get_user_organization_id()
  )
  WITH CHECK (
    is_staff_or_admin()
    AND organization_id = get_user_organization_id()
  );

-- =============================================================================
-- 2. scenarios: UPDATE ポリシーを修正
--    admin のみ + 組織チェック必須
-- =============================================================================

-- 既存の UPDATE ポリシーをすべて削除
DROP POLICY IF EXISTS "scenarios_update_admin" ON public.scenarios;
DROP POLICY IF EXISTS "scenarios_update_own_org" ON public.scenarios;
DROP POLICY IF EXISTS "scenarios_update_policy" ON public.scenarios;

-- 新しい UPDATE ポリシー: admin のみ + 組織チェック
CREATE POLICY "scenarios_update_admin_org_scoped"
  ON public.scenarios
  FOR UPDATE
  USING (
    is_admin()
    AND organization_id = get_user_organization_id()
  )
  WITH CHECK (
    is_admin()
    AND organization_id = get_user_organization_id()
  );

-- scenarios DELETE も同様に修正
DROP POLICY IF EXISTS "scenarios_delete_admin" ON public.scenarios;
DROP POLICY IF EXISTS "scenarios_delete_policy" ON public.scenarios;

CREATE POLICY "scenarios_delete_admin_org_scoped"
  ON public.scenarios
  FOR DELETE
  USING (
    is_admin()
    AND organization_id = get_user_organization_id()
  );

-- =============================================================================
-- 3. stores: SELECT ポリシーを修正
--    匿名アクセス禁止 → 認証済みユーザー + 組織チェック
-- =============================================================================

DROP POLICY IF EXISTS "stores_select_policy" ON public.stores;
DROP POLICY IF EXISTS "stores_select_org_or_anon" ON public.stores;
DROP POLICY IF EXISTS "stores_public_read" ON public.stores;
DROP POLICY IF EXISTS "Allow anon read active stores" ON public.stores;
DROP POLICY IF EXISTS "stores_select_strict" ON public.stores;

CREATE POLICY "stores_select_authenticated_org"
  ON public.stores
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND organization_id = get_user_organization_id()
  );

-- =============================================================================
-- 4. scenarios: SELECT ポリシーを修正
--    匿名アクセス禁止 → 認証済みユーザー + 組織チェック
-- =============================================================================

DROP POLICY IF EXISTS "scenarios_select_org_or_anon" ON public.scenarios;
DROP POLICY IF EXISTS "scenarios_select_all" ON public.scenarios;
DROP POLICY IF EXISTS "scenarios_select_policy" ON public.scenarios;

DO $$
BEGIN
  IF EXISTS (SELECT 1 FROM information_schema.columns
             WHERE table_schema='public' AND table_name='scenarios' AND column_name='is_shared') THEN
    CREATE POLICY "scenarios_select_authenticated_org"
      ON public.scenarios
      FOR SELECT
      USING (
        auth.uid() IS NOT NULL
        AND (
          organization_id = get_user_organization_id()
          OR is_shared = true
        )
      );
  ELSE
    CREATE POLICY "scenarios_select_authenticated_org"
      ON public.scenarios
      FOR SELECT
      USING (
        auth.uid() IS NOT NULL
        AND organization_id = get_user_organization_id()
      );
  END IF;
END $$;

-- =============================================================================
-- 5. schedule_events: SELECT ポリシーを修正
--    匿名アクセス禁止 → 認証済みユーザー + 組織チェック
-- =============================================================================

DROP POLICY IF EXISTS "schedule_events_select_unified" ON public.schedule_events;
DROP POLICY IF EXISTS "schedule_events_select_all" ON public.schedule_events;
DROP POLICY IF EXISTS "schedule_events_select_org_or_anon" ON public.schedule_events;
DROP POLICY IF EXISTS "schedule_events_select_strict" ON public.schedule_events;

CREATE POLICY "schedule_events_select_authenticated_org"
  ON public.schedule_events
  FOR SELECT
  USING (
    auth.uid() IS NOT NULL
    AND organization_id = get_user_organization_id()
  );
