# 認証認可 - 問題ケースと解決TODO

## 概要

このドキュメントでは、MMQシステムの認証認可に関する既知の問題ケースと改善案をまとめています。

---

## 🔴 重大な問題（HIGH）

### 1. staffテーブル紐付けなしのstaffロール
**状態**: 未解決  
**症状**: `users.role = 'staff'` だが、`staff` テーブルに該当レコードがない  
**影響**: 
- スタッフ管理画面に表示されない
- シフト提出などスタッフ機能が使えない可能性
- 「幽霊スタッフ」状態

**対象アカウント（2025-12-04時点）**:
```
# 削除済み
test+staff1761729272442@gmail.com  → 削除
mmqyoyaq@gmail.com                 → 削除
queenswaltz.office@gmail.com       → 削除

# 保留中（様子見）
d0b21008fa@edu.teu.ac.jp
mizumasa10022214@gmail.com
ancr0qw.3107@gmail.com
```

**解決案**:
- [x] テスト/運営用アカウントを削除（3件完了）
- [ ] 保留中3件の確認・対応
- [ ] 定期的なデータ整合性チェックの導入

---

### 2. 招待メールの有効期限切れ
**状態**: 部分的に解決  
**症状**: 招待メールのリンクが24時間（Supabaseデフォルト）で切れる  
**影響**: 
- スタッフがパスワード設定できない
- 再招待が必要

**現在の対応**: 
- 有効期限を延長済み（要確認）
- 管理者が手動でパスワード設定可能

**解決案**:
- [ ] 招待リンクの有効期限を7日間に延長
- [ ] 期限切れ時の自動再送機能
- [ ] スタッフ管理画面から「再招待」ボタン追加

---

### 3. メール確認前のセッション問題
**状態**: 未解決  
**症状**: メール確認完了前にセッションが作成され、その後の状態が不安定  
**影響**: 
- ロールが `customer` に戻る
- ログイン状態が不安定

**解決案**:
- [ ] メール確認完了後にのみセッション確立
- [ ] 確認前アクセス時の適切なエラーメッセージ

---

## 🟠 中程度の問題（MEDIUM）

### 4. セッションタイムアウト時のロール取得失敗
**状態**: 修正済み（要テスト）  
**症状**: `users` テーブルからのロール取得がタイムアウトすると、デフォルト `customer` になる  
**影響**: スタッフが一時的に顧客扱いになる

**修正内容**: 
- `AuthContext.tsx` でタイムアウト時に既存ロールを維持
- `staff` テーブルチェックを追加

**解決案**:
- [ ] 修正後のテスト実施
- [ ] タイムアウト時のフォールバック動作の検証

---

### 5. 複数タブ/ブラウザでのセッション競合
**状態**: 未調査  
**症状**: 複数タブでログイン/ログアウトすると状態が不整合になる可能性  
**影響**: 予期しないログアウト、ロール変更

**解決案**:
- [ ] セッション同期の実装検討
- [ ] ログアウト時の全タブ通知

---

### 6. パスワードリセット時のロール維持
**状態**: 未調査  
**症状**: パスワードリセット後にロールが変わる可能性  
**影響**: スタッフが顧客になる

**解決案**:
- [ ] パスワードリセットフローの検証
- [ ] リセット後のロール確認ロジック追加

---

### 7. Edge Function (invite-staff) のエラーハンドリング
**状態**: 未調査  
**症状**: 招待処理中のエラーで中途半端な状態になる  
**影響**: 
- `staff` テーブルに `user_id` が設定されない
- `users` テーブルにレコードがない

**解決案**:
- [ ] トランザクション処理の導入
- [ ] ロールバック機能
- [ ] エラー時のクリーンアップ

---

## 🟡 軽度の問題（LOW）

### 8. determineUserRole関数の精度
**状態**: 要改善  
**症状**: メールアドレスのパターンマッチでロール判定している  
**影響**: 特定ドメインのユーザーが誤ったロールになる可能性

**現在のロジック**:
```typescript
// 現在: メールパターンで判定（不正確）
if (email.includes('@mmq.co.jp')) return 'staff'
```

**解決案**:
- [ ] `staff` テーブルの存在チェックを優先
- [ ] メールパターンマッチは最終フォールバックのみ

---

### 9. ユーザー管理画面のUX
**状態**: 修正済み  
**症状**: ロール変更の確認ダイアログがなく、誤操作の可能性  
**影響**: 意図しないロール変更

**修正内容**: 
- 確認ダイアログを追加

---

### 10. 認証状態の可視化不足
**状態**: 未実装  
**症状**: 管理者がユーザーの認証状態を把握しにくい  
**影響**: 問題発生時の原因特定が困難

**解決案**:
- [ ] 管理者向け認証ダッシュボード
- [ ] 認証関連ログの可視化
- [ ] 問題検出アラート

---

## 🔵 改善提案

### 11. データ整合性の自動チェック
**提案**: 
- 定期的に `users` と `staff` テーブルの整合性をチェック
- 不整合を検出したら管理者に通知

### 12. 認証イベントのログ記録
**提案**:
- ログイン/ログアウト/ロール変更をログテーブルに記録
- 問題発生時のトレーサビリティ確保

### 13. スタッフ招待フローの改善
**提案**:
- 招待状態の可視化（pending/confirmed/expired）
- ワンクリック再招待
- 招待期限のリマインダー

---

## 進捗トラッキング

| # | 問題 | 重要度 | 状態 | 担当 |
|---|------|--------|------|------|
| 1 | staffテーブル紐付けなし | HIGH | 未解決 | - |
| 2 | 招待メール有効期限 | HIGH | 部分解決 | - |
| 3 | メール確認前セッション | HIGH | 未解決 | - |
| 4 | タイムアウト時ロール | MEDIUM | 修正済み | - |
| 5 | 複数タブ競合 | MEDIUM | 未調査 | - |
| 6 | パスワードリセット | MEDIUM | 未調査 | - |
| 7 | Edge Functionエラー | MEDIUM | 未調査 | - |
| 8 | determineUserRole | LOW | 要改善 | - |
| 9 | ロール変更UX | LOW | 修正済み | - |
| 10 | 認証可視化 | LOW | 未実装 | - |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-04 | 初版作成 |

