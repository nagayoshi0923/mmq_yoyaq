# 貸切リクエストの時間枠可用性判定ロジック

## 概要

貸切リクエストの時間枠が受付可能かどうかを判定するロジック。スケジュール管理画面で表示されているイベントのみを基準に判定する。

## 判定の基本方針

**スケジュール管理画面で空白になっているセルには公演がない**という前提で、スケジュール管理画面と同じロジックでイベントをフィルタリングし、その時間枠にイベントが存在するかどうかをチェックする。

## 判定フロー

### 1. 対象店舗の決定

- **オフィス（`ownership_type='office'`）は除外**
- シナリオに`available_stores`が設定されている場合、その店舗のみを対象
- 設定されていない場合、オフィス以外の全店舗を対象

### 2. イベントのフィルタリング

スケジュール管理画面と同じロジックで、以下の条件を**すべて満たす**イベントのみをチェック対象とする：

1. **日付が一致**：イベントの日付とチェック対象の日付が一致
2. **店舗が一致**：イベントの店舗IDとチェック対象の店舗IDが一致
3. **時間帯が一致**：イベントの開始時刻から判定した時間帯（morning/afternoon/evening）と、チェック対象の時間枠（朝/昼/夜）が一致

**時間帯の判定方法：**
- `start_time`が0-11時 → `morning`（朝）
- `start_time`が12-17時 → `afternoon`（昼）
- `start_time`が18時以降 → `evening`（夜）

### 3. 営業時間・休日・時間制限のチェック

`business_hours_settings`テーブルから設定を取得し、以下をチェック：

1. **休日チェック**：指定日が休日に設定されている場合は受付不可
2. **営業時間チェック**：指定日の曜日の営業時間外の場合は受付不可
3. **時間制限チェック**：`time_restrictions`に該当する時間帯の場合は受付不可

### 4. 時間枠の衝突チェック

フィルタリングされたイベントが**1件でも存在する場合**、その時間枠は受付不可。

**重要な原則：**
- **同じセル（日付・店舗・時間帯）に2個以上のイベントは発生させない**
- したがって、1件でもあれば衝突と判定

### 5. 最終判定

#### 店舗が選択されている場合

選択された店舗の**いずれかで空きがあれば**受付可能（`true`）。

#### 店舗が選択されていない場合

対象店舗の**いずれかで空きがあれば**受付可能（`true`）。

## データソース

- **`schedule_events`テーブル**：全店舗のイベントデータ（現在の月から3ヶ月先まで）
- **`business_hours_settings`テーブル**：営業時間・休日・時間制限の設定
- **`stores`テーブル**：店舗情報（`ownership_type`でオフィスを除外）

## 注意事項

1. **スケジュール管理画面との同期**：スケジュール管理画面で表示されないイベントは、この判定でも無視される
2. **カテゴリの制限なし**：通常公演（`open`）、貸切公演（`private`）、その他のカテゴリ（`gmtest`、`testplay`など）すべてをチェック対象とする
3. **キャンセルされたイベントは除外**：`is_cancelled=true`のイベントはチェック対象外

