# é€šçŸ¥æ©Ÿèƒ½ è©³ç´°

**æœ€çµ‚æ›´æ–°**: 2025-12-30

Discordé€šçŸ¥ã¨ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã®2ç³»çµ±ã§å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–¢ä¿‚è€…ã«é€šçŸ¥ã™ã‚‹æ©Ÿèƒ½ã€‚

---

## 1. æ¦‚è¦

### é€šçŸ¥ãƒãƒ£ãƒãƒ«

| ãƒãƒ£ãƒãƒ« | ç”¨é€” | æŠ€è¡“ |
|---------|------|------|
| **Discord** | ã‚¹ã‚¿ãƒƒãƒ•ãƒ»GMã¸ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ | Discord Bot API |
| **ãƒ¡ãƒ¼ãƒ«** | é¡§å®¢ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®å…¬å¼é€šçŸ¥ | Resend API |

### é€šçŸ¥ã®ç¨®é¡

| ç¨®é¡ | Discord | ãƒ¡ãƒ¼ãƒ« | å¯¾è±¡ |
|------|---------|--------|------|
| è²¸åˆ‡äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ | âœ… | âœ… | GMãƒ»ç®¡ç†è€… |
| è²¸åˆ‡äºˆç´„ç¢ºå®š | - | âœ… | é¡§å®¢ |
| è²¸åˆ‡äºˆç´„å´ä¸‹ | - | âœ… | é¡§å®¢ |
| äºˆç´„ç¢ºèª | - | âœ… | é¡§å®¢ |
| äºˆç´„å¤‰æ›´ç¢ºèª | - | âœ… | é¡§å®¢ |
| äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèª | - | âœ… | é¡§å®¢ |
| å…¬æ¼”ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ | - | âœ… | é¡§å®¢ |
| ã‚·ãƒ•ãƒˆæå‡ºä¾é ¼ | âœ… | - | ã‚¹ã‚¿ãƒƒãƒ• |
| ã‚·ãƒ•ãƒˆæå‡ºå®Œäº† | âœ… | - | ç®¡ç†è€… |
| ã‚·ãƒ•ãƒˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ | âœ… | - | ã‚¹ã‚¿ãƒƒãƒ• |

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰                                                      â”‚
â”‚      â”‚                                                               â”‚
â”‚      â”‚ 1. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆäºˆç´„ç¢ºå®šã€ã‚·ãƒ•ãƒˆæå‡ºãªã©ï¼‰                 â”‚
â”‚      â”‚                                                               â”‚
â”‚      â–¼                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Supabase Edge Functions                                       â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚  â”‚ notify-xxx-discord          â”‚  â”‚ send-xxx-confirmation   â”‚â”‚   â”‚
â”‚  â”‚  â”‚                             â”‚  â”‚                         â”‚â”‚   â”‚
â”‚  â”‚  â”‚ Discord Bot API             â”‚  â”‚ Resend API              â”‚â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â”‚                 â”‚                               â”‚             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                    â”‚                               â”‚                 â”‚
â”‚                    â–¼                               â–¼                 â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚           â”‚  Discord    â”‚                 â”‚   ãƒ¡ãƒ¼ãƒ«    â”‚           â”‚
â”‚           â”‚ ãƒãƒ£ãƒ³ãƒãƒ«   â”‚                 â”‚   å—ä¿¡ç®±    â”‚           â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Discordé€šçŸ¥

### 3.1 Edge Functionsä¸€è¦§

| é–¢æ•°å | ãƒˆãƒªã‚¬ãƒ¼ | é€šçŸ¥å…ˆ |
|--------|---------|--------|
| `notify-private-booking-discord` | è²¸åˆ‡äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡ | æ‹…å½“GM |
| `notify-shift-request-discord` | ã‚·ãƒ•ãƒˆæå‡ºä¾é ¼ä½œæˆ | å¯¾è±¡ã‚¹ã‚¿ãƒƒãƒ• |
| `notify-shift-submitted-discord` | ã‚·ãƒ•ãƒˆæå‡ºå®Œäº† | ç®¡ç†è€… |
| `notify-shift-reminder-discord` | ã‚·ãƒ•ãƒˆç· åˆ‡å‰ | æœªæå‡ºã‚¹ã‚¿ãƒƒãƒ• |
| `discord-interactions` | ãƒœã‚¿ãƒ³æŠ¼ä¸‹ | å‡¦ç†å®Ÿè¡Œ |

### 3.2 ãƒœã‚¿ãƒ³ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

è²¸åˆ‡äºˆç´„é€šçŸ¥ã«ã¯ã€Œå¯¾å¿œå¯èƒ½ã€ã€Œå¯¾å¿œä¸å¯ã€ã®ãƒœã‚¿ãƒ³ãŒã‚ã‚Šã€æŠ¼ä¸‹æ™‚ã« `discord-interactions` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚

```
Discordé€šçŸ¥
    â”‚
    â”œâ”€â”€ [å¯¾å¿œå¯èƒ½] ãƒœã‚¿ãƒ³
    â”‚       â”‚
    â”‚       â–¼
    â”‚   discord-interactions
    â”‚       â”‚
    â”‚       â–¼
    â”‚   GMç¢ºèªç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLè¿”å´
    â”‚
    â””â”€â”€ [å¯¾å¿œä¸å¯] ãƒœã‚¿ãƒ³
            â”‚
            â–¼
        discord-interactions
            â”‚
            â–¼
        ä¸å¯ç†ç”±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
```

### 3.3 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—è¦ä»¶

1. **Discord Botä½œæˆ**: Discord Developer Portalã§ä½œæˆ
2. **ç’°å¢ƒå¤‰æ•°è¨­å®š**:
   - `DISCORD_BOT_TOKEN`: Botãƒˆãƒ¼ã‚¯ãƒ³
   - `DISCORD_APPLICATION_ID`: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ID
3. **ã‚¹ã‚¿ãƒƒãƒ•è¨­å®š**: `staff.discord_channel_id` ã«é€šçŸ¥å…ˆãƒãƒ£ãƒ³ãƒãƒ«ID
4. **Webhookè¨­å®š**: Edge Functionã®URLã‚’Discord Botã«è¨­å®š

è©³ç´°ã¯ [discord/DISCORD_BOT_SETUP.md](../../setup/discord/) å‚ç…§ã€‚

### 3.4 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼

```json
{
  "content": null,
  "embeds": [{
    "title": "ğŸ“… è²¸åˆ‡äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ",
    "color": 5814783,
    "fields": [
      { "name": "ã‚·ãƒŠãƒªã‚ª", "value": "ã€‡ã€‡ã€‡ã€‡", "inline": true },
      { "name": "ãŠå®¢æ§˜", "value": "å±±ç”° å¤ªéƒ æ§˜", "inline": true },
      { "name": "å‚åŠ äººæ•°", "value": "6å", "inline": true },
      { "name": "å¸Œæœ›æ—¥æ™‚", "value": "å€™è£œ1: 01/15 18:00-21:00\nå€™è£œ2: 01/16 14:00-17:00" }
    ]
  }],
  "components": [{
    "type": 1,
    "components": [
      { "type": 2, "style": 3, "label": "å¯¾å¿œå¯èƒ½", "custom_id": "available_xxx" },
      { "type": 2, "style": 4, "label": "å¯¾å¿œä¸å¯", "custom_id": "unavailable_xxx" }
    ]
  }]
}
```

---

## 4. ãƒ¡ãƒ¼ãƒ«é€šçŸ¥

### 4.1 Edge Functionsä¸€è¦§

| é–¢æ•°å | ãƒˆãƒªã‚¬ãƒ¼ | é€ä¿¡å…ˆ |
|--------|---------|--------|
| `send-booking-confirmation` | äºˆç´„ç¢ºå®š | é¡§å®¢ |
| `send-booking-change-confirmation` | äºˆç´„å¤‰æ›´ | é¡§å®¢ |
| `send-cancellation-confirmation` | äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ« | é¡§å®¢ |
| `send-private-booking-request-confirmation` | è²¸åˆ‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ | é¡§å®¢ |
| `send-private-booking-confirmation` | è²¸åˆ‡æ‰¿èª | é¡§å®¢ |
| `send-private-booking-rejection` | è²¸åˆ‡å´ä¸‹ | é¡§å®¢ |
| `send-reminder-emails` | å…¬æ¼”å‰æ—¥ | é¡§å®¢ |
| `send-author-report` | ä½œå®¶ãƒ¬ãƒãƒ¼ãƒˆ | ä½œå®¶ |

### 4.2 Resend API

ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«ã¯ Resend API ã‚’ä½¿ç”¨ã€‚

**ç’°å¢ƒå¤‰æ•°**:
- `RESEND_API_KEY`: Resendã®APIã‚­ãƒ¼

**é€ä¿¡å…ƒãƒ‰ãƒ¡ã‚¤ãƒ³**:
- ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’Resendã«ç™»éŒ²å¿…è¦

è©³ç´°ã¯ [email/RESEND_QUICK_SETUP.md](../../setup/email/) å‚ç…§ã€‚

### 4.3 ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

å„Edge Functionå†…ã«HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚

```typescript
const htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <style>
    .container { max-width: 600px; margin: 0 auto; }
    .header { background: #4A5568; color: white; padding: 20px; }
    .content { padding: 20px; }
    .footer { background: #EDF2F7; padding: 10px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ã”äºˆç´„ç¢ºèª</h1>
    </div>
    <div class="content">
      <p>${customerName} æ§˜</p>
      <p>ã“ã®åº¦ã¯ã”äºˆç´„ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚</p>
      ...
    </div>
    <div class="footer">
      <p>ã€’xxx-xxxx ...</p>
    </div>
  </div>
</body>
</html>
`
```

### 4.4 ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¼ãƒ«ã®Cronè¨­å®š

`send-reminder-emails` ã¯å®šæœŸå®Ÿè¡Œã•ã‚Œã‚‹ã€‚

```sql
-- Supabase pg_cronè¨­å®š
SELECT cron.schedule(
  'send-reminder-emails',
  '0 9 * * *',  -- æ¯æ—¥9:00 UTC
  $$
  SELECT net.http_post(
    url := 'https://xxx.supabase.co/functions/v1/send-reminder-emails',
    headers := '{"Authorization": "Bearer xxx"}'::jsonb,
    body := '{}'::jsonb
  )
  $$
);
```

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¾å­˜

### Discordé€šçŸ¥ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿

| ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚«ãƒ©ãƒ  | ç”¨é€” |
|---------|-------|------|
| `staff` | `discord_channel_id` | é€šçŸ¥å…ˆãƒãƒ£ãƒ³ãƒãƒ« |
| `staff_scenario_assignments` | `staff_id`, `scenario_id` | æ‹…å½“ã‚·ãƒŠãƒªã‚ªåˆ¤å®š |
| `reservations` | å„ã‚«ãƒ©ãƒ  | é€šçŸ¥å†…å®¹ |

### ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿

| ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚«ãƒ©ãƒ  | ç”¨é€” |
|---------|-------|------|
| `customers` | `email`, `name` | é€ä¿¡å…ˆãƒ»å®›å |
| `reservations` | å„ã‚«ãƒ©ãƒ  | é€šçŸ¥å†…å®¹ |
| `schedule_events` | å„ã‚«ãƒ©ãƒ  | ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ç”¨ |

---

## 6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Discordé€šçŸ¥ãŒå±Šã‹ãªã„

1. **discord_channel_idç¢ºèª**: `staff` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒãƒ£ãƒ³ãƒãƒ«IDãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
2. **Botæ¨©é™ç¢ºèª**: BotãŒãã®ãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã§ãã‚‹ã‹
3. **æ‹…å½“ç¢ºèª**: `staff_scenario_assignments` ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹
4. **Edge Functionãƒ­ã‚°**: Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ­ã‚°ç¢ºèª

### ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„

1. **Resend API Keyç¢ºèª**: ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ã„ã‹
2. **ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ç¢ºèª**: Resendã§ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹
3. **è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ç¢ºèª**: å—ä¿¡è€…ã®è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ç¢ºèª
4. **Edge Functionãƒ­ã‚°**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª

### ãƒœã‚¿ãƒ³ãŒåå¿œã—ãªã„

1. **Webhook URLç¢ºèª**: Discord Botã®è¨­å®šã§Interaction URLãŒæ­£ã—ã„ã‹
2. **Edge Functionèµ·å‹•ç¢ºèª**: Cold startã§é…å»¶ã—ã¦ã„ã‚‹å¯èƒ½æ€§
3. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç¢ºèª**: Discordã¯3ç§’ä»¥å†…ã®å¿œç­”ãŒå¿…è¦

---

## 7. é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### Edge Functions

```
supabase/functions/
â”œâ”€â”€ notify-private-booking-discord/   # è²¸åˆ‡äºˆç´„Discordé€šçŸ¥
â”œâ”€â”€ notify-shift-request-discord/     # ã‚·ãƒ•ãƒˆä¾é ¼Discordé€šçŸ¥
â”œâ”€â”€ notify-shift-submitted-discord/   # ã‚·ãƒ•ãƒˆæå‡ºå®Œäº†Discordé€šçŸ¥
â”œâ”€â”€ notify-shift-reminder-discord/    # ã‚·ãƒ•ãƒˆãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼Discordé€šçŸ¥
â”œâ”€â”€ discord-interactions/             # Discordãƒœã‚¿ãƒ³å‡¦ç†
â”œâ”€â”€ send-booking-confirmation/        # äºˆç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«
â”œâ”€â”€ send-booking-change-confirmation/ # äºˆç´„å¤‰æ›´ãƒ¡ãƒ¼ãƒ«
â”œâ”€â”€ send-cancellation-confirmation/   # ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ¡ãƒ¼ãƒ«
â”œâ”€â”€ send-private-booking-confirmation/# è²¸åˆ‡ç¢ºå®šãƒ¡ãƒ¼ãƒ«
â”œâ”€â”€ send-private-booking-rejection/   # è²¸åˆ‡å´ä¸‹ãƒ¡ãƒ¼ãƒ«
â”œâ”€â”€ send-reminder-emails/             # ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ãƒ¼ãƒ«
â””â”€â”€ send-author-report/               # ä½œå®¶ãƒ¬ãƒãƒ¼ãƒˆãƒ¡ãƒ¼ãƒ«
```

---

## 8. é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [discord/](../../setup/discord/) - Discordã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [email/](../../setup/email/) - ãƒ¡ãƒ¼ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [features/README.md](../README.md) - æ©Ÿèƒ½æ¦‚è¦ä¸€è¦§


