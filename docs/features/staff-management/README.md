# スタッフ管理機能 詳細

**最終更新**: 2025-12-30

GM・スタッフの情報を管理し、シナリオ担当やシフトと連携する機能。

---

## 1. 概要

### この機能が解決する課題

- スタッフ情報を一元管理したい
- 担当シナリオを管理したい
- 新規スタッフを招待してアカウント発行したい
- ログインアカウントと紐付けたい

### 主な機能

| 機能 | 説明 |
|------|------|
| スタッフ一覧 | 全スタッフの表示・検索・フィルター |
| スタッフ登録 | 新規スタッフ追加 |
| スタッフ編集 | 情報更新 |
| スタッフ招待 | メールでログインアカウント発行 |
| 担当シナリオ管理 | どのシナリオを担当できるか設定 |
| シナリオ習熟度管理 | 各シナリオの習熟レベル設定 |

---

## 2. 画面構成

### 2.1 スタッフ一覧

```
┌─────────────────────────────────────────────────────────────────────┐
│ スタッフ管理                                                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  [検索...]   役割: [▼ すべて]   店舗: [▼ すべて]  [+ 新規スタッフ]  │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 名前         役割           所属店舗         状態   操作    │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ 山田 太郎    [GM]          高田馬場店        稼働中  [編集] │   │
│  │ 佐藤 花子    [GM][管理者]  別館①,神楽坂     稼働中  [編集] │   │
│  │ 鈴木 一郎    [スタッフ]    中野店           休職中  [編集] │   │
│  │ ...                                                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 スタッフ編集ダイアログ

```
┌─────────────────────────────────────────────────────────────────────┐
│ スタッフ編集                                                 [×]    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  【基本情報】                                                        │
│  名前*: [山田 太郎_______]                                          │
│  表示名: [やまだ__________]                                         │
│  メール: [yamada@example.com]                                       │
│  電話: [090-xxxx-xxxx___]                                           │
│                                                                      │
│  【役割・所属】                                                      │
│  役割: [✓] GM [✓] 管理者 [ ] スタッフ [ ] 作家                     │
│  所属店舗: [✓] 高田馬場 [✓] 別館① [ ] 別館② [ ] 神楽坂           │
│                                                                      │
│  【SNS・連絡先】                                                     │
│  LINE名: [_________________]                                         │
│  X(Twitter): [_________________]                                     │
│  Discord ID: [_________________]                                     │
│  Discord通知チャンネルID: [_________________]                        │
│                                                                      │
│  【状態】                                                            │
│  ステータス: (●) 稼働中 ( ) 休職中 ( ) 退職                         │
│                                                                      │
│  [キャンセル]                              [保存]                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. データ構造

### 3.1 staff テーブル

```typescript
interface Staff {
  id: string
  organization_id: string           // マルチテナント識別
  
  // 基本情報
  name: string                      // 氏名
  display_name?: string             // 表示名
  email?: string
  phone?: string
  
  // SNS・連絡先
  line_name?: string
  x_account?: string
  discord_id?: string
  discord_channel_id?: string       // Discord通知先チャンネル
  
  // 役割・所属
  role: string[]                    // ['gm', 'admin', 'staff', 'author']
  stores: string[]                  // 所属店舗ID配列
  
  // シナリオ関連
  available_scenarios: string[]     // 担当可能シナリオID
  experienced_scenarios?: string[]  // 経験済みシナリオID
  special_scenarios: string[]       // 得意シナリオID
  want_to_learn: string[]           // 習得希望シナリオID
  
  // 出勤関連
  ng_days: string[]                 // 出勤不可曜日
  availability: string[]            // 出勤可能曜日
  
  // ステータス
  status: 'active' | 'inactive' | 'on-leave'
  experience: number                // 経験年数
  
  // アバター
  avatar_url?: string
  avatar_color?: string
  
  // ログインアカウント連携
  user_id?: string                  // auth.users.id
  
  notes?: string
  
  created_at: string
  updated_at: string
}
```

### 3.2 staff_scenario_assignments テーブル

スタッフとシナリオの担当関係を管理。

```typescript
interface StaffScenarioAssignment {
  id: string
  staff_id: string
  scenario_id: string
  proficiency_level: 'beginner' | 'intermediate' | 'advanced' | 'expert'
  notes?: string
  created_at: string
  updated_at: string
}
```

### 3.3 役割（role）の種類

| 役割 | 説明 |
|------|------|
| `admin` | 管理者 - 全機能にアクセス可能 |
| `gm` | GM - 公演のゲームマスターを担当 |
| `staff` | スタッフ - 一般業務担当 |
| `author` | 作家 - シナリオ作成者 |

---

## 4. スタッフ招待機能

### 4.1 フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│                        スタッフ招待フロー                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  【管理者】                                                          │
│    │                                                                 │
│    ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 1. スタッフ招待ダイアログを開く                          │        │
│  │    - 名前入力                                            │        │
│  │    - メールアドレス入力                                  │        │
│  │    - 役割選択                                            │        │
│  └──────────────────────────┬──────────────────────────────┘        │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 2. organization_invitations テーブルに登録               │        │
│  │    - トークン生成                                        │        │
│  │    - 有効期限設定（7日間）                               │        │
│  └──────────────────────────┬──────────────────────────────┘        │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 3. 招待メール送信                                        │        │
│  │    Edge Function: invite-staff                           │        │
│  │    → 招待リンク付きメール                                │        │
│  └──────────────────────────┬──────────────────────────────┘        │
│                             │                                        │
│  【招待されたスタッフ】     ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 4. メールのリンクをクリック                              │        │
│  │    → AcceptInvitationページへ                            │        │
│  └──────────────────────────┬──────────────────────────────┘        │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 5. パスワード設定                                        │        │
│  │    → auth.usersにアカウント作成                          │        │
│  │    → staff.user_id に紐付け                              │        │
│  │    → invitation.accepted_at 更新                         │        │
│  └─────────────────────────────────────────────────────────┘        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 organization_invitations テーブル

```typescript
interface OrganizationInvitation {
  id: string
  organization_id: string
  email: string
  name: string
  role: string[]                    // 付与する役割
  token: string                     // 招待トークン
  expires_at: string                // 有効期限
  accepted_at?: string              // 承認日時
  staff_id?: string                 // 作成されたstaff.id
  created_by?: string               // 招待者のuser_id
  created_at: string
  updated_at: string
}
```

---

## 5. 関連ファイル

### ページ

| ファイル | 役割 |
|---------|------|
| `src/pages/StaffManagement/index.tsx` | スタッフ一覧・管理 |
| `src/pages/StaffProfile/index.tsx` | スタッフプロフィール |
| `src/pages/AcceptInvitation/index.tsx` | 招待承認ページ |

### コンポーネント

| ファイル | 役割 |
|---------|------|
| `components/StaffEditDialog.tsx` | 編集ダイアログ |
| `components/StaffInviteDialog.tsx` | 招待ダイアログ |
| `components/StaffRow.tsx` | 一覧行表示 |

### フック

| ファイル | 役割 |
|---------|------|
| `hooks/useStaffData.ts` | スタッフデータ取得 |
| `hooks/useStaffFilter.ts` | フィルター管理 |
| `hooks/useStaffMutations.ts` | 作成・更新・削除 |
| `hooks/useStaffInvitation.ts` | 招待処理 |

### Edge Functions

| 関数 | 役割 |
|------|------|
| `invite-staff` | 招待メール送信 |

---

## 6. 注意点

### 6.1 user_id の紐付け

- `staff.user_id` は招待承認時に設定される
- 既存スタッフに後からアカウントを発行する場合は招待機能を使用
- 手動で `user_id` を設定しないこと

### 6.2 discord_channel_id

- Discord通知を受け取るには設定必須
- チャンネルIDはDiscordのデベロッパーモードで取得
- Botがそのチャンネルにアクセスできる必要あり

### 6.3 role配列の管理

- 複数役割を持つことが可能
- 権限は最も高い役割が適用される
- admin > gm > staff の優先順位

---

## 7. トラブルシューティング

### 招待メールが届かない

1. メールアドレスが正しいか確認
2. 迷惑メールフォルダ確認
3. Resend APIログ確認
4. ドメイン認証確認

### ログインできない

1. 招待が承認済みか確認（`accepted_at`）
2. `user_id` が設定されているか確認
3. パスワードリセットを試行

### 権限が足りない

1. `staff.role` 配列を確認
2. 必要な役割が含まれているか確認
3. RLSポリシーを確認

---

## 8. 関連ドキュメント

- [scenario-management/](../scenario-management/) - シナリオ管理
- [shift-management/](../shift-management/) - シフト管理
- [features/README.md](../README.md) - 機能概要一覧

