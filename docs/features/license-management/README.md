# ライセンス管理機能 詳細

**最終更新**: 2025-12-30

シナリオのライセンス料管理と作者への報告を行う機能。

---

## 1. 概要

### この機能が解決する課題

- シナリオ使用のライセンス料を管理したい
- 作者への公演報告を送信したい
- 他社からの公演報告を受け取りたい
- ライセンス料を集計したい

### 権限による機能分岐

| 組織タイプ | 利用可能機能 |
|-----------|-------------|
| **ライセンス管理組織** | 受信・送信・集計 すべて |
| **一般組織** | 送信のみ |

---

## 2. 画面構成

### 2.1 受信タブ（ライセンス管理組織のみ）

他社から受け取った公演報告を確認・承認。

```
┌─────────────────────────────────────────────────────────────────────┐
│ ライセンス管理                                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ [受信] [送信] [集計]                                                 │
│                                                                      │
│  他社からの公演報告                                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 送信元        シナリオ      公演日    公演数  状態    操作  │   │
│  │ A社           〇〇の事件    12/20     2回    承認待ち [確認]│   │
│  │ B社           △△殺人      12/18     1回    承認済み [詳細]│   │
│  │ ...                                                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 送信タブ

作者や権利元への公演報告を送信。

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  公演報告の送信                                                      │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ シナリオ      作者/権利元   期間        公演数  送信状態    │   │
│  │ 〇〇の事件    山田作家     12月分       5回    未送信 [送信]│   │
│  │ △△殺人      佐藤作家     12月分       3回    送信済み     │   │
│  │ □□館        A社          12月分       2回    未送信 [送信]│   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  [一括送信]                                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 集計タブ（ライセンス管理組織のみ）

ライセンス料の集計・分析。

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  ライセンス料集計                期間: [▼ 2024年12月]               │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ シナリオ      作者        公演数   単価     合計ライセンス料│   │
│  │ 〇〇の事件    山田作家    12回    ¥500     ¥6,000          │   │
│  │ △△殺人      佐藤作家    8回     ¥300     ¥2,400          │   │
│  │                                                              │   │
│  │ 合計                      20回             ¥8,400          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 処理フロー

### 3.1 公演報告送信フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│                      公演報告送信フロー                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  【報告元組織】                                                      │
│    │                                                                 │
│    ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 1. 送信タブで対象シナリオを選択                          │        │
│  │    - 期間を指定                                          │        │
│  │    - 公演数を確認/入力                                   │        │
│  └──────────────────────────┬──────────────────────────────┘        │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 2. 報告を送信                                            │        │
│  │    → external_performance_reports テーブルに登録         │        │
│  │    → status = 'pending'                                  │        │
│  └──────────────────────────┬──────────────────────────────┘        │
│                             │                                        │
│  【ライセンス管理組織】     ▼                                        │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 3. 受信タブで報告を確認                                  │        │
│  │    - 内容確認                                            │        │
│  │    - 承認/却下                                           │        │
│  └──────────────────────────┬──────────────────────────────┘        │
│                             │                                        │
│               ┌─────────────┴─────────────┐                         │
│               ▼                           ▼                         │
│        ┌───────────┐               ┌───────────┐                    │
│        │  承認     │               │  却下     │                    │
│        │ approved  │               │ rejected  │                    │
│        └─────┬─────┘               └───────────┘                    │
│              │                                                       │
│              ▼                                                       │
│  ┌─────────────────────────────────────────────────────────┐        │
│  │ 4. 集計に反映                                            │        │
│  │    - ライセンス料計算                                    │        │
│  │    - 作者への支払い対象に追加                            │        │
│  └─────────────────────────────────────────────────────────┘        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. データ構造

### 4.1 external_performance_reports テーブル

```typescript
interface ExternalPerformanceReport {
  id: string
  organization_id: string           // 報告元組織
  scenario_id: string
  
  reported_by: string               // 報告者（staff.id）
  
  // 公演情報
  performance_date: string          // 公演日
  performance_count: number         // 公演回数
  participant_count?: number        // 参加者数
  venue_name?: string               // 会場名
  
  // ステータス
  status: 'pending' | 'approved' | 'rejected'
  
  // 審査情報
  reviewed_by?: string              // 審査者（staff.id）
  reviewed_at?: string
  rejection_reason?: string
  
  notes?: string
  
  created_at: string
  updated_at: string
}
```

### 4.2 ライセンス料計算

```typescript
interface LicensePerformanceSummary {
  scenario_id: string
  scenario_title: string
  author: string
  
  license_amount: number              // シナリオの1公演あたりライセンス料
  
  internal_performance_count: number  // 自社公演数
  external_performance_count: number  // 他社公演数（承認済み）
  total_performance_count: number
  
  total_license_fee: number           // 合計ライセンス料
}

// 計算式
total_license_fee = total_performance_count * license_amount
```

---

## 5. ライセンス管理組織の判定

```typescript
// organizations テーブル
interface Organization {
  id: string
  name: string
  is_license_manager: boolean  // true = ライセンス管理組織
  // ...
}

// 使用例
const { isLicenseManager } = useOrganization()

if (isLicenseManager) {
  // 受信・集計タブを表示
} else {
  // 送信タブのみ表示
}
```

---

## 6. 関連ファイル

### ページ

| ファイル | 役割 |
|---------|------|
| `src/pages/LicenseManagement/index.tsx` | メインページ |
| `src/pages/LicenseReportManagement/index.tsx` | 旧ページ（統合済み） |

### コンポーネント

| ファイル | 役割 |
|---------|------|
| `tabs/ReportsReceived.tsx` | 受信タブ |
| `tabs/SendReports.tsx` | 送信タブ |
| `tabs/LicenseSummary.tsx` | 集計タブ |

### フック

| ファイル | 役割 |
|---------|------|
| `hooks/useLicenseReports.ts` | 報告データ取得 |
| `src/hooks/useOrganization.ts` | 組織情報・権限取得 |

---

## 7. 関連ドキュメント

- [author-portal/](../author-portal/) - 作者ポータル
- [scenario-management/](../scenario-management/) - シナリオ管理
- [features/README.md](../README.md) - 機能概要一覧


