# äºˆç´„ã‚µã‚¤ãƒˆ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2026-01-28  
**ç›£æŸ»ç¯„å›²**: MMQäºˆç´„ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€Edge Functionsã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€RLSï¼‰  
**ç›®çš„**: Î²å…¬é–‹å‰ã®è‡´å‘½çš„è„†å¼±æ€§ã®æ´—ã„å‡ºã—ã¨ä¿®æ­£æŒ‡é‡

---

## ğŸ“Š Executive Summary

| æ·±åˆ»åº¦ | ç™ºè¦‹æ•° | å¯¾å¿œçŠ¶æ³ |
|--------|--------|----------|
| ğŸ”´ Critical | 0 | - |
| ğŸŸ  High | 3 | è¦ä¿®æ­£ |
| ğŸŸ¡ Medium | 6 | Î²å…¬é–‹å‰ã«ä¿®æ­£æ¨å¥¨ |
| ğŸŸ¢ Low | 5 | æ­£å¼ãƒªãƒªãƒ¼ã‚¹å‰ã«æ”¹å–„ |

### é‡è¦ãªç™ºè¦‹

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸºç›¤ã¯è‰¯å¥½**:
- âœ… RLSãƒãƒªã‚·ãƒ¼ãŒå…¨ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨­å®šæ¸ˆã¿
- âœ… Edge Functionsã®å¤§åŠã§èªè¨¼ãƒã‚§ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿
- âœ… SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–æ¸ˆã¿ï¼ˆSupabase SDKä½¿ç”¨ï¼‰
- âœ… XSSå¯¾ç­–æ¸ˆã¿ï¼ˆdangerouslySetInnerHTMLæœªä½¿ç”¨ï¼‰

**è¦ä¿®æ­£äº‹é …**:
- ğŸŸ  ä¸€éƒ¨Edge Functionsã§èªè¨¼ãƒã‚§ãƒƒã‚¯æ¬ å¦‚
- ğŸŸ  notify-waitlistã®ã‚¹ãƒ‘ãƒ æ‚ªç”¨ãƒªã‚¹ã‚¯
- ğŸŸ  åœ¨åº«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸æ•´åˆ

---

## ğŸ”´ Criticalï¼ˆè‡´å‘½çš„ï¼‰ - ãªã—

ç¾æ™‚ç‚¹ã§è‡´å‘½çš„ãªè„†å¼±æ€§ã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚

---

## ğŸŸ  Highï¼ˆé‡å¤§ï¼‰

### 1. notify-waitlist Edge Function ã®èªè¨¼ãªã—ãƒ»ã‚¹ãƒ‘ãƒ æ‚ªç”¨ãƒªã‚¹ã‚¯

**æ·±åˆ»åº¦**: ğŸŸ  **High**

**è„†å¼±æ€§ã®å†…å®¹**:
`notify-waitlist` Edge Functionã¯èªè¨¼ãƒã‚§ãƒƒã‚¯ãªã—ã§å‘¼ã³å‡ºã—å¯èƒ½ã€‚æ”»æ’ƒè€…ãŒä»»æ„ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å¤§é‡å‘¼ã³å‡ºã—ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ï¼š

1. **ã‚¹ãƒ‘ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡**: å­˜åœ¨ã—ãªã„eventIdã§ã‚‚å‘¼ã³å‡ºã—å¯èƒ½ï¼ˆDBã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚Œã‚‹ãŒå‡¦ç†è² è·ï¼‰
2. **Resend APIã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ¶ˆè²»**: ç„¡åŠ¹ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚‚APIã‚³ãƒ¼ãƒ«ç™ºç”Ÿ
3. **DoSæ”»æ’ƒ**: å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§Edge Functionæ¯æ¸‡

**æ”»æ’ƒæ‰‹æ³•ã®å…·ä½“ä¾‹**:
```bash
# èªè¨¼ãªã—ã§å‘¼ã³å‡ºã—å¯èƒ½
curl -X POST 'https://xxxx.supabase.co/functions/v1/notify-waitlist' \
  -H 'Content-Type: application/json' \
  -d '{
    "organizationId": "any-uuid",
    "scheduleEventId": "any-uuid",
    "freedSeats": 100,
    "scenarioTitle": "Test",
    "eventDate": "2026-02-01",
    "startTime": "18:00",
    "endTime": "21:00",
    "storeName": "Test Store",
    "bookingUrl": "https://malicious-site.com"
  }'
```

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/notify-waitlist/index.ts`

```typescript
// è¡Œ36-54: èªè¨¼ãƒã‚§ãƒƒã‚¯ãªã—
serve(async (req) => {
  const origin = req.headers.get('origin')
  const corsHeaders = getCorsHeaders(origin)

  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const serviceClient = createClient(...)  // â† èªè¨¼ãªã—ã§Service Roleä½¿ç”¨
    const data: NotifyWaitlistRequest = await req.json()
    // ...
```

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

```typescript
import { verifyAuth, errorResponse } from '../_shared/security.ts'

serve(async (req) => {
  const origin = req.headers.get('origin')
  const corsHeaders = getCorsHeaders(origin)

  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯è¿½åŠ 
    const authResult = await verifyAuth(req)
    if (!authResult.success) {
      return errorResponse(authResult.error!, authResult.statusCode!, corsHeaders)
    }

    // çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    const { data: staffCheck } = await serviceClient
      .from('staff')
      .select('id')
      .eq('user_id', authResult.user!.id)
      .eq('organization_id', data.organizationId)
      .single()
    
    if (!staffCheck) {
      return errorResponse('ã“ã®æ“ä½œã‚’è¡Œã†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', 403, corsHeaders)
    }

    // ... æ—¢å­˜å‡¦ç†
  }
})
```

---

### 2. check-inventory-consistency Edge Function ã®èªè¨¼ãªã—

**æ·±åˆ»åº¦**: ğŸŸ  **High**

**è„†å¼±æ€§ã®å†…å®¹**:
åœ¨åº«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯Edge Functionã¯èªè¨¼ãƒã‚§ãƒƒã‚¯ãªã—ã§å‘¼ã³å‡ºã—å¯èƒ½ã€‚æ”»æ’ƒè€…ãŒå¤§é‡å‘¼ã³å‡ºã—ã™ã‚‹ã¨ï¼š

1. **DBãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»**: å…¨ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
2. **ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«æ±šæŸ“**: ç„¡æ„å‘³ãªãƒ­ã‚°ãŒå¤§é‡è¨˜éŒ²
3. **Discordé€šçŸ¥ã‚¹ãƒ‘ãƒ **: ä¸æ•´åˆæ¤œå‡ºæ™‚ã«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã‚‹

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/check-inventory-consistency/index.ts`

```typescript
// è¡Œ27-44: èªè¨¼ãƒã‚§ãƒƒã‚¯ãªã—
serve(async (req) => {
  // ...
  try {
    const serviceClient = createClient(...)  // â† èªè¨¼ãªã—ã§Service Roleä½¿ç”¨
    const { data, error } = await serviceClient.rpc('run_inventory_consistency_check')
```

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

```typescript
serve(async (req) => {
  const origin = req.headers.get('origin')
  const corsHeaders = getCorsHeaders(origin)

  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Service Role Key ã¾ãŸã¯ç®¡ç†è€…ã®ã¿è¨±å¯
    const authHeader = req.headers.get('Authorization')
    const expectedKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')
    
    if (!authHeader || !authHeader.includes(expectedKey || '')) {
      // JWTèªè¨¼ã‚’è©¦ã¿ã‚‹
      const authResult = await verifyAuth(req, ['admin', 'license_admin'])
      if (!authResult.success) {
        return new Response(
          JSON.stringify({ error: 'ã“ã®æ“ä½œã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™' }),
          { status: 403, headers: corsHeaders }
        )
      }
    }

    // ... æ—¢å­˜å‡¦ç†
  }
})
```

---

### 3. åœ¨åº«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸ä¸€è‡´ï¼ˆãƒ‡ãƒ¼ã‚¿ç ´å£Šãƒªã‚¹ã‚¯ï¼‰

**æ·±åˆ»åº¦**: ğŸŸ  **High**

**è„†å¼±æ€§ã®å†…å®¹**:
`check_and_fix_inventory_consistency()` é–¢æ•°ãŒ `gm_confirmed` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç„¡è¦–ã—ã¦ã„ã‚‹ãŸã‚ã€æ­£å¸¸ãªäºˆç´„ãŒã€Œä¸æ•´åˆã€ã¨ã—ã¦èª¤æ¤œå‡ºã•ã‚Œã€`current_participants` ãŒä¸æ­£ã«æ¸›å°‘ã•ã‚Œã‚‹ã€‚

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ªã§ã¯ãªã„ãŒã€é‹ç”¨ã§ç™ºç”Ÿ**:
1. GMç¢ºèªæ¸ˆã¿äºˆç´„ï¼ˆ`gm_confirmed`ï¼‰ãŒå­˜åœ¨ã™ã‚‹å…¬æ¼”
2. åœ¨åº«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
3. GMç¢ºèªæ¸ˆã¿äºˆç´„ãŒã€Œç„¡åŠ¹ã€ã¨ã¿ãªã•ã‚Œã€`current_participants` ã‹ã‚‰é™¤å¤–
4. â†’ **ã‚ªãƒ¼ãƒãƒ¼ãƒ–ãƒƒã‚­ãƒ³ã‚°ç™ºç”Ÿãƒªã‚¹ã‚¯**

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `database/migrations/009_inventory_consistency_check.sql`

```sql
-- è¡Œ54-58: gm_confirmed ãŒæ¬ è½
SELECT COALESCE(SUM(participant_count), 0)
INTO v_actual_count
FROM reservations
WHERE schedule_event_id = v_event_record.id
  AND status IN ('confirmed', 'pending');  -- âŒ 'gm_confirmed' ãŒãªã„
```

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

```sql
SELECT COALESCE(SUM(participant_count), 0)
INTO v_actual_count
FROM reservations
WHERE schedule_event_id = v_event_record.id
  AND status IN ('pending', 'confirmed', 'gm_confirmed');  -- âœ… çµ±ä¸€
```

---

## ğŸŸ¡ Mediumï¼ˆä¸­ç¨‹åº¦ï¼‰

### 1. äºˆç´„äººæ•°å¤‰æ›´æ™‚ã®æ¨©é™ãƒã‚§ãƒƒã‚¯ä¸è¶³

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**è„†å¼±æ€§ã®å†…å®¹**:
`update_reservation_participants` RPCé–¢æ•°ã§ `p_customer_id = NULL` ã®å ´åˆã€ä»»æ„ã®äºˆç´„ã‚’å¤‰æ›´å¯èƒ½ã€‚

**æ”»æ’ƒæ‰‹æ³•ã®å…·ä½“ä¾‹**:
```typescript
// ä»–äººã®äºˆç´„IDã‚’æŒ‡å®šã—ã¦customer_idã‚’NULLã§å‘¼ã³å‡ºã—
await supabase.rpc('update_reservation_participants', {
  p_reservation_id: 'victim-reservation-uuid',
  p_new_count: 10,  // å®šå“¡ã‚ªãƒ¼ãƒãƒ¼ã‚’ç‹™ã†
  p_customer_id: null  // NULLã‚’æŒ‡å®š
})
```

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `database/migrations/007_fix_cancel_reservation_nullable_customer.sql`

```sql
-- è¡Œ83-93
SELECT schedule_event_id, participant_count
INTO v_event_id, v_old_count
FROM reservations
WHERE id = p_reservation_id
  AND status != 'cancelled'
  AND (
    (p_customer_id IS NOT NULL AND customer_id = p_customer_id)
    OR (p_customer_id IS NULL)  -- â† NULLãªã‚‰èª°ã§ã‚‚å¤‰æ›´å¯èƒ½
  )
FOR UPDATE;
```

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

```sql
-- 006_security_rpc_and_notifications.sql ã®å®Ÿè£…ã‚’ä½¿ç”¨
-- auth.uid() ã§ã®èªå¯ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
SELECT schedule_event_id, participant_count, organization_id, customer_id
INTO v_event_id, v_old_count, v_res_org_id, v_res_customer_id
FROM reservations
WHERE id = p_reservation_id
  AND status != 'cancelled'
FOR UPDATE;

-- æ¨©é™ãƒã‚§ãƒƒã‚¯
v_caller_org_id := get_user_organization_id();
v_is_admin := is_org_admin();

IF v_is_admin THEN
  NULL; -- ç®¡ç†è€…ã¯OK
ELSIF v_caller_org_id IS NOT NULL THEN
  -- ã‚¹ã‚¿ãƒƒãƒ•ã¯è‡ªçµ„ç¹”ã®ã¿
  IF v_caller_org_id != v_res_org_id THEN
    RAISE EXCEPTION 'FORBIDDEN_ORG';
  END IF;
ELSE
  -- é¡§å®¢ã¯è‡ªåˆ†ã®äºˆç´„ã®ã¿
  SELECT user_id INTO v_customer_user_id FROM customers WHERE id = v_res_customer_id;
  IF v_customer_user_id IS DISTINCT FROM auth.uid() THEN
    RAISE EXCEPTION 'FORBIDDEN_CUSTOMER';
  END IF;
END IF;
```

**ç¾åœ¨ã®çŠ¶æ…‹**: 
006_security_rpc_and_notifications.sql ã«æ­£ã—ã„å®Ÿè£…ãŒã‚ã‚‹ãŒã€007_fix_cancel_reservation_nullable_customer.sql ã§ä¸Šæ›¸ãã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚**é©ç”¨é †åºã‚’ç¢ºèª**ã€‚

---

### 2. ç®¡ç†ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãŒãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**è„†å¼±æ€§ã®å†…å®¹**:
ç®¡ç†ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactï¼‰ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€APIãƒ¬ãƒ™ãƒ«ã§ã¯åˆ¥é€”RLSã§ä¿è­·ã€‚ãŸã ã—ã€ç›´æ¥URLã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®æŒ™å‹•ãŒä¸€ç¬è¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `src/App.tsx`

```typescript
// è¡Œ136-142
if (!user || (user && user.role === 'customer')) {
  if (isInitialized) {
    const adminPaths = ['/dashboard', '/stores', '/staff', ...]
    if (adminPaths.some(path => location.pathname.startsWith(path))) {
      // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
    }
  }
}
```

**ç¾åœ¨ã®å¯¾ç­–çŠ¶æ³**: âœ… **å•é¡Œãªã—**
- RLSã§å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä¿è­·ã•ã‚Œã¦ã„ã‚‹
- APIãƒ¬ãƒ™ãƒ«ã§ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯è¦‹ãŸç›®ã®å•é¡Œã®ã¿

**æ”¹å–„æ¨å¥¨**:
```typescript
// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
if (loading || !isInitialized) {
  return <LoadingScreen />
}
```

---

### 3. ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™é‡‘è¨ˆç®—ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã¿

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**è„†å¼±æ€§ã®å†…å®¹**:
ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™é‡‘ã®è¨ˆç®—ãŒãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è¡Œã‚ã‚Œã€Edge Functionã«é€ä¿¡ã•ã‚Œã‚‹ã€‚æ”¹ã–ã‚“å¯èƒ½ã€‚

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/reservationApi.ts`

```typescript
// è¡Œ422-425
const eventDateTime = new Date(`${scheduleEvent?.date}T${scheduleEvent?.start_time}`)
const hoursUntilEvent = (eventDateTime.getTime() - Date.now()) / (1000 * 60 * 60)
const cancellationFee = hoursUntilEvent < 24 ? (reservation.total_price || 0) : 0
// â†‘ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¨ˆç®—
```

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã‚’ã‚¼ãƒ­ã«æ”¹ã–ã‚“ã—ã¦Edge Functionã‚’å‘¼ã³å‡ºã—ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ãªã—ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã•ã›ã‚‹ã€‚

**ãŸã ã—å½±éŸ¿ã¯é™å®šçš„**:
- ãƒ¡ãƒ¼ãƒ«å†…å®¹ã®ã¿ã®å½±éŸ¿
- å®Ÿéš›ã®æ±ºæ¸ˆé€£æºãŒãªã„ãŸã‚é‡‘éŠ­çš„è¢«å®³ãªã—

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
Edge Functionå´ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã‚’å†è¨ˆç®—ï¼š

```typescript
// send-cancellation-confirmation/index.ts
const eventDateTime = new Date(`${scheduleEvent.date}T${scheduleEvent.start_time}`)
const hoursUntilEvent = (eventDateTime.getTime() - Date.now()) / (1000 * 60 * 60)

// ã‚µãƒ¼ãƒãƒ¼å´ã§å†è¨ˆç®—
const serverCalculatedFee = hoursUntilEvent < 24 
  ? (reservation.total_price || 0) 
  : 0
```

---

### 4. inventory_consistency_logs ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSæœªè¨­å®š

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**è„†å¼±æ€§ã®å†…å®¹**:
åœ¨åº«æ•´åˆæ€§ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã«RLSãƒãƒªã‚·ãƒ¼ãŒãªãã€èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã‚‰èª°ã§ã‚‚èª­ã¿æ›¸ãå¯èƒ½ã€‚

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `database/migrations/009_inventory_consistency_check.sql`

```sql
CREATE TABLE IF NOT EXISTS inventory_consistency_logs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  -- ...
);
-- RLSè¨­å®šãªã—
```

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

```sql
ALTER TABLE inventory_consistency_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY inventory_consistency_logs_admin_only 
ON inventory_consistency_logs
FOR ALL
USING (is_org_admin());
```

---

### 5. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æŠ€è¡“çš„è©³ç´°ãŒå«ã¾ã‚Œã‚‹

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**è„†å¼±æ€§ã®å†…å®¹**:
ä¸€éƒ¨ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚„ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãŒå«ã¾ã‚Œã€æ”»æ’ƒè€…ã«ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’æ¼æ´©ã™ã‚‹å¯èƒ½æ€§ã€‚

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/reservationApi.ts`

```typescript
// è¡Œ217-231
if (error) {
  logger.error('äºˆç´„ä½œæˆRPCã‚¨ãƒ©ãƒ¼:', error)  // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°å‡ºåŠ›
  if (error.code === 'P0003') {
    throw new Error('ã“ã®å…¬æ¼”ã¯æº€å¸­ã§ã™')
  }
  // ...
  throw error  // â† å…ƒã®ã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾ã‚¹ãƒ­ãƒ¼
}
```

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

```typescript
if (error) {
  logger.error('äºˆç´„ä½œæˆRPCã‚¨ãƒ©ãƒ¼:', error)  // ã‚µãƒ¼ãƒãƒ¼å´ãƒ­ã‚°ã¯è©³ç´°OK
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯æ±ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  const userMessage = getRPCErrorMessage(error.code) || 'äºˆç´„å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ'
  throw new Error(userMessage)
}
```

---

### 6. API Rate Limit ã®æ¬ å¦‚

**æ·±åˆ»åº¦**: ğŸŸ¡ **Medium**

**è„†å¼±æ€§ã®å†…å®¹**:
Edge Functionsã«Rate Limitè¨­å®šãŒãªãã€å¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§DoSæ”»æ’ƒãŒå¯èƒ½ã€‚

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: å…¨Edge Functions

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: Supabaseå´è¨­å®šï¼ˆæ¨å¥¨ï¼‰**
```sql
-- Edge Functions ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆSupabase Dashboard ã§è¨­å®šï¼‰
-- Settings â†’ API â†’ Rate limiting
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´å®Ÿè£…**
```typescript
// ç°¡æ˜“ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆIP + ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
const rateLimitKey = `rate_limit:${clientIP}`
const { data: rateData } = await serviceClient
  .from('rate_limits')
  .select('count, last_request')
  .eq('key', rateLimitKey)
  .single()

if (rateData && rateData.count > 100 && 
    Date.now() - rateData.last_request < 60000) {
  return new Response(
    JSON.stringify({ error: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚' }),
    { status: 429, headers: corsHeaders }
  )
}
```

---

## ğŸŸ¢ Lowï¼ˆè»½åº¦ï¼‰

### 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸è¶³

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**è„†å¼±æ€§ã®å†…å®¹**:
CSPï¼ˆContent Security Policyï¼‰ã€HSTS ãªã©ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
Vercelè¨­å®šï¼ˆ`vercel.json`ï¼‰ã«ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ ï¼š

```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-XSS-Protection",
          "value": "1; mode=block"
        },
        {
          "key": "Strict-Transport-Security",
          "value": "max-age=31536000; includeSubDomains"
        },
        {
          "key": "Content-Security-Policy",
          "value": "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
        }
      ]
    }
  ]
}
```

---

### 2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã®ç¢ºèª

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**è„†å¼±æ€§ã®å†…å®¹**:
Supabase Authã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ãŒã€æ˜ç¤ºçš„ãªå¼·åŒ–è¨­å®šãŒãªã„ã€‚

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
Supabase Dashboard ã§ç¢ºèªãƒ»å¼·åŒ–ï¼š
- æœ€å°æ–‡å­—æ•°: 8æ–‡å­—ä»¥ä¸Š
- è¤‡é›‘æ€§è¦ä»¶: å¤§æ–‡å­—ã€å°æ–‡å­—ã€æ•°å­—ã‚’å«ã‚€
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å±¥æ­´: ç›´è¿‘5å›ã¨é‡è¤‡ç¦æ­¢

---

### 3. ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°åˆ¶é™

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**è„†å¼±æ€§ã®å†…å®¹**:
Supabase Authã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œåˆ¶é™ãŒã‚ã‚‹ãŒã€æ˜ç¤ºçš„ãªè¨­å®šç¢ºèªãŒå¿…è¦ã€‚

**ç¢ºèªæ–¹æ³•**:
```sql
-- Supabase Dashboard ã§ç¢ºèª
-- Authentication â†’ Policies â†’ Rate Limits
```

---

### 4. å€‹äººæƒ…å ±ã®å¹³æ–‡ä¿å­˜

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**è„†å¼±æ€§ã®å†…å®¹**:
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€é›»è©±ç•ªå·ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å¹³æ–‡ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã€‚

**è©²å½“ãƒ†ãƒ¼ãƒ–ãƒ«**:
- customersï¼ˆemail, phoneï¼‰
- reservationsï¼ˆcustomer_email, customer_phoneï¼‰
- waitlistï¼ˆcustomer_email, customer_phoneï¼‰

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
PIIï¼ˆå€‹äººè­˜åˆ¥æƒ…å ±ï¼‰ã®æš—å·åŒ–ï¼š

```sql
-- pgcrypto æ‹¡å¼µã‚’æœ‰åŠ¹åŒ–
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- æš—å·åŒ–ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
ALTER TABLE customers ADD COLUMN phone_encrypted BYTEA;
ALTER TABLE customers ADD COLUMN email_encrypted BYTEA;

-- æš—å·åŒ–é–¢æ•°
CREATE FUNCTION encrypt_pii(text_value TEXT, encryption_key TEXT)
RETURNS BYTEA AS $$
  SELECT pgp_sym_encrypt(text_value, encryption_key);
$$ LANGUAGE SQL;

-- å¾©å·åŒ–é–¢æ•°
CREATE FUNCTION decrypt_pii(encrypted_value BYTEA, encryption_key TEXT)
RETURNS TEXT AS $$
  SELECT pgp_sym_decrypt(encrypted_value, encryption_key);
$$ LANGUAGE SQL;
```

**ç¾åœ¨ã®å¯¾ç­–çŠ¶æ³**:
- âœ… RLSã§çµ„ç¹”å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
- âœ… é€šä¿¡ã¯HTTPS
- âŒ DBå†…ã§ã¯å¹³æ–‡

---

### 5. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®æ®‹å­˜

**æ·±åˆ»åº¦**: ğŸŸ¢ **Low**

**è„†å¼±æ€§ã®å†…å®¹**:
æœ¬ç•ªã‚³ãƒ¼ãƒ‰ã«ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°é€ä¿¡å‡¦ç†ãŒæ®‹ã£ã¦ã„ã‚‹ã€‚

**è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«**: `src/pages/BookingConfirmation/hooks/useBookingSubmit.ts`

```typescript
// è¡Œ365-368
// #region agent log
logger.log('[DEBUG-E] é¡§å®¢ãƒ¬ã‚³ãƒ¼ãƒ‰å‡¦ç†é–‹å§‹', {userId:props.userId,customerEmail});
fetch('http://127.0.0.1:7242/ingest/652dea74-319d-4149-8f63-f971b06e1aac',...).catch(()=>{});
// #endregion
```

**æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£**:
ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’å‰Šé™¤ï¼š

```typescript
// å‰Šé™¤ã™ã‚‹ã‹ã€æœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–
if (import.meta.env.DEV) {
  logger.log('[DEBUG-E] é¡§å®¢ãƒ¬ã‚³ãƒ¼ãƒ‰å‡¦ç†é–‹å§‹', ...)
}
```

---

## âœ… æ­£å¸¸ç¢ºèªæ¸ˆã¿é …ç›®

### 1. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

**ç¢ºèªçµæœ**: âœ… **å®‰å…¨**

- Supabase JavaScript SDKã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã‚¯ã‚¨ãƒªã¯è‡ªå‹•çš„ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã•ã‚Œã‚‹
- ç”ŸSQLã®ç›´æ¥å®Ÿè¡Œãªã—
- RPCé–¢æ•°ã‚‚å…¨ã¦ãƒ—ãƒªãƒšã‚¢ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ

**ç¢ºèªä¾‹**:
```typescript
// âœ… Good: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª
const { data } = await supabase
  .from('reservations')
  .select('*')
  .eq('id', userInputId)  // è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—

// âŒ Bad: å­˜åœ¨ã—ãªã„
// supabase.rpc('raw_query', { sql: `SELECT * FROM users WHERE id = '${userInput}'` })
```

---

### 2. XSSï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰å¯¾ç­–

**ç¢ºèªçµæœ**: âœ… **å®‰å…¨**

- `dangerouslySetInnerHTML` ã®ä½¿ç”¨ãªã—ï¼ˆgrepç¢ºèªæ¸ˆã¿ï¼‰
- React ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ©Ÿèƒ½ãŒæœ‰åŠ¹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¯å…¨ã¦ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

---

### 3. CSRFï¼ˆã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªï¼‰å¯¾ç­–

**ç¢ºèªçµæœ**: âœ… **å®‰å…¨**

- Supabase Authã¯JWTãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ã§ã¯ãªã„ï¼‰
- `Authorization: Bearer <token>` ãƒ˜ãƒƒãƒ€ãƒ¼å¿…é ˆ
- Edge Functionsã§CORSè¨­å®šæ¸ˆã¿ï¼ˆè¨±å¯ã‚ªãƒªã‚¸ãƒ³åˆ¶é™ï¼‰

**ç¢ºèªç®‡æ‰€**: `supabase/functions/_shared/security.ts`
```typescript
export const ALLOWED_ORIGINS = [
  'https://mmq-yoyaq.vercel.app',
  'https://mmq-yoyaq-git-main-nagayoshi0923s-projects.vercel.app',
  'http://localhost:5173',
  'http://localhost:3000',
]
```

---

### 4. RLSãƒãƒªã‚·ãƒ¼ï¼ˆä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

**ç¢ºèªçµæœ**: âœ… **é©åˆ‡ã«è¨­å®š**

| ãƒ†ãƒ¼ãƒ–ãƒ« | RLSæœ‰åŠ¹ | ãƒãƒªã‚·ãƒ¼å†…å®¹ |
|----------|---------|--------------|
| reservations | âœ… | é¡§å®¢ã¯è‡ªåˆ†ã®äºˆç´„ã®ã¿ã€ã‚¹ã‚¿ãƒƒãƒ•ã¯è‡ªçµ„ç¹”ã®ã¿ |
| customers | âœ… | è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã€ã‚¹ã‚¿ãƒƒãƒ•ã¯è‡ªçµ„ç¹”ã®ã¿ |
| schedule_events | âœ… | å…¬é–‹ã‚¤ãƒ™ãƒ³ãƒˆã¯å…¨å“¡é–²è¦§å¯ã€éå…¬é–‹ã¯çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ |
| waitlist | âœ… | è‡ªåˆ†ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã¾ãŸã¯çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ |
| staff | âœ… | è‡ªçµ„ç¹”ã®ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿ |
| scenarios | âœ… | å…¬é–‹ã‚·ãƒŠãƒªã‚ªã¯å…¨å“¡é–²è¦§å¯ |

---

### 5. ä»–äººã®äºˆç´„ã‚’å‹æ‰‹ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæ”»æ’ƒã‚·ãƒŠãƒªã‚ª1ï¼‰

**ç¢ºèªçµæœ**: âœ… **é˜²å¾¡æ¸ˆã¿**

**æ”»æ’ƒæ‰‹æ³•**:
```typescript
// ä»–äººã®customer_idã‚’æŒ‡å®šã—ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«
await supabase.rpc('cancel_reservation_with_lock', {
  p_reservation_id: 'victim-reservation-id',
  p_customer_id: 'my-customer-id',  // è‡ªåˆ†ã®ID
  p_cancellation_reason: 'test'
})
```

**å¯¾ç­–**:
```sql
-- 006_security_rpc_and_notifications.sql: è¡Œ304-318
SELECT user_id INTO v_res_customer_user_id
FROM customers
WHERE id = v_res_customer_id;

IF v_res_customer_user_id IS DISTINCT FROM auth.uid() THEN
  RAISE EXCEPTION 'FORBIDDEN_CUSTOMER' USING ERRCODE = 'P0011';
END IF;
```

---

### 6. äºˆç´„æ ã‚’è¶…ãˆã¦äºˆç´„ï¼ˆæ”»æ’ƒã‚·ãƒŠãƒªã‚ª2ï¼‰

**ç¢ºèªçµæœ**: âœ… **é˜²å¾¡æ¸ˆã¿**

**å¯¾ç­–**:
- FOR UPDATEã«ã‚ˆã‚‹æ‚²è¦³ãƒ­ãƒƒã‚¯
- å‚åŠ è€…æ•°ã‚’äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ç›´æ¥é›†è¨ˆ

```sql
-- 005_booking_rpc_and_rls_hardening.sql: è¡Œ41-68
SELECT COALESCE(max_participants, capacity, 8)
INTO v_max_participants
FROM schedule_events
WHERE id = p_schedule_event_id
FOR UPDATE;  -- æ’ä»–ãƒ­ãƒƒã‚¯

SELECT COALESCE(SUM(participant_count), 0)
INTO v_current_participants
FROM reservations
WHERE schedule_event_id = p_schedule_event_id
  AND status IN ('pending', 'confirmed', 'gm_confirmed');

IF p_participant_count > v_available_seats THEN
  RAISE EXCEPTION 'INSUFFICIENT_SEATS' USING ERRCODE = 'P0004';
END IF;
```

---

### 7. ç®¡ç†ç”»é¢ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæ”»æ’ƒã‚·ãƒŠãƒªã‚ª3ï¼‰

**ç¢ºèªçµæœ**: âœ… **é˜²å¾¡æ¸ˆã¿**

- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
- APIãƒ¬ãƒ™ãƒ«ã§RLSã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
- Edge Functionsã§æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆinvite-staff, delete-userç­‰ï¼‰

---

### 8. å€‹äººæƒ…å ±ã®ä¸æ­£å–å¾—ï¼ˆæ”»æ’ƒã‚·ãƒŠãƒªã‚ª4ï¼‰

**ç¢ºèªçµæœ**: âœ… **é˜²å¾¡æ¸ˆã¿**

```sql
-- RLSã§ä¿è­·
CREATE POLICY customers_strict ON customers FOR ALL USING (
  CASE
    WHEN get_user_organization_id() IS NOT NULL THEN
      organization_id = get_user_organization_id() OR is_org_admin()
    ELSE
      user_id = auth.uid()
  END
);
```

---

## ğŸ“‹ æ”»æ’ƒã‚·ãƒŠãƒªã‚ªåˆ¥ã‚µãƒãƒªãƒ¼

| ã‚·ãƒŠãƒªã‚ª | çŠ¶æ…‹ | å¯¾ç­– |
|----------|------|------|
| 1. ä»–äººã®äºˆç´„ã‚’å‹æ‰‹ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ« | âœ… é˜²å¾¡æ¸ˆã¿ | RPCé–¢æ•°ã§auth.uid()ãƒã‚§ãƒƒã‚¯ |
| 2. äºˆç´„æ ã‚’è¶…ãˆã¦äºˆç´„ | âœ… é˜²å¾¡æ¸ˆã¿ | FOR UPDATE + é›†è¨ˆãƒã‚§ãƒƒã‚¯ |
| 3. ç®¡ç†ç”»é¢ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ | âœ… é˜²å¾¡æ¸ˆã¿ | RLS + ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚§ãƒƒã‚¯ |
| 4. å€‹äººæƒ…å ±ã®ä¸æ­£å–å¾— | âœ… é˜²å¾¡æ¸ˆã¿ | RLS |
| 5. æ±ºæ¸ˆé–¢é€£ã®æ”¹ã–ã‚“ | ğŸŸ¡ è¦æ³¨æ„ | æ±ºæ¸ˆé€£æºãŒãªã„ãŸã‚é™å®šçš„å½±éŸ¿ |
| 6. ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾…ã¡é€šçŸ¥ã®æ‚ªç”¨ | ğŸŸ  è¦ä¿®æ­£ | Edge Functionèªè¨¼ãƒã‚§ãƒƒã‚¯è¿½åŠ  |

---

## ğŸ¯ ä¿®æ­£å„ªå…ˆé †ä½

### å³åº§ã«ä¿®æ­£ï¼ˆÎ²å…¬é–‹å‰ï¼‰

1. **notify-waitlist èªè¨¼ãƒã‚§ãƒƒã‚¯è¿½åŠ ** ğŸŸ 
2. **check-inventory-consistency èªè¨¼ãƒã‚§ãƒƒã‚¯è¿½åŠ ** ğŸŸ 
3. **åœ¨åº«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¿®æ­£** ğŸŸ 
4. **inventory_consistency_logs RLSè¿½åŠ ** ğŸŸ¡

### æ­£å¼ãƒªãƒªãƒ¼ã‚¹å‰

5. update_reservation_participants ã®æ¨©é™ãƒã‚§ãƒƒã‚¯ç¢ºèª
6. ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™è¨ˆç®—ã®ã‚µãƒ¼ãƒãƒ¼å´æ¤œè¨¼
7. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ±ç”¨åŒ–
8. Rate Limit è¨­å®š
9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ 

### é•·æœŸæ”¹å–„

10. å€‹äººæƒ…å ±ã®æš—å·åŒ–
11. ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®å‰Šé™¤
12. ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œåˆ¶é™ã®å¼·åŒ–

---

## ğŸ“ ä¿®æ­£ç”¨SQLãƒ‘ãƒƒãƒ

### å³åº§é©ç”¨ãƒ‘ãƒƒãƒ

```sql
-- =============================================================================
-- 1. åœ¨åº«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯é–¢æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¿®æ­£
-- =============================================================================
CREATE OR REPLACE FUNCTION check_and_fix_inventory_consistency()
RETURNS TABLE(
  total_checked INTEGER,
  inconsistencies_found INTEGER,
  auto_fixed INTEGER,
  details JSONB
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_total_checked INTEGER := 0;
  v_inconsistencies_found INTEGER := 0;
  v_auto_fixed INTEGER := 0;
  v_details JSONB := '[]'::JSONB;
  v_event_record RECORD;
  v_actual_count INTEGER;
  v_stored_count INTEGER;
  v_difference INTEGER;
BEGIN
  FOR v_event_record IN
    SELECT 
      se.id,
      se.date,
      se.start_time,
      se.current_participants,
      se.organization_id,
      s.title as scenario_title,
      st.name as store_name
    FROM schedule_events se
    LEFT JOIN scenarios s ON se.scenario_id = s.id
    LEFT JOIN stores st ON se.store_id = st.id
    WHERE se.date >= CURRENT_DATE - INTERVAL '30 days'
      AND se.date <= CURRENT_DATE + INTERVAL '90 days'
      AND se.is_cancelled = false  -- âœ… è¿½åŠ : ä¸­æ­¢æ¸ˆã¿å…¬æ¼”ã‚’é™¤å¤–
    ORDER BY se.date DESC
  LOOP
    v_total_checked := v_total_checked + 1;
    
    -- âœ… ä¿®æ­£: gm_confirmed ã‚’è¿½åŠ 
    SELECT COALESCE(SUM(participant_count), 0)
    INTO v_actual_count
    FROM reservations
    WHERE schedule_event_id = v_event_record.id
      AND status IN ('pending', 'confirmed', 'gm_confirmed');
    
    v_stored_count := COALESCE(v_event_record.current_participants, 0);
    v_difference := v_stored_count - v_actual_count;
    
    IF v_difference <> 0 THEN
      v_inconsistencies_found := v_inconsistencies_found + 1;
      
      v_details := v_details || jsonb_build_object(
        'event_id', v_event_record.id,
        'date', v_event_record.date,
        'start_time', v_event_record.start_time,
        'scenario_title', v_event_record.scenario_title,
        'store_name', v_event_record.store_name,
        'stored_count', v_stored_count,
        'actual_count', v_actual_count,
        'difference', v_difference,
        'organization_id', v_event_record.organization_id
      );
      
      UPDATE schedule_events
      SET current_participants = v_actual_count,
          updated_at = NOW()
      WHERE id = v_event_record.id;
      
      v_auto_fixed := v_auto_fixed + 1;
    END IF;
  END LOOP;
  
  RETURN QUERY SELECT 
    v_total_checked,
    v_inconsistencies_found,
    v_auto_fixed,
    v_details;
END;
$$;

-- =============================================================================
-- 2. inventory_consistency_logs RLSè¨­å®š
-- =============================================================================
ALTER TABLE inventory_consistency_logs ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS inventory_consistency_logs_admin_only ON inventory_consistency_logs;
CREATE POLICY inventory_consistency_logs_admin_only 
ON inventory_consistency_logs
FOR ALL
USING (is_org_admin());

-- Service Role ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼ˆCronå®Ÿè¡Œæ™‚ï¼‰
DROP POLICY IF EXISTS inventory_consistency_logs_service ON inventory_consistency_logs;
CREATE POLICY inventory_consistency_logs_service 
ON inventory_consistency_logs
FOR ALL
USING (current_setting('request.jwt.claim.role', true) = 'service_role');
```

---

**ç›£æŸ»å®Ÿæ–½è€…**: AI Assistant  
**ç›£æŸ»æ—¥æ™‚**: 2026-01-28  
**æ¬¡å›ç›£æŸ»æ¨å¥¨æ™‚æœŸ**: æ­£å¼ãƒªãƒªãƒ¼ã‚¹å‰ï¼ˆÎ²å…¬é–‹å¾Œ1ãƒ¶æœˆä»¥å†…ï¼‰

