# スタッフ招待マニュアル

## 概要

スタッフをシステムに招待する方法と、招待後の流れを説明します。

---

## 1. 招待方法

### 方法A: 新規スタッフを招待

1. **スタッフ管理ページ**を開く
2. 「**スタッフを招待**」ボタンをクリック
3. 以下の情報を入力：
   - メールアドレス（必須）
   - 名前（必須）
   - 電話番号（任意）
   - LINE名（任意）
   - Xアカウント（任意）
   - Discord ID（任意）
   - Discord チャンネルID（任意）
4. 「**招待する**」をクリック

### 方法B: 既存スタッフにアカウント紐付け

1. スタッフ一覧から対象スタッフを選択
2. 「**編集**」→ ダイアログ内の「**連携**」ボタンをクリック
3. 「**既存ユーザー**」または「**新規招待**」を選択
   - **既存ユーザー**: すでにアカウントを持っている場合（メールアドレスで検索）
   - **新規招待**: 新しくアカウントを作成する場合

---

## 2. 招待メール送信後の流れ

### システム側の処理

```
1. メールアドレスで既存ユーザーを検索
   ├── 既存ユーザーあり → そのユーザーIDを使用
   │   └── ロールが admin の場合は admin を維持
   └── 既存ユーザーなし → 新規 Auth ユーザーを作成

2. users テーブルにレコードを作成/更新
   └── role: 'staff'（adminの場合は維持）

3. staff テーブルにレコードを作成/更新
   └── user_id を紐付け

4. customers テーブルにレコードを作成（なければ）
   └── スタッフもプライベート予約できるように

5. 招待リンクを生成
   ├── 新規ユーザー → パスワード設定リンク
   └── 既存ユーザー → パスワードリセットリンク

6. 招待メールを送信（Resend経由）
```

### 招待メールの内容

**件名**: 【MMQ】スタッフアカウント招待

```
こんにちは、〇〇さん

スタッフ管理システムへのアカウントを発行しました。
下のボタンからパスワードを設定してログインしてください。

[パスワードを設定する]

※ このリンクは一定時間で無効になります。
※ 心当たりがない場合はこのメールを破棄してください。
```

---

## 3. 招待された側の操作

### ステップ1: メールを確認

1. 招待メールを開く
2. 「**パスワードを設定する**」ボタンをクリック

### ステップ2: パスワード設定

1. パスワード設定画面が開く
2. 新しいパスワードを入力（2回）
3. 「**設定する**」をクリック

### ステップ3: ログイン完了

1. 自動的にログイン状態になる
2. スタッフ用のナビゲーションが表示される
   - スケジュール
   - シフト提出
   - GM確認
   - 貸切確認
   - マニュアル

---

## 4. トラブルシューティング

### 招待メールが届かない

**原因と対策**:
1. **迷惑メールフォルダ** → 確認してもらう
2. **メールアドレスの入力ミス** → 再度招待し直す
3. **Resend APIキー未設定** → 管理者がサーバー設定を確認

### リンクが無効と表示される

**原因と対策**:
1. **リンクの有効期限切れ** → 再度招待し直す
2. **既に使用済み** → ログイン画面から通常ログイン

### パスワード設定後にログインできない

**原因と対策**:
1. **パスワードを忘れた** → ログイン画面から「パスワードを忘れた方」
2. **メールアドレスが違う** → 招待時のメールアドレスを確認

---

## 5. 管理者向け設定

### 必要な環境変数

Supabase Edge Functions で以下が必要：

| 環境変数 | 説明 | 例 |
|---------|------|-----|
| `SUPABASE_URL` | SupabaseプロジェクトURL | 自動設定 |
| `SUPABASE_SERVICE_ROLE_KEY` | サービスロールキー | 自動設定 |
| `SITE_URL` | サイトURL | `https://mmq-yoyaq.vercel.app` |
| `RESEND_API_KEY` | Resend APIキー | `re_xxxx...` |
| `RESEND_FROM_EMAIL` | 送信元メール | `MMQ <noreply@mmq.game>` |

### Resend設定

1. [Resend](https://resend.com/) でアカウント作成
2. APIキーを発行
3. 送信元ドメインを設定（DNS設定必要）
4. Supabase Secrets に設定：
   ```bash
   npx supabase secrets set RESEND_API_KEY="re_xxxx..."
   npx supabase secrets set RESEND_FROM_EMAIL="MMQ <noreply@your-domain.com>"
   ```

---

## 6. ロール（権限）について

### ロールの種類

| ロール | 説明 | ナビゲーション |
|-------|------|---------------|
| `admin` | 管理者 | 全メニュー表示 |
| `staff` | スタッフ | 限定メニュー（スケジュール、シフト提出、GM確認、貸切確認、マニュアル） |
| `customer` | 顧客 | ナビゲーション非表示（予約サイトのみ） |

### ロールの変更タイミング

- **スタッフ招待時**: `customer` → `staff`
- **スタッフ削除時**: `staff` → `customer`（adminは維持）
- **連携解除時**: `staff` → `customer`（adminは維持）

### 注意事項

- `admin` ロールは招待では変更されません
- 管理者が自分を削除しても `admin` 権限は維持されます
- ロールの手動変更は Supabase の `users` テーブルで行います

---

## 7. データの流れ

```
招待実行
    │
    ├── auth.users（Supabase Auth）
    │   └── メール認証用アカウント
    │
    ├── public.users
    │   └── role: 'staff'
    │
    ├── public.staff
    │   └── user_id で紐付け
    │
    └── public.customers
        └── スタッフもプライベート予約可能に
```

---

## 更新履歴

- 2024-12-01: 初版作成

