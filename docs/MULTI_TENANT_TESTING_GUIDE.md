# マルチテナント対応 動作確認ガイド

## 🎯 確認の目的

複数組織が存在する環境で、各組織のデータが正しく分離されているかを確認します。

## 📋 事前準備

### 1. テスト用組織の準備

SupabaseのSQL Editorで以下を実行して、テスト用の組織を作成（既にある場合はスキップ）：

```sql
-- テスト用組織2を作成（既にある場合はスキップ）
INSERT INTO organizations (id, name, slug, created_at, updated_at)
VALUES (
  'a0000000-0000-0000-0000-000000000002',
  'テスト組織2',
  'test-org-2',
  NOW(),
  NOW()
)
ON CONFLICT (id) DO NOTHING;
```

### 2. テスト用アカウントの準備

#### 方法A: 既存アカウントを使用
- 組織1（クインズワルツ）のアカウント: 既存のスタッフアカウント
- 組織2のアカウント: 新規作成または既存の別組織アカウント

#### 方法B: 新規アカウントを作成
1. アプリで新規登録
2. Supabaseの`users`テーブルで`organization_id`を変更
3. `staff`テーブルにもレコードを作成（スタッフとして使用する場合）

```sql
-- テスト用スタッフを作成（組織2用）
INSERT INTO staff (
  id,
  organization_id,
  name,
  role,
  stores,
  status,
  created_at,
  updated_at
)
VALUES (
  gen_random_uuid(),
  'a0000000-0000-0000-0000-000000000002', -- 組織2のID
  'テストスタッフ2',
  ARRAY['staff'],
  ARRAY[]::uuid[],
  'active',
  NOW(),
  NOW()
);
```

## 🔍 確認手順

### ステップ1: 組織1でログイン

1. **ブラウザでアプリにアクセス**
   ```
   http://localhost:5173
   ```

2. **組織1のアカウントでログイン**

3. **データを確認**
   - シナリオ一覧ページを開く
   - 公演スケジュールページを開く
   - スタッフ一覧ページを開く
   - 予約一覧ページを開く

4. **データを記録**
   - 表示されているシナリオ数: ___件
   - 表示されている公演数: ___件
   - 表示されているスタッフ数: ___件
   - 表示されている予約数: ___件

### ステップ2: 組織2でログイン

1. **別ブラウザ（またはシークレットモード）でアプリにアクセス**
   - Chrome通常モードとChromeシークレットモード
   - またはFirefoxとChrome
   - または2つの異なるデバイス

2. **組織2のアカウントでログイン**

3. **データを確認**
   - 同じページを開く
   - 組織1とは異なるデータが表示されるか確認

4. **データを記録**
   - 表示されているシナリオ数: ___件
   - 表示されている公演数: ___件
   - 表示されているスタッフ数: ___件
   - 表示されている予約数: ___件

### ステップ3: データ分離の確認

#### ✅ 正常な状態
- 組織1と組織2で**異なるデータ**が表示される
- 組織1のデータが組織2に表示されない
- 組織2のデータが組織1に表示されない

#### ❌ 問題がある状態
- 組織1と組織2で**同じデータ**が表示される
- 組織1のデータが組織2にも表示される
- データが混在している

## 🧪 詳細確認項目

### 1. シナリオ管理ページ

**確認URL:** `/scenario-management`

**確認項目:**
- [ ] 組織1で表示されるシナリオが組織2では表示されない
- [ ] シナリオの統計情報（公演回数、売上）が正しい
- [ ] 担当GM、対応店舗、体験済みスタッフが正しく表示される

**確認方法:**
```bash
# ブラウザの開発者ツール（F12）→ Networkタブ
# シナリオ一覧のAPIリクエストを確認
# organization_idパラメータが含まれているか確認
```

### 2. スケジュール管理ページ

**確認URL:** `/schedule`

**確認項目:**
- [ ] 組織1の公演が組織2では表示されない
- [ ] 予約情報が正しく表示される
- [ ] 公演作成時にorganization_idが設定される

**確認方法:**
1. 組織1で公演を作成
2. 組織2で同じ日付・時間を確認
3. 組織2には表示されないことを確認

### 3. スタッフ管理ページ

**確認URL:** `/staff-management`

**確認項目:**
- [ ] 組織1のスタッフが組織2では表示されない
- [ ] スタッフのシフト情報が正しく表示される

### 4. 予約管理

**確認URL:** `/reservations` または予約一覧

**確認項目:**
- [ ] 組織1の予約が組織2では表示されない
- [ ] 予約作成時にorganization_idが設定される

**確認方法:**
1. 組織1で予約を作成
2. 組織2で予約一覧を確認
3. 組織1の予約が表示されないことを確認

### 5. 売上管理ページ

**確認URL:** `/sales-management`

**確認項目:**
- [ ] 組織1の売上が組織2では表示されない
- [ ] 売上統計が正しく計算される

### 6. 顧客管理

**確認URL:** `/customer-management`

**確認項目:**
- [ ] 組織1の顧客が組織2では表示されない
- [ ] 顧客作成時にorganization_idが設定される

## 🔧 デバッグ方法

### 1. ブラウザの開発者ツールで確認

**Networkタブ:**
1. F12キーで開発者ツールを開く
2. Networkタブを選択
3. ページをリロード
4. Supabaseへのリクエストを確認
5. Request Payloadに`organization_id`が含まれているか確認

**Consoleタブ:**
```javascript
// 現在の組織IDを確認
localStorage.getItem('organization_id')

// Supabaseクライアントで直接確認
// （ブラウザのConsoleで実行）
```

### 2. SupabaseのSQL Editorで確認

```sql
-- 組織1のデータ数を確認
SELECT 
  'schedule_events' as table_name,
  COUNT(*) as count
FROM schedule_events
WHERE organization_id = 'a0000000-0000-0000-0000-000000000001'

UNION ALL

SELECT 
  'reservations' as table_name,
  COUNT(*) as count
FROM reservations
WHERE organization_id = 'a0000000-0000-0000-0000-000000000001'

UNION ALL

SELECT 
  'scenarios' as table_name,
  COUNT(*) as count
FROM scenarios
WHERE organization_id = 'a0000000-0000-0000-0000-000000000001'

UNION ALL

SELECT 
  'staff' as table_name,
  COUNT(*) as count
FROM staff
WHERE organization_id = 'a0000000-0000-0000-0000-000000000001';

-- 組織2のデータ数も同様に確認
-- organization_idを変更して実行
```

### 3. ログで確認

アプリのコンソールログを確認：

```bash
# 開発サーバーを起動
npm run dev

# ブラウザのConsoleタブで以下を確認
# - organization_idが正しく取得されているか
# - APIリクエストにorganization_idが含まれているか
```

## ⚠️ 問題が見つかった場合

### 問題1: データが混在している

**原因:**
- `organization_id`フィルタが不足している
- RLSポリシーが正しく設定されていない

**対処:**
1. 該当するAPIファイルを確認
2. `organization_id`フィルタを追加
3. SupabaseのRLSポリシーを確認

### 問題2: データが表示されない

**原因:**
- `organization_id`フィルタが厳しすぎる
- データの`organization_id`がNULLまたは間違っている

**対処:**
```sql
-- organization_idがNULLのデータを確認
SELECT COUNT(*) FROM schedule_events WHERE organization_id IS NULL;
SELECT COUNT(*) FROM reservations WHERE organization_id IS NULL;

-- 必要に応じて修正
UPDATE schedule_events 
SET organization_id = 'a0000000-0000-0000-0000-000000000001'
WHERE organization_id IS NULL;
```

### 問題3: エラーが発生する

**原因:**
- 型エラー
- APIの呼び出しエラー

**対処:**
```bash
# 型チェック
npm run typecheck

# ビルド確認
npm run build

# エラーログを確認
# ブラウザのConsoleタブでエラー内容を確認
```

## 📊 確認チェックリスト

### 基本確認
- [ ] 組織1でログインできる
- [ ] 組織2でログインできる
- [ ] 各組織でデータが表示される

### データ分離確認
- [ ] シナリオが分離されている
- [ ] 公演が分離されている
- [ ] 予約が分離されている
- [ ] スタッフが分離されている
- [ ] 顧客が分離されている

### 機能確認
- [ ] シナリオ作成時にorganization_idが設定される
- [ ] 公演作成時にorganization_idが設定される
- [ ] 予約作成時にorganization_idが設定される
- [ ] スタッフ作成時にorganization_idが設定される

### 統計情報確認
- [ ] 公演回数が正しく表示される
- [ ] 売上が正しく表示される
- [ ] 参加者数が正しく表示される

## 🎯 簡易確認方法（5分）

時間がない場合の簡易確認：

1. **2つのブラウザで同時に開く**
   - ブラウザ1: 組織1でログイン
   - ブラウザ2: 組織2でログイン（シークレットモード）

2. **シナリオ管理ページを開く**
   - 両方のブラウザで `/scenario-management` を開く
   - 表示されるシナリオが異なることを確認

3. **公演スケジュールページを開く**
   - 両方のブラウザで `/schedule` を開く
   - 表示される公演が異なることを確認

4. **問題なければOK、問題があれば詳細確認へ**

## 📝 確認結果の記録

確認日: _______________

確認者: _______________

### 組織1（クインズワルツ）
- シナリオ数: ___件
- 公演数: ___件
- スタッフ数: ___件
- 予約数: ___件

### 組織2（テスト組織）
- シナリオ数: ___件
- 公演数: ___件
- スタッフ数: ___件
- 予約数: ___件

### 問題点
- [ ] 問題なし
- [ ] データが混在している（詳細: _______________）
- [ ] データが表示されない（詳細: _______________）
- [ ] エラーが発生する（詳細: _______________）

### 次のアクション
- [ ] 問題なし、完了
- [ ] 修正が必要（修正内容: _______________）

