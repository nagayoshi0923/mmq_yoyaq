# Day-0 残タスクリスト（本番リリース前）
**作成日**: 2026-02-02  
**対象**: 予約/キャンセル・管理画面・マルチテナント（organization）・RLS/RPC/API を含む実運用システム  
**前提**: セキュリティ総合監査は完了済み、P0は全解消済み。大規模な設計変更は行わない。

> 目的: 「今日〜リリース当日に実行できるもの」に限定し、“やらなくて後悔するもの”を漏れなく列挙する。

---

## Must（今すぐやる）

### 1) リリース実務（Day-0オペレーション）

- [ ] **本番Auth URL設定を確定（Supabase Dashboard）**
  - **担当**: 人（AIは手順提示）
  - **所要**: 10–20分
  - **やること**: Supabase Dashboard → Auth → URL Configuration で **Site URL / Redirect URLs** を本番ドメインに統一（`localhost`/仮ドメインを残さない）。
  - **未実施リスク**: パスワードリセット/招待/ログインが本番で壊れる（問い合わせ爆発）

- [ ] **本番Edge Functions Secrets/環境変数を棚卸し**
  - **担当**: 人（AIはチェック項目提示）
  - **所要**: 15–30分
  - **やること**: Supabase Dashboard → Edge Functions → Secrets で必須値が揃っているか確認し、不要/重複/古いキーを削除。
  - **目安（最低限）**:
    - `RESEND_API_KEY`
    - `CRON_SECRET`（または `EDGE_FUNCTION_CRON_SECRET`）
    - Discord系（`DISCORD_*`）を使うなら全て
    - `SUPABASE_URL`（必要な関数のみ）
  - **未実施リスク**: メール/cron/通知が本番で沈黙、誤送信、運用事故

- [ ] **CORS許可Originを“本番のみ”に最終調整**
  - **担当**: AI（コード修正）＋人（確認）
  - **所要**: 10–20分
  - **やること**: `supabase/functions/_shared/security.ts` の `ALLOWED_ORIGINS` から **`localhost` と不要なpreview URL** を削除し、本番ドメインのみ許可。
  - **未実施リスク**: 意図しないOriginからの呼び出し許容（事故拡大）

### 2) ロールバック／障害対応準備

- [ ] **本番バックアップ（復旧線）を確保してからリリース**
  - **担当**: 人
  - **所要**: 10–30分
  - **やること**: Supabaseのバックアップ/復旧手段（スナップショット/PITR等）を確認し、**リリース直前の復旧ポイント**を確保。復旧手順を1枚にメモ化。
  - **未実施リスク**: 事故時に“戻れない”＝長時間停止 or データ喪失

- [ ] **ロールバック手順を“具体操作”で1本化**
  - **担当**: 人（AIはテンプレ作成）
  - **所要**: 20–40分
  - **やること**: どこを戻すかを固定し、判断基準と担当/連絡順を明記。
    - 例: Vercelを1つ戻す、Functionsを前バージョンへ、DBは原則ロールフォワード（緊急時のみ復旧）
  - **未実施リスク**: 事故時に判断が割れ復旧が遅延（炎上拡大）

### 3) 本番設定・秘密情報・権限

- [ ] **公開RPCサーフェスのスナップショットを“本番DB”に記録**
  - **担当**: 人
  - **所要**: 5分
  - **やること**: 本番Supabase SQL Editorで `docs/deployment/sql/SEC_snapshot_rpc_public_surface.sql` を実行し、`✅ SECURITY_SNAPSHOT logged` を確認。
  - **未実施リスク**: 回帰時に「いつから公開面が増えたか」を追えない

- [ ] **公開RPC回帰チェックを“本番DB”で実行（0を確認）**
  - **担当**: 人
  - **所要**: 5分
  - **やること**: 本番Supabase SQL Editorで `docs/deployment/sql/SEC_check_rpc_public_surface_regression.sql` を実行し、`unexpected_count = 0` を確認。
  - **未実施リスク**: “うっかりPUBLIC/anonにEXECUTE付与”が再発しても気づけない（P0再来）

- [ ] **認証不要で叩けるEdge Functionをゼロ化（例外は署名検証/cron secretのみ）**
  - **担当**: AI（修正）＋人（判断）
  - **所要**: 15–45分
  - **やること**: `verifyAuth` も `isCronOrServiceRoleCall` も “署名検証” も無い関数を停止/削除/ガード追加（特にテスト用）。
  - **未実施リスク**: 本番で「便利な穴」が残り、事故起点になる

### 4) 初期データ／初期状態の確認

- [ ] **危険なNULL/DEFAULTの実データ確認（本番DB）**
  - **担当**: 人（AIはSQL用意可）
  - **所要**: 10–20分
  - **やること**: 主要テーブルで `organization_id IS NULL` 件数を確認し、意図しないNULLがあれば当日中に是正。
  - **未実施リスク**: マルチテナント境界の“抜け”が運用事故として再燃

### 5) ログ・監視・アラート

- [ ] **リリース後24時間の監視ビューを固定**
  - **担当**: 人
  - **所要**: 15分
  - **やること**: Vercel/Supabaseで最低限「エラー率」「Functions 4xx/5xx」「DB負荷」「Auth失敗」「メール失敗」を同じ導線で見られるようにし、URLを共有。
  - **未実施リスク**: 初動が遅れ、軽微障害が重大化

### 6) サポート・問い合わせ導線

- [ ] **本番で“実送信”でメール疎通を1回通す**
  - **担当**: 人
  - **所要**: 10–15分
  - **やること**: 予約確認/キャンセル確認/リマインダのうち最低1系統を本番で実行し、**届く/差出人/リンク先**を確認。
  - **未実施リスク**: 当日ユーザーが詰み、サポートが手作業地獄

---

## Should（余裕があれば：事故率が下がる）

- [ ] **レートリミットの本番閾値を最終確認**
  - **担当**: 人＋AI（必要なら調整）
  - **所要**: 10–20分
  - **やること**: `check_rate_limit` の対象エンドポイントと閾値を見直し（予約作成/ログイン/招待受諾など）。
  - **未実施リスク**: 誤連打や負荷でAPIが苦しくなる

- [ ] **監査ログの“見方”を運用メモ化（SQL 2〜3本）**
  - **担当**: 人（AIはSQL作成可）
  - **所要**: 15分
  - **やること**: `audit_logs` から「誰が/いつ/何を」を追えるSQLを用意（予約改変・大量削除・権限系）。
  - **未実施リスク**: 事故時の追跡が遅い

- [ ] **問い合わせ導線/規約/ポリシーのリンクを本番でクリック検証**
  - **担当**: 人
  - **所要**: 10分
  - **やること**: 画面から実際にリンクを開き、404や旧ドメイン参照が無いことを確認。
  - **未実施リスク**: 顧客対応が詰む・信頼性/法務リスク

- [ ] **管理画面の危険操作に二段階確認（対象件数/組織表示）**
  - **担当**: AI（UI変更）＋人（確認）
  - **所要**: 20–40分
  - **やること**: 「削除」「一括更新」「再計算」系に確認ダイアログ＋対象件数表示を追加。
  - **未実施リスク**: 誤操作でデータ破壊（“悪意なしで壊れる”）

- [ ] **重いクエリの実行計画（EXPLAIN観点）を確認**
  - **担当**: 人（必要ならAIがSQL整備）
  - **所要**: 15–30分
  - **やること**: 予約一覧/売上集計/レポートの重いSQLを確認し、明確なインデックス不足があれば最小追加。
  - **未実施リスク**: リリース直後に遅い/タイムアウトで炎上

---

## Later（後日でよいが、負債として残る）

- [ ] **“公開してよいRPC”ホワイトリスト運用をCIで自動化**
  - **担当**: 自動（CI）＋AI（整備）
  - **所要**: 1–2時間
  - **やること**: `SEC_check_rpc_public_surface_regression.sql` をCIに組み込み、`unexpected_count>0` で落とす。
  - **未実施リスク**: 将来のP0再発確率が上がる

- [ ] **`organization_id IS NULL` 緩和の段階的撤去計画**
  - **担当**: 人＋AI
  - **所要**: 半日〜
  - **やること**: NULLデータ撲滅 → ポリシーから `OR organization_id IS NULL` を撤去。
  - **未実施リスク**: “移行期間の例外”が永続化して事故源になる

---

## 本番環境リンク（必要に応じて更新）

- **Supabase Dashboard（本番）**: `https://supabase.com/dashboard/project/cznpcewciwywcqcxktba`
- **Supabase SQL Editor（本番）**: `https://supabase.com/dashboard/project/cznpcewciwywcqcxktba/sql/new`
- **プロジェクトREF**: `cznpcewciwywcqcxktba`

