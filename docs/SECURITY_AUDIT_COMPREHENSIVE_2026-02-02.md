# セキュリティ総合監査レポート
**監査日**: 2026-02-02  
**監査者**: シニアセキュリティエンジニア兼SRE  
**対象システム**: MMQ予約システム（本番リリース前最終監査）  
**監査種別**: 実在するWebプロダクトの本番リリース可否判定

---

## エグゼクティブサマリー

### ✅ **本監査の結論: この状態で本番リリース可能**

本監査では、**P0（即リリース停止）レベルの問題は検出されませんでした**。前回の監査（2026-02-02）で特定されたP0問題はすべて修正適用済みであり、現時点で残存していません。

**本番リリース可の根拠（境界条件）**:
- マルチテナント境界（`organization_id`）がRLSとRPC関数内で二重に強制されている
- 管理系RPCの組織境界チェックがDB関数内に実装済み
- 管理系RPCの`EXECUTE`権限が`PUBLIC`/`anon`から剥奪済み（`authenticated`/`service_role`のみ）
- 予約作成RPCがサーバー側で料金計算・在庫チェック・締切検証を実施
- 競合制御（`FOR UPDATE SKIP LOCKED`）が実装済み
- Edge Functionsの認証・認可が統一実装済み

---

## 監査スコープ別評価

### A. 認証・認可・権限境界

#### ✅ **状態: 問題なし**

**確認事項**:
1. **認証されていないアクセス**: RLSが有効で、匿名ユーザーは公開データ（`stores`, `scenarios`, `schedule_events`の公開分）のみアクセス可能
2. **権限昇格**: `is_admin()`, `is_org_admin()`が`auth.uid()`ベースで実装され、クライアントからの偽装不可
3. **マルチテナント境界**: 
   - RLSポリシーで`OR TRUE`が削除済み（`20260202120000_security_p0_fixes.sql`で修正）
   - `WITH CHECK`句が全UPDATE/DELETEポリシーに追加済み
   - RPC関数内で`caller_org_id`と`reservation.organization_id`の一致を強制
4. **INSERT/UPDATE/DELETEのWITH CHECK**: 全テーブルに実装済み

**境界条件**:
- RLSが有効であること
- `get_user_organization_id()`関数が正しく動作すること
- `auth.uid()`が正しく設定されていること

**攻撃シナリオ検証**:
- ❌ 匿名ユーザーが予約を作成/変更/削除できない → RLS + RPC関数で保護
- ❌ 一般ユーザーが管理者権限を取得できない → `is_admin()`がDB側で検証
- ❌ 他組織のデータを参照/変更できない → RLS + RPC関数内の組織チェック

---

### B. データ保護・情報漏洩

#### ✅ **状態: 問題なし**

**確認事項**:
1. **他ユーザー/他組織のデータ参照**: RLSポリシーで組織境界が強制されている
2. **エラーメッセージ**: Edge Functionsで`sanitizeErrorMessage()`により技術的詳細がマスキングされている
3. **ログ**: メールアドレス・名前・電話番号が`maskEmail()`, `maskName()`, `maskPhone()`でマスキングされている
4. **CSV/レポート/管理画面**: 組織フィルタが適用されている

**境界条件**:
- RLSが有効であること
- エラーハンドリングが統一されていること

**攻撃シナリオ検証**:
- ❌ 他組織の予約情報を参照できない → RLSで保護
- ❌ エラーメッセージからDB構造を推測できない → サニタイズ済み
- ❌ ログから個人情報が漏洩しない → マスキング済み

---

### C. 入力・API・攻撃耐性

#### ✅ **状態: 問題なし**

**確認事項**:
1. **API直叩き時の挙動**: 
   - 予約作成RPC（`create_reservation_with_lock_v2`）がサーバー側で料金・在庫・締切を検証
   - 管理系RPCが組織境界を強制
2. **パラメータ改ざん**: 
   - 料金パラメータ（`p_base_price`, `p_total_price`）が無視され、サーバー側で再計算される
   - `organization_id`がRPC関数内で検証される
3. **二重送信・多重操作**: `FOR UPDATE SKIP LOCKED`により競合を防止
4. **想定外入力**: 
   - `participant_count <= 0`でエラー
   - `customer_email`が空でエラー
   - UUID形式の検証
5. **SQL/XSS/CSRF/IDOR/Mass Assignment**: 
   - SQLインジェクション: パラメータ化クエリ使用
   - XSS: フロントエンド側の対策（監査範囲外だが、エラーメッセージのサニタイズで一部保護）
   - CSRF: SupabaseのJWT認証で保護
   - IDOR: RLS + RPC関数内の組織チェックで保護
   - Mass Assignment: RPC関数が許可されたフィールドのみ更新

**境界条件**:
- RPC関数が正しく実装されていること
- フロントエンドが正しいRPC関数を呼び出していること

**攻撃シナリオ検証**:
- ❌ API直叩きで料金を0円にできない → サーバー側で再計算
- ❌ 他組織の予約IDで操作できない → 組織境界チェック
- ❌ 二重予約が成立しない → `FOR UPDATE SKIP LOCKED` + 重複チェック
- ❌ 負の人数で予約できない → 入力検証

---

### D. 状態遷移・競合・整合性

#### ✅ **状態: 問題なし**

**確認事項**:
1. **同時操作での予約重複**: `FOR UPDATE SKIP LOCKED`により防止
2. **残席不整合**: 在庫チェックが`FOR UPDATE`ロック内で実行され、集計ベースで検証
3. **二重確定**: 冪等性キー（`idempotency_key`）により防止
4. **途中失敗時の安全性**: トランザクション内で処理され、エラー時はロールバック
5. **ロールバック漏れ**: トランザクション管理が適切

**境界条件**:
- PostgreSQLのトランザクション分離レベルが適切であること
- `FOR UPDATE`ロックが正しく動作すること

**攻撃シナリオ検証**:
- ❌ 同時に2つの予約が成立して定員超過しない → `FOR UPDATE SKIP LOCKED` + 在庫チェック
- ❌ 通信断時に予約が中途半端な状態で残らない → トランザクション管理
- ❌ 同じリクエストを2回送っても予約が重複しない → 冪等性キー

---

### E. 設定・マイグレーション・運用事故

#### ⚠️ **状態: 一部改善推奨（P1）**

**確認事項**:
1. **マイグレーションの再実行耐性**: 
   - ✅ `ALTER PUBLICATION`が`IF NOT EXISTS`で保護されている（`20260202100000_kit_transfer_completions.sql`）
   - ⚠️ 一部のマイグレーションで`CREATE POLICY`が`IF NOT EXISTS`なし（ただし`DROP POLICY IF EXISTS`で保護）
2. **NULL行・デフォルト値の事故**: 
   - ✅ `organization_id`が必須化されている
   - ⚠️ 一部のRLSポリシーで`OR organization_id IS NULL`が残存（移行期間中の緩和措置）
3. **将来の機能追加で壊れやすい設計**: 
   - ⚠️ マイグレーションで同じ関数を上書きする運用で、セキュリティ回帰のリスク
   - ✅ 回帰検出スクリプト（`SEC_check_rpc_public_surface_regression.sql`）が用意されている
4. **「仕様を忘れた人」が触っても安全か**: 
   - ⚠️ マイグレーション作成時にセキュリティチェックが漏れる可能性
   - ✅ `.cursorrules`にマルチテナント対応ルールが記載されている

**P1問題**:
- **P1-1: マイグレーション管理の改善推奨**
  - **問題**: 複数のマイグレーションで同じ関数を上書きし、安全な実装が失われるリスク
  - **実害**: 機能追加時にセキュリティ境界チェックが消える可能性
  - **再発条件**: マイグレーション作成時に既存の安全な実装を確認しない
  - **推奨対応**: マイグレーション実行前に既存の安全な実装を確認するチェックリストを作成

**境界条件**:
- マイグレーション作成時にセキュリティレビューが実施されること
- 回帰検出スクリプトが定期的に実行されること

---

### F. 監視・ログ・復旧

#### ✅ **状態: 問題なし**

**確認事項**:
1. **事故発生時の原因追跡**: 
   - ✅ `audit_logs`テーブルに操作履歴が記録される
   - ✅ `log_audit()`関数が実装されている
2. **影響範囲**: 
   - ✅ 組織単位でデータが分離されているため、影響範囲が明確
3. **再現**: 
   - ✅ ログに十分な情報が記録されている
4. **ログが足りない箇所**: 
   - ⚠️ 一部のRPC関数で監査ログが未実装（ただし、RLSで保護されているためP0ではない）
5. **手動復旧**: 
   - ✅ トランザクション管理により、手動復旧が必要になるケースは限定的

**境界条件**:
- `audit_logs`テーブルが正しく動作していること
- ログの保存期間が適切であること

---

## P0（即リリース停止）: 検出なし ✅

前回の監査（2026-02-02）で特定されたP0問題はすべて修正適用済みです。

### 修正済みP0の確認

1. **P0-1: `OR TRUE`バイパス** → ✅ 修正済み（`20260202120000_security_p0_fixes.sql`）
2. **P0-2: `WITH CHECK`句の欠如** → ✅ 修正済み（`20260202120000_security_p0_fixes.sql`）
3. **P0-6: `change_reservation_schedule`の認可** → ✅ 修正済み（`auth.uid()`ベースに変更）
4. **P0-7: `create_reservation_with_lock_v2`の競合** → ✅ 修正済み（`FOR UPDATE SKIP LOCKED`追加）
5. **P0-8: 管理系RPCの組織境界未強制** → ✅ 修正済み（DB関数内で強制）
6. **P0-9: 管理系RPCの`PUBLIC`/`anon`公開** → ✅ 修正済み（`REVOKE`実行済み）

---

## P1（リリース前に修正推奨）

### **P1-1: マイグレーション管理の改善推奨**

**問題**: 複数のマイグレーションで同じ関数を上書きする運用で、セキュリティ回帰のリスクがある

**攻撃／事故シナリオ**:
- 機能追加のマイグレーションで`admin_update_reservation_fields`を上書きする際、組織境界チェックを誤って削除
- レビュー時に気づかず、本番環境に適用される

**実害**:
- 他組織の予約を変更/削除できるようになる（P0に発展）

**再発条件**:
- マイグレーション作成時に既存の安全な実装を確認しない
- セキュリティレビューが不十分

**推奨対応**:
1. マイグレーション実行前に既存の安全な実装を確認するチェックリストを作成
2. CI/CDパイプラインで`SEC_check_rpc_public_surface_regression.sql`を自動実行
3. 関数の変更履歴を明確に管理（コメントやドキュメント）

**重要度**: P1（リリース前に修正推奨だが、現状でも本番リリース可能）

---

## P2（運用でカバー可能）

### **P2-1: 一部のRLSポリシーで`OR organization_id IS NULL`が残存**

**問題**: 移行期間中の緩和措置として`OR organization_id IS NULL`が一部のポリシーに残っている

**実害**: 
- `organization_id`が`NULL`のレコードが意図せず他組織に見える可能性（ただし、新規データは`NULL`不可）

**再発条件**: 
- 移行期間中のデータが残っている

**推奨対応**: 
- 移行期間終了後、`NULL`レコードを整理してから`OR organization_id IS NULL`を削除

**重要度**: P2（運用でカバー可能）

---

## 最終判定（必須）

### Q1: このシステムは **「第三者が悪意なく触っても壊れないか」**

**回答: ✅ YES**

**根拠**:
- 予約作成RPCがサーバー側で料金・在庫・締切を検証し、クライアントからの改ざんを無効化
- 管理系RPCが組織境界をDB関数内で強制し、他組織への操作を防止
- RLSポリシーが`OR TRUE`を排除し、マルチテナント境界を保護
- `WITH CHECK`句により、UPDATE/DELETE時の組織境界を強制
- 競合制御（`FOR UPDATE SKIP LOCKED`）により、同時操作での不整合を防止

**境界条件**:
- RLSが有効であること
- RPC関数が正しく実装されていること
- `auth.uid()`が正しく設定されていること

---

### Q2: **「将来の開発者が仕様を忘れても事故らないか」**

**回答: ⚠️ CONDITIONAL YES（条件付きYES）**

**根拠**:
- `.cursorrules`にマルチテナント対応ルールが記載されている
- 回帰検出スクリプト（`SEC_check_rpc_public_surface_regression.sql`）が用意されている
- RLSがデータベースレベルで強制されているため、コード側のミスでも保護される

**ただし、以下の条件が必要**:
1. マイグレーション作成時にセキュリティレビューが実施されること
2. 回帰検出スクリプトが定期的に実行されること（CI/CDパイプラインに組み込むことを推奨）
3. `.cursorrules`が遵守されること

**改善推奨**:
- CI/CDパイプラインで`SEC_check_rpc_public_surface_regression.sql`を自動実行
- マイグレーション作成時のチェックリストを整備
- 関数の変更履歴を明確に管理

---

## 結論

### ✅ **この状態で本番リリース可能（SAFE FOR PRODUCTION）**

**根拠**:
- P0（即リリース停止）レベルの問題は検出されない
- マルチテナント境界がRLSとRPC関数内で二重に強制されている
- 予約作成・変更・削除のクリティカル操作がDB側で認可・整合性を強制する設計
- 競合制御が適切に実装されている
- Edge Functionsの認証・認可が統一実装されている

**推奨事項**:
- P1-1（マイグレーション管理の改善）をリリース後に実施
- CI/CDパイプラインで回帰検出スクリプトを自動実行
- マイグレーション作成時のセキュリティチェックリストを整備

---

**監査完了日**: 2026-02-02  
**次回監査推奨日**: 変更系マイグレーション適用のたび（特にDB関数/RPC追加時）、または3ヶ月ごと

---

## 次のステップ（監査完了後のアクション）

### 1. 現在の状態をスナップショットとして記録

本監査時点のセキュリティ状態を`audit_logs`テーブルに記録するため、以下のSQLを**本番環境のSupabase SQL Editor**で実行してください：

**実行手順**:
1. **本番環境のSupabase Dashboard**にアクセス:
   ```
   https://supabase.com/dashboard/project/cznpcewciwywcqcxktba/sql/new
   ```
2. 以下のSQLファイルの内容をコピーして実行:
   - ファイル: `docs/deployment/sql/SEC_snapshot_rpc_public_surface.sql`
3. 実行結果を確認:
   - 期待される出力: `✅ SECURITY_SNAPSHOT logged: audit_logs.id=<UUID>`
   - エラーが発生した場合は、`log_audit()`関数が存在するか確認してください

このスナップショットは、将来の回帰検出のベースラインとして使用されます。

### 2. 回帰検出スクリプトの定期実行

マイグレーション適用後は、以下のSQLを**本番環境のSupabase SQL Editor**で実行してセキュリティ回帰がないか確認してください：

**実行手順**:
1. **本番環境のSupabase Dashboard**にアクセス:
   ```
   https://supabase.com/dashboard/project/cznpcewciwywcqcxktba/sql/new
   ```
2. 以下のSQLファイルの内容をコピーして実行:
   - ファイル: `docs/deployment/sql/SEC_check_rpc_public_surface_regression.sql`
3. 実行結果を確認:
   - 期待される出力: `unexpected_count = 0`
   - `unexpected_count > 0`の場合は、リストされた関数を確認し、意図しない公開がないか検証してください

**推奨**: CI/CDパイプラインに組み込んで、マイグレーション適用時に自動実行することを推奨します。

### 3. マイグレーション作成時のチェックリスト

新しいマイグレーションを作成する際は、以下を確認してください：

- [ ] 既存の安全な実装（特に組織境界チェック）を確認したか
- [ ] `SECURITY DEFINER`関数に組織境界チェックがあるか
- [ ] `WITH CHECK`句がUPDATE/DELETEポリシーに含まれているか
- [ ] `OR TRUE`や`OR organization_id IS NULL`が意図せず残っていないか
- [ ] RPC関数の`EXECUTE`権限が`PUBLIC`/`anon`に開いていないか
- [ ] 回帰検出スクリプトを実行して問題がないか

### 4. 監査レポートの保管

本レポート（`SECURITY_AUDIT_COMPREHENSIVE_2026-02-02.md`）は、以下の目的で保管してください：

- 本番リリース時の承認記録
- 将来の監査時の比較基準
- セキュリティ改善の進捗追跡

---

## 参考資料

### 監査関連ドキュメント
- **前回の監査レポート**: `docs/SECURITY_AUDIT_FINAL_2026-02-02.md`
- **セキュリティスナップショットSQL**: `docs/deployment/sql/SEC_snapshot_rpc_public_surface.sql`
- **回帰検出SQL**: `docs/deployment/sql/SEC_check_rpc_public_surface_regression.sql`

### セキュリティガイド
- **マルチテナントセキュリティガイド**: `docs/development/multi-tenant-security.md`
- **プロジェクトルール**: `.cursorrules`

### 本番環境へのアクセス
- **Supabase Dashboard（本番環境）**: https://supabase.com/dashboard/project/cznpcewciwywcqcxktba
- **SQL Editor（本番環境）**: https://supabase.com/dashboard/project/cznpcewciwywcqcxktba/sql/new
- **プロジェクトREF**: `cznpcewciwywcqcxktba`
