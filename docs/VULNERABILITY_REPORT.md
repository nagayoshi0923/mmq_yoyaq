# ğŸ”´ è„†å¼±æ€§èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

**èª¿æŸ»æ—¥**: 2026-01-13  
**èª¿æŸ»è€…**: AI Security Auditor  
**å¯¾è±¡**: MMQ Yoyaq ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“

---

## ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ˆå³åº§ã«å¯¾å¿œãŒå¿…è¦ï¼‰

### 1. Edge Functionsèªè¨¼ãªã— - ãƒ¡ãƒ¼ãƒ«é€ä¿¡API

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/send-email/index.ts`

**å•é¡Œ**: èªè¨¼ãƒã‚§ãƒƒã‚¯ãªã—ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¯èƒ½ã€‚æ”»æ’ƒè€…ãŒä»»æ„ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã§ãã‚‹ã€‚

```typescript
// ç¾çŠ¶: èªè¨¼ãƒã‚§ãƒƒã‚¯ãŒãªã„
serve(async (req) => {
  const { to, subject, body } = await req.json()
  // â†’ èª°ã§ã‚‚ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¯èƒ½ï¼
})
```

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
- ã‚¹ãƒ‘ãƒ ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆæ­£è¦ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ï¼‰
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¯ã‚©ãƒ¼ã‚¿æ¯æ¸‡ï¼ˆDoSï¼‰
- çµ„ç¹”ã®è©•åˆ¤æå‚·

**å¯¾ç­–**: `verifyAuth()` ã‚’è¿½åŠ 

```typescript
import { verifyAuth, getCorsHeaders, errorResponse } from '../_shared/security.ts'

serve(async (req) => {
  const corsHeaders = getCorsHeaders(req.headers.get('origin'))
  
  // èªè¨¼ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  const authResult = await verifyAuth(req, ['admin', 'staff'])
  if (!authResult.success) {
    return errorResponse(authResult.error!, authResult.statusCode!, corsHeaders)
  }
  
  // æ—¢å­˜å‡¦ç†...
})
```

**å½±éŸ¿åº¦**: ğŸ”´ Critical  
**å„ªå…ˆåº¦**: å³åº§ã«å¯¾å¿œ  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **å¯¾å¿œå®Œäº†** (2026-01-13)

---

### 2. CORSè¨­å®šãŒç·©ã™ãã‚‹ï¼ˆ18å€‹ã®Edge Functionsï¼‰

**å•é¡Œ**: å¤šãã®Edge Functionsã§ `Access-Control-Allow-Origin: *` ã‚’ä½¿ç”¨

**å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«**:
- `send-email/index.ts`
- `send-author-report/index.ts`
- `send-cancellation-confirmation/index.ts`
- `send-reminder-emails/index.ts`
- `send-booking-change-confirmation/index.ts`
- `send-private-booking-request-confirmation/index.ts`
- `send-private-booking-confirmation/index.ts`
- `send-private-booking-rejection/index.ts`
- `tweet-available-seats/index.ts`
- `sync-shifts-to-google-sheet/index.ts`
- `schedule-reminder-emails/index.ts`
- `auto-send-reminder-emails/index.ts`
- `notify-shift-request-discord-simple/index.ts`
- `notify-shift-submitted-discord/index.ts`
- `notify-private-booking-discord/index.ts`
- `discord-shift-interactions/index.ts`
- `discord-interactions/index.ts`
- `discord-simple/index.ts`

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
- æ‚ªæ„ã‚ã‚‹ã‚µã‚¤ãƒˆã‹ã‚‰ã®APIã‚³ãƒ¼ãƒ«
- CSRFã«é¡ä¼¼ã—ãŸæ”»æ’ƒ

**å¯¾ç­–**: `getCorsHeaders()` ã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒªã‚¸ãƒ³ã‚’åˆ¶é™

```typescript
// ç¾çŠ¶
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',  // å±é™ºï¼
}

// ä¿®æ­£å¾Œ
import { getCorsHeaders } from '../_shared/security.ts'
const corsHeaders = getCorsHeaders(req.headers.get('origin'))
```

**å½±éŸ¿åº¦**: ğŸŸ  High  
**å„ªå…ˆåº¦**: é«˜  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **å¯¾å¿œå®Œäº†** (2026-01-13)

---

## ğŸŸ  é«˜ãƒªã‚¹ã‚¯

### 3. äºˆç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®èªè¨¼ã«ã¤ã„ã¦

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/send-booking-confirmation/index.ts`

**ç¾çŠ¶åˆ†æ**:
- `supabase.functions.invoke()` çµŒç”±ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Authorizationãƒˆãƒ¼ã‚¯ãƒ³ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã‚‹
- ãŸã ã—ã€æœªèªè¨¼é¡§å®¢ï¼ˆã‚²ã‚¹ãƒˆäºˆç´„ï¼‰ã®å ´åˆã¯èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„
- CORSåˆ¶é™ãŒé©ç”¨ã•ã‚ŒãŸãŸã‚ã€æ‚ªæ„ã‚ã‚‹ã‚µã‚¤ãƒˆã‹ã‚‰ã®å‘¼ã³å‡ºã—ã¯é˜²æ­¢æ¸ˆã¿

**ãƒªã‚¹ã‚¯è©•ä¾¡**: ğŸŸ¡ ä¸­ï¼ˆCORSåˆ¶é™ã«ã‚ˆã‚Šè»½æ¸›ï¼‰

**å°†æ¥çš„ãªå¯¾ç­–æ¡ˆ**:
1. äºˆç´„IDã®å­˜åœ¨ç¢ºèªã¨ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨DBã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
2. äºˆç´„ä½œæˆç›´å¾Œã®ã¿ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’è¨±å¯ã™ã‚‹æ™‚é–“åˆ¶é™
3. ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒˆãƒªã‚¬ãƒ¼ï¼ˆDB insertæ™‚ã®è‡ªå‹•é€ä¿¡ï¼‰ã¸ã®ç§»è¡Œ

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ“‹ **çµŒéè¦³å¯Ÿ**ï¼ˆCORSåˆ¶é™é©ç”¨æ¸ˆã¿ï¼‰

---

### 4. è²¸åˆ‡äºˆç´„é–¢é€£ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ç®¡ç†ç”»é¢ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼š
- `send-private-booking-confirmation` - è²¸åˆ‡äºˆç´„æ‰¿èªæ™‚
- `send-private-booking-rejection` - è²¸åˆ‡äºˆç´„å´ä¸‹æ™‚

**ç¾çŠ¶åˆ†æ**:
- ç®¡ç†ç”»é¢ã‹ã‚‰`supabase.functions.invoke()`ã§å‘¼ã³å‡ºã—
- ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãŸã‚ã€Authorizationãƒˆãƒ¼ã‚¯ãƒ³ã¯é€ä¿¡ã•ã‚Œã‚‹
- CORSåˆ¶é™ãŒé©ç”¨æ¸ˆã¿

**å¯¾ç­–**: å°†æ¥çš„ã«`verifyAuth(req, ['admin', 'staff'])`ã‚’è¿½åŠ æ¨å¥¨

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ“‹ **çµŒéè¦³å¯Ÿ**ï¼ˆCORSåˆ¶é™é©ç”¨æ¸ˆã¿ï¼‰

---

## ğŸŸ¡ ä¸­ãƒªã‚¹ã‚¯

### 5. Discord Webhook URLã®éœ²å‡ºãƒªã‚¹ã‚¯

**ãƒ•ã‚¡ã‚¤ãƒ«**: è¤‡æ•°ã®Discordé–¢é€£Edge Functions

**å•é¡Œ**: Discord Webhook URLã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ãŒã€ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã‚‹å¯èƒ½æ€§

**å¯¾ç­–**: 
- Webhook URLã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã—ãªã„
- Discordç½²åæ¤œè¨¼ã‚’å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å®Ÿè£…

**å½±éŸ¿åº¦**: ğŸŸ¡ Medium  
**å„ªå…ˆåº¦**: ä¸­

---

### 6. Content-Security-Policyæœªè¨­å®š

**ãƒ•ã‚¡ã‚¤ãƒ«**: `vercel.json`

**å•é¡Œ**: CSPãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„ã€‚XSSæ”»æ’ƒã®å½±éŸ¿ã‚’è»½æ¸›ã§ããªã„ã€‚

**å¯¾ç­–**: ä»¥ä¸‹ã‚’è¿½åŠ ï¼ˆReactã‚¢ãƒ—ãƒªã¨ã®äº’æ›æ€§ç¢ºèªãŒå¿…è¦ï¼‰

```json
{
  "key": "Content-Security-Policy",
  "value": "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co"
}
```

**å½±éŸ¿åº¦**: ğŸŸ¡ Medium  
**å„ªå…ˆåº¦**: ä¸­ï¼ˆå‹•ä½œç¢ºèªãŒå¿…è¦ï¼‰

---

## ğŸŸ¢ ä½ãƒªã‚¹ã‚¯ï¼ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰

### 7. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å¤šç”¨

**ä½¿ç”¨ç®‡æ‰€**: 125ç®‡æ‰€ï¼ˆ24ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

**å•é¡Œ**: XSSæ”»æ’ƒæˆåŠŸæ™‚ã«ã™ã¹ã¦ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§

**ç¾çŠ¶**:
- Supabaseèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³: localStorageã«ä¿å­˜ï¼ˆæ¨™æº–çš„ãªæ–¹æ³•ï¼‰
- UIã®çŠ¶æ…‹: localStorageã«ä¿å­˜ï¼ˆå•é¡Œãªã—ï¼‰

**å¯¾ç­–**: æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã¯localStorageã«ä¿å­˜ã—ãªã„ï¼ˆç¾çŠ¶å•é¡Œãªã—ï¼‰

**å½±éŸ¿åº¦**: ğŸŸ¢ Low  
**å„ªå…ˆåº¦**: ä½

---

### 8. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãªã—

**å•é¡Œ**: Supabaseã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ¶é™ã«ä¾å­˜

**æ”»æ’ƒã‚·ãƒŠãƒªã‚ª**:
- ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹
- APIå‘¼ã³å‡ºã—ã®DoS

**å¯¾ç­–**: å°†æ¥çš„ã«æ¤œè¨ï¼ˆSupabase Proãƒ—ãƒ©ãƒ³ã§è¨­å®šå¯èƒ½ï¼‰

**å½±éŸ¿åº¦**: ğŸŸ¢ Low  
**å„ªå…ˆåº¦**: ä½

---

## âœ… è‰¯å¥½ãªå®Ÿè£…

ä»¥ä¸‹ã¯é©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼š

| é …ç›® | çŠ¶æ…‹ |
|------|------|
| XSSå¯¾ç­– | âœ… dangerouslySetInnerHTMLæœªä½¿ç”¨ã€Reactã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ©Ÿèƒ½ã‚’æ´»ç”¨ |
| SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­– | âœ… Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½¿ç”¨ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªï¼‰ |
| èªè¨¼ãƒ­ã‚° | âœ… auth_logsãƒ†ãƒ¼ãƒ–ãƒ«ã§è¨˜éŒ² |
| RLSï¼ˆRow Level Securityï¼‰ | âœ… å…¨27ãƒ†ãƒ¼ãƒ–ãƒ«ã§æœ‰åŠ¹ |
| ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ | âœ… organization_idãƒ•ã‚£ãƒ«ã‚¿å®Ÿè£…ï¼ˆ273ç®‡æ‰€ï¼‰ |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿å­˜ | âœ… Supabase Authã®bcrypt+salt |
| PKCEèªè¨¼ãƒ•ãƒ­ãƒ¼ | âœ… å®Ÿè£…æ¸ˆã¿ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ | âœ… HSTS, X-Frame-Optionsç­‰ |
| SERVICE_ROLE_KEYã®ä¿è­· | âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ã¯éœ²å‡ºã—ã¦ã„ãªã„ |
| ç®¡ç†è€…APIä¿è­· | âœ… delete-user, invite-staffã¯èªè¨¼ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ |

---

## ğŸ“‹ å¯¾å¿œçŠ¶æ³

| å„ªå…ˆåº¦ | é …ç›® | å¯¾å¿œæ™‚é–“ç›®å®‰ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|--------|------|------------|-----------|
| 1ï¸âƒ£ | send-emailèªè¨¼è¿½åŠ  | 30åˆ† | âœ… å®Œäº† |
| 2ï¸âƒ£ | CORSè¨­å®šä¿®æ­£ï¼ˆ18ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ | 1-2æ™‚é–“ | âœ… å®Œäº† |
| 3ï¸âƒ£ | ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç²¾æŸ» | - | ğŸ“‹ çµŒéè¦³å¯Ÿ |
| 4ï¸âƒ£ | CSPè¨­å®šï¼ˆå‹•ä½œç¢ºèªå«ã‚€ï¼‰ | 2æ™‚é–“ | ğŸ• å°†æ¥å¯¾å¿œ |

---

## ğŸ”§ å³åº§ã«å®Ÿè¡Œã™ã¹ãã‚³ãƒãƒ³ãƒ‰

```bash
# 1. send-emailã®èªè¨¼ã‚’ä¿®æ­£
# supabase/functions/send-email/index.ts ã‚’ç·¨é›†

# 2. ä¿®æ­£å¾Œã€ãƒ‡ãƒ—ãƒ­ã‚¤
npx supabase functions deploy send-email --project-ref YOUR_PROJECT_REF
```

---

**æ¬¡å›ç›£æŸ»æ¨å¥¨æ—¥**: 1ãƒ¶æœˆå¾Œï¼ˆã¾ãŸã¯é‡å¤§ãªå¤‰æ›´å¾Œï¼‰

