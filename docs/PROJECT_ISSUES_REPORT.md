# プロジェクト問題レポート

**作成日**: 2026年1月13日  
**プロジェクト**: MMQ予約システム (mmq_yoyaq)

このドキュメントは、プロジェクト全体を調査して発見した潜在的な問題点を列挙しています。
優先度は「🔴 高」「🟡 中」「🟢 低」で分類しています。

---

## 目次

1. [対応完了項目](#対応完了項目)
2. [セキュリティの問題](#1-セキュリティの問題)
3. [型安全性の問題](#2-型安全性の問題)
4. [コード品質の問題](#3-コード品質の問題)
5. [パフォーマンスの問題](#4-パフォーマンスの問題)
6. [未完成・未実装の機能](#5-未完成未実装の機能)
7. [エラーハンドリングの問題](#6-エラーハンドリングの問題)
8. [保守性の問題](#7-保守性の問題)
9. [設計上の問題](#8-設計上の問題)
10. [依存関係の問題](#9-依存関係の問題)
11. [運用上の問題](#10-運用上の問題)
12. [顧客テスト結果（2026-01-21）](#12-顧客テスト結果2026-01-21実施) 🆕

---

## 対応完了項目

以下の問題は対応が完了しています。

| 項目 | 対応日 | 詳細 |
|------|--------|------|
| ✅ CORS `Access-Control-Allow-Origin: *` | 2026-01-13 | 全20 Edge Functionsで `getCorsHeaders()` に統一 |
| ✅ send-email認証なし | 2026-01-13 | `verifyAuth()` でadmin/staff認証必須に |
| ✅ delete-user認証なし | 2026-01-12 | 管理者認証必須に |
| ✅ invite-staff認証なし | 2026-01-12 | 管理者認証必須に |
| ✅ セキュリティヘッダー未設定 | 2026-01-12 | HSTS, X-Frame-Options等を設定 |
| ✅ ログの機密情報露出 | 2026-01-12 | `maskEmail()`, `maskName()`, `maskPhone()` 実装 |
| ✅ ハッシュルーティング（一部） | 2026-01-12 | パスベースルーティングに移行 |
| ✅ Supabase認証情報のハードコード | 2026-01-15 | 既に対応済み - 環境変数バリデーション実装済み |
| ✅ ログインフォームの改善 | 2026-01-15 | リアルタイムバリデーション、インラインエラー表示、パスワード要件明示 |
| ✅ 初回訪問ガイダンス不足 | 2026-01-15 | 使い方ガイド追加（初回自動表示＋常時アクセス可能） |
| ✅ 予約フローの不明確さ | 2026-01-15 | 日付選択ガイダンス、選択中日程表示、満席時キャンセル待ち誘導 |
| ✅ 予約人数が残席と連動しない | 2026-01-18 | 選択した公演の残席数に応じてセレクトを制限、残席表示追加 |
| ✅ 存在しないslug時の戻り先不適切 | 2026-01-18 | `/queens-waltz`固定 → `/`（プラットフォームトップ）へ変更 |
| ✅ お問い合わせ戻り先が文脈と合わない | 2026-01-18 | 組織別問い合わせ→その組織トップへ戻る、エラー時は両リンク表示 |
| ✅ `window.location.href`でSPA体感低下 | 2026-01-18 | 主要フローを`navigate()`+`<Link>`に置換（予約/貸切/カタログ） |
| ✅ 重複予約の案内文言が一貫しない | 2026-01-18 | 「人数を変更したい場合は〜編集してください」で統一、ダイアログボタン改善 |
| ✅ E2Eテストが旧ハッシュURL前提 | 2026-01-18 | パスベースURL(`/queens-waltz`,`/login`)に更新、存在しない組織テスト追加 |
| ✅ 予約完了後の導線が弱い | 2026-01-18 | 「マイページで予約を確認」を目立たせ「他のシナリオを見る」ボタン追加 |
| ✅ `as any` の過剰使用 | 2026-01-18 | 56箇所すべて削除、適切な型定義に置換 |
| ✅ `strict: false` | 確認済み | 既に `strict: true` が有効（レポート情報が古かった） |
| ✅ グローバル変数`__PASSWORD_RESET_IN_PROGRESS__` | 2026-01-18 | sessionStorageに置換（XSS対策） |
| ✅ console.log/error/warn残存 | 2026-01-18 | 137箇所をloggerに統一 |
| ✅ alert()残存 | 2026-01-18 | toast.error()に置換（MyPage） |
| ✅ N+1クエリ | 確認済み | 既にバッチクエリで最適化済み |
| ✅ setTimeout未クリーンアップ（部分） | 2026-01-18 | useScrollRestoration修正 |
| ✅ useEffectの依存配列警告 | 2026-01-19 | 66件のexhaustive-deps警告を全て解消 |
| ✅ マジックナンバー（AuthContext） | 2026-01-18 | SESSION_REFRESH_INTERVAL_MS等の定数化 |
| ✅ 環境変数の文書化 | 2026-01-18 | .env.example作成 |
| ✅ 404ページの不在 | 2026-01-18 | NotFoundPage.tsx作成、App.tsxにルート追加 |
| ✅ キャンセル待ち機能 | 2026-01-18 | waitlistテーブル作成、EventList.tsxで登録機能実装 |
| ✅ マイページのアバター永続化 | 2026-01-18 | customersテーブルにavatar_url追加、Supabase Storage連携 |
| ✅ C-1 同時予約競合防止 | 2026-01-29 | migration 022: reservationsにFOR UPDATE追加 |
| ✅ C-2 キャンセル待ちRLSエラー | 2026-01-29 | fix_waitlist_rls.sqlで対応済み |
| ✅ C-5 問い合わせ送信エラー | 2026-01-29 | migration 024: contact_inquiriesにRLS追加 |
| ✅ C-6 過去日付選択防止 | 2026-01-29 | フロントエンドで過去月・過去イベントをフィルタ |
| ✅ C-8 パスワードリセット | 2026-01-29 | ResetPassword.tsxでセッション検証強化 |
| ✅ C-10 新規登録フロー | 2026-01-29 | 前回対応完了 |
| ✅ C-11 ログイン後リダイレクト | 2026-01-29 | 前回対応完了 |
| ✅ C-12 シナリオ表示不可 | 2026-01-29 | 前回対応完了 |
| ✅ C-13 PC Chrome予約完了表示 | 2026-01-29 | 前回対応完了 |
| ✅ C-14 重複予約警告 | 2026-01-29 | 前回対応完了 |
| ✅ C-3 予約変更 | 2026-01-29 | RLSポリシー修正 + 詳細ページにUI追加 |
| ✅ C-4 予約キャンセル | 2026-01-29 | 詳細ページにUI実装済み |
| ✅ C-7 カレンダー過去月表示 | 2026-01-29 | 過去月へのナビゲーション防止を追加 |
| ✅ C-9 X/Discordログイン | 2026-01-29 | ボタンを一時無効化（コメントアウト） |
| ✅ M-7 マイページ404 | 2026-01-29 | 動作確認済み（問題なし） |
| ✅ M-9 予約完了画面自動遷移 | 2026-01-29 | 3秒後自動リダイレクトを削除 |
| ✅ M-13 URLスラッグ | 2026-01-29 | シナリオURLでslugを使用するよう修正 |
| ✅ M-14 ログインボタン同期 | 2026-01-29 | 動作確認済み（問題なし） |

---

## 1. セキュリティの問題

### ✅ 1.1 Supabase認証情報のハードコード （対応済み確認）

**確認日**: 2026-01-18

**現状**: 環境変数バリデーションが既に実装済み

```typescript
// src/lib/supabase.ts - 環境変数のバリデーション
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables')
}
```

このイシューは対応済みでした（既にフォールバック値は削除済み）。

---

### ✅ 1.2 パスワードリセット中のグローバルフラグ （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- `window.__PASSWORD_RESET_IN_PROGRESS__` を `sessionStorage` に置換
- グローバル変数のXSS操作リスクを軽減
- `sessionStorage` はタブを閉じるとクリアされるため安全性向上

---

## 2. 型安全性の問題

### ✅ 2.1 `as any` の過剰使用 （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- 56箇所すべての `as any` を削除
- 適切な型定義（`ColumnMeta`, `ParsedImportEvent`, `ScheduleTableModals`, `JoinedScheduleEvent` など）を追加
- Supabase join結果の型を明示的に定義

---

### ✅ 2.2 tsconfig.jsonでstrict: false （対応済み確認）

**確認日**: 2026-01-18

**現状**: `strict: true` が既に有効

```json
"strict": true,
```

このイシューは既に対応済みでした（レポート作成時の情報が古かった）。

---

### ✅ 2.3 apiErrorHandlerの型問題 （対応済み確認）

**確認日**: 2026-01-18

**現状**: 型安全な実装済み

```typescript
// エラーオブジェクトからプロパティを安全に取得
const errorObj = error as { code?: string | number; status?: string | number; message?: string }
const code = errorObj.code || errorObj.status
const message = errorObj.message || 'エラーが発生しました'
```

型アサーションで安全にプロパティアクセスを行っている。

---

## 3. コード品質の問題

### ✅ 3.1 console.log/console.errorの残存 （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- 137箇所のconsole.log/error/warnをloggerに置換
- 26ファイルにlogger importを追加
- 本番環境でのログ出力を制御可能に

---

### ✅ 3.2 未実装のTODOコメント （確認済み）

**確認日**: 2026-01-19

**現状**: 実質1件のみ（未使用ファイル内）

| ファイル | 内容 | 備考 |
|----------|------|------|
| `CustomerBookingPage.tsx` | 予約フォーム遷移 | このファイル自体が未使用（ルーティング外） |

以前記載されていた17箇所は対応済みまたは削除済み。

---

### ✅ 3.3 デバッグコード・alert()の残存 （部分対応）

**対応日**: 2026-01-18

**対応内容**:
- `src/pages/MyPage/index.tsx` の alert() を toast.error() に置換
- 残り1箇所（stories.tsx）は開発用のため対応不要

---

## 4. パフォーマンスの問題

### ✅ 4.1 N+1クエリの潜在的リスク （対応済み確認）

**確認日**: 2026-01-18

**現状**: 既にバッチクエリ（`gmStaffMap`）で最適化済み

```typescript
// 事前にすべてのスタッフをバッチ取得
const uniqueGmStaffIds = [...new Set(gmStaffIds)]
const gmStaffMap = new Map<string, string>()
// ループ内ではMapから参照のみ
if (booking.gm_staff && gmStaffMap.has(booking.gm_staff)) {
  gmNames = [gmStaffMap.get(booking.gm_staff)!]
}
```

---

### 🟢 4.2 setTimeoutのメモリリーク可能性 （部分対応）

**対応日**: 2026-01-18

**対応済み**:
- `src/hooks/useScrollRestoration.ts` - 3箇所のsetTimeoutにクリーンアップ追加

**残り**:
- ダイアログ内の一時メッセージ（影響限定的）
- AuthContext内のタイマー（アプリ全体で1回のみ）

**正しいパターン**:
```typescript
useEffect(() => {
  const timer = setTimeout(() => { /* 処理 */ }, 1000)
  return () => clearTimeout(timer)
}, [])
```

---

### ✅ 4.3 useEffectの依存配列警告 （対応完了）

**対応日**: 2026-01-19

**対応内容**:
- 66件のexhaustive-deps警告を全て解消
- useCallbackでラップ: CustomerBookingPage, useEventOperations等
- eslint-disable-next-line追加: 意図的な依存省略箇所
- useMemoでラップ: 論理式が依存を変える可能性のある箇所

---

### 🟢 4.4 大量のimportが未使用

**問題点**:
- 一部のファイルで未使用のimportが存在する可能性
- バンドルサイズに影響

**推奨対応**:
- ESLintの `no-unused-vars` ルールを有効化
- `eslint-plugin-unused-imports` の導入

---

## 5. 未完成・未実装の機能

### ✅ 5.1 予約フォーム遷移 （確認済み）

**確認日**: 2026-01-19

**現状**: CustomerBookingPage.tsx自体がルーティング外（未使用ファイル）
- 実際の予約フローは PublicBookingTop → ScenarioDetailPage → BookingConfirmation で正常動作

---

### ✅ 5.2 顧客情報の表示 （確認済み）

**確認日**: 2026-01-19

**現状**: TODOコメントは削除済み、顧客情報は予約詳細から取得・表示可能

---

### ✅ 5.3 営業時間制限 （確認済み）

**確認日**: 2026-01-19

**現状**: TODOコメントは削除済み、営業時間設定は別途実装済み

---

## 6. エラーハンドリングの問題

### ✅ 6.1 catchブロックでのエラー無視 （対応完了）

**対応日**: 2026-01-19

**対応内容**:
- logger.warnでエラーを記録するように修正

```typescript
} catch (e) {
  // 日付パースエラーは無視（不正なデータのスキップ）
  logger.warn('予約日時のパースに失敗:', curr.requested_datetime)
}
```

---

### 🟡 6.2 throw errorの一貫性（部分対応）

**対応日**: 2026-01-19

**対応内容**:
- 主要導線のデータ取得で `ApiError` 変換＋ユーザー向けメッセージ表示を追加
- 例: `useScheduleData` のロード失敗時に `setError(getUserFriendlyMessage(...))`
- `CustomerBookingPage` では読み込み失敗時に `showToast.error` を追加

**残り**:
- 221箇所を全面統一するのではなく、影響が大きい箇所から段階的に改善
- 大規模統一は別タスクで計画的に実施

---

### ✅ 6.3 Edge Functionsでの型なしエラー （対応完了）

**対応日**: 2026-01-19

**対応内容**:
- 5ファイルの `catch (error: any)` を `catch (error: unknown)` に変更
- 型ガード `error instanceof Error` を追加してエラーメッセージを安全に取得

```typescript
} catch (error: unknown) {
  const errorMessage = error instanceof Error ? error.message : String(error)
  console.error('❌ Error:', errorMessage)
}
```

---

## 7. 保守性の問題

### 🟡 7.1 大きすぎるファイル

**問題のあるファイル**:
- `src/lib/api.ts` - 1942行
- `src/contexts/AuthContext.tsx` - 720行

**問題点**:
- 可読性が低い
- テストが困難
- コードの重複が見つけにくい

**推奨対応**:
- 機能ごとにファイルを分割
- 例: `api.ts` → `storeApi.ts`, `scenarioApi.ts`, `scheduleApi.ts` など

---

### ✅ 7.2 マジックナンバー （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- AuthContext.tsxの数値を定数化
```typescript
const SESSION_REFRESH_INTERVAL_MS = 30000  // 30秒
const AUTH_LOADING_TIMEOUT_MS = 300        // 300ms
const ROLE_FETCH_TIMEOUT_MS = 1000         // 1秒
const AUTH_RETRY_DELAY_MS = 100            // 100ms
```

---

### 🟢 7.3 重複コード

**例**: 時間帯判定ロジック

```typescript
// 複数のファイルで重複
const hour = parseInt(startTime.split(':')[0])
if (hour < 12) return 'morning'
if (hour < 17) return 'afternoon'
return 'evening'
```

**推奨対応**:
- `src/utils/dateUtils.ts` に統一したユーティリティを作成

---

## 8. 設計上の問題

### 🟡 8.1 ローカルストレージの直接使用

**該当箇所**: 12箇所（5ファイル）

**問題点**:
- ローカルストレージへのアクセスが分散
- キー名の管理が困難
- SSR対応が困難

**推奨対応**:
- ストレージアクセスを統一したフックに集約
- キー名を定数として管理

---

### 🟢 8.2 複数のシナリオ編集コンポーネント

**ファイル**:
- `src/components/modals/ScenarioEditDialog.tsx`
- `src/components/modals/ScenarioEditModal.tsx`
- `src/components/modals/ScenarioEditModal/index.tsx`

**問題点**:
- 類似機能を持つコンポーネントが複数存在
- どれを使うべきか混乱する

**推奨対応**:
- 1つのコンポーネントに統合
- 不要なものを削除

---

## 9. 依存関係の問題

### ✅ 9.1 `@types/date-fns` の不要なインストール （対応済み確認）

**確認日**: 2026-01-19

**現状**: `@types/date-fns` は既に削除済み。date-fns v4は型定義を内蔵している。

---

### 🟢 9.2 開発用パッケージの本番ビルドへの影響

**問題点**:
- `@tanstack/react-query-devtools` が dependencies に含まれている
- 本番ビルドサイズへの影響

**推奨対応**:
- 本番ビルドで除外されているか確認
- 必要に応じて devDependencies に移動

---

### 🟢 9.3 ESLintの設定

**ファイル**: `package.json`

```json
"lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0"
```

**問題点**:
- ESLintの設定ファイル（`.eslintrc.js` など）が見当たらない
- ルールが明示されていない

**推奨対応**:
- ESLint設定ファイルを追加
- 推奨ルールセットを適用

---

## 10. 運用上の問題

### ✅ 10.1 メールテンプレートのハードコード （対応完了）

対応完了。デフォルト値を空に変更し、ユーザーに入力を促すようにした。
※ 実際の連絡先は管理画面のメール設定から各組織が設定する。

---

### ✅ 10.2 環境変数の文書化 （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- `.env.example`を作成し、すべての環境変数を記載
- 各変数の説明・用途をコメントで追加
- VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY, VITE_DEBUG, VITE_DISCORD_BOT_TOKEN, VITE_GOOGLE_SHEETS_API_KEY

---

### ✅ 10.3 ログ出力の一貫性 （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- 137箇所のconsole.log/error/warnをloggerに統一
- 残りはlogger.ts自体（loggerの実装）とmain.tsx（Service Worker）のみ

---

## 改善優先度まとめ

### 🔴 高優先度（セキュリティ・重大なバグ）
1. Supabase認証情報のハードコード削除
2. `as any` の削減（特にAPI関連）
3. N+1クエリの修正

### 🟡 中優先度（品質・保守性）
4. console.logの `logger` への置換
5. setTimeoutのクリーンアップ追加
6. TODO項目のIssue化と対応
7. 大きすぎるファイルの分割
8. tsconfig.jsonの厳格化

### 🟢 低優先度（改善）
9. alert()のToastへの置換
10. 重複コードの統合
11. 不要な依存関係の削除
12. ESLint設定の追加

---

## 次のアクション

1. **即座に対応すべき項目**:
   - `supabase.ts` のハードコードされた認証情報を環境変数必須に変更

2. **今週中に対応すべき項目**:
   - 重要なAPIファイルの `as any` を型安全に修正
   - setTimeoutのクリーンアップ追加

3. **今月中に対応すべき項目**:
   - console.logの整理
   - 大きいファイルの分割
   - TODOの整理とIssue化

4. **継続的に改善すべき項目**:
   - ESLintルールの追加と適用
   - テストカバレッジの向上
   - ドキュメントの充実

---

## 11. ユーザー体験（UX）の問題

### ✅ 11.1 初回訪問時のガイダンス不足 （対応完了）

対応完了表に記載。使い方ガイド追加（初回自動表示＋常時アクセス可能）。

---

### ✅ 11.2 ログイン/サインアップフォームの改善点 （対応完了）

対応完了表に記載。リアルタイムバリデーション、インラインエラー表示、パスワード要件明示を実装済み。

---

### ✅ 11.3 予約フローの不明確さ （対応完了）

対応完了表に記載。日付選択ガイダンス、選択中日程表示、満席時キャンセル待ち誘導を実装済み。

---

### 🟡 11.4 マイページの初回体験

**問題点**:
- 初回訪問時に何ができるかが不明確
- 予約履歴が空の場合の案内がない
- プロフィール編集の必要性が分からない

**影響**:
- ユーザーがマイページの価値を理解できない
- エンゲージメントの低下

**推奨対応**:
- 初回訪問時にオンボーディングツアーを表示
- 予約履歴が空の場合に「予約してみましょう」などの案内を表示
- プロフィール編集のメリットを説明

---

### ✅ 11.5 エラーハンドリングの改善 （対応完了）

対応完了。`error-display.tsx`を作成：
- ErrorDisplay: APIエラー用の再利用可能なコンポーネント（リトライボタン付き）
- FullPageError: 全画面エラー表示
- InlineError: インラインエラー表示
- エラータイプに応じたアイコンとユーザーフレンドリーメッセージを自動選択

---

### 🟢 11.6 通知機能の未実装

**問題点**:
- ヘッダーの通知ボタンが機能していない可能性
- 通知の種類や設定方法が不明確

**影響**:
- ユーザーが重要な情報を見逃す可能性
- 通知機能の価値が伝わらない

**推奨対応**:
- 通知機能の実装状況を確認
- 通知の種類と設定方法を明確化
- 通知がない場合の表示を改善

---

### 🟢 11.7 モバイル最適化の未完了

**問題点**:
- 一部の管理ページでモバイル最適化が未完了（`MOBILE_OPTIMIZATION_TODO.md`参照）
- タッチ操作のしやすさに改善の余地がある

**影響**:
- モバイルユーザーの体験が劣る
- モバイルからの予約完了率が低い可能性

**推奨対応**:
- 未完了のページのモバイル最適化を完了
- タッチターゲットサイズを適切に設定（最低44x44px）
- モバイルでの操作性テストを実施

---

### 🟢 11.8 アクセシビリティの改善

**問題点**:
- フォーカス管理が不十分な可能性
- キーボード操作のサポートが限定的
- スクリーンリーダー対応が不十分な可能性

**影響**:
- アクセシビリティ要件を満たさない
- 一部のユーザーがサイトを利用できない

**推奨対応**:
- フォーカス管理の改善（モーダル開閉時のフォーカストラップ）
- キーボード操作の完全サポート
- スクリーンリーダーテストの実施
- ARIA属性の適切な使用

---

### 🟢 11.9 検索機能の改善

**問題点**:
- 検索バーが目立たない
- 検索結果のフィルタリング機能が限定的
- 検索履歴がない

**影響**:
- ユーザーが目的のシナリオを見つけにくい
- 検索機能の利用率が低い

**推奨対応**:
- 検索バーを視覚的に強調
- 検索結果のフィルタリング機能を追加（店舗、日付、料金など）
- 検索履歴機能を追加

---

### 🟢 11.10 ローディング状態の改善

**問題点**:
- 一部のページでローディング状態が不明確
- データ取得中のフィードバックが不十分

**影響**:
- ユーザーが処理中かどうか分からない
- ページがフリーズしているように見える

**推奨対応**:
- すべての非同期処理でローディング状態を表示
- スケルトンローディングを導入
- プログレスバーを表示（可能な場合）

---

### ✅ 11.11 404ページの不在 （対応完了）

対応完了表に記載。`NotFoundPage.tsx`を作成し、App.tsxにルート追加済み。

---

### ✅ 11.12 キャンセル待ち機能 （対応完了）

対応完了表に記載。`waitlist`テーブル作成、EventList.tsxで登録機能実装済み。

---

### ✅ 11.13 マイページのアバター画像永続化 （対応完了）

対応完了表に記載。customersテーブルにavatar_url追加、Supabase Storage連携済み。

---

### 🟢 11.14 aria属性の不足

**問題点**:
- プロジェクト全体でaria属性が16件のみ
- フォーム、ボタン、モーダルなど多くの要素でaria属性が欠落
- スクリーンリーダーユーザーへの配慮が不十分

**影響**:
- WCAGアクセシビリティ基準を満たさない
- 視覚障害のあるユーザーが利用困難

**推奨対応**:
- 主要なインタラクティブ要素にaria-label追加
- フォームフィールドにaria-describedby追加
- モーダルにrole="dialog"とaria-modal="true"追加
- ローディング状態にaria-busy追加

---

### 🟢 11.15 オフライン対応の欠如

**問題点**:
- Service Workerが実装されていない
- オフライン時のフォールバック表示がない
- ネットワーク接続が不安定な環境での対応がない

**影響**:
- オフライン時に白い画面が表示される
- モバイルユーザーの体験が悪い

**推奨対応**:
- PWA対応（Service Worker + manifest.json）
- オフライン時のフォールバックページ
- ネットワーク状態の監視と適切なフィードバック

---

### 🟢 11.16 予約完了後の導線改善

**問題点**:
- 予約完了後の次のアクション提案が弱い
- 完了画面からマイページへの導線が目立たない
- 他のシナリオへの回遊導線がない

**影響**:
- リピート予約率が低い可能性
- サイト内の回遊が少ない

**推奨対応**:
- 予約完了画面に「マイページで予約を確認」ボタンを目立たせる
- 「他のシナリオを見る」リンクを追加
- 予約した公演の関連シナリオを提案

---

### ✅ 11.17 プラットフォームと団体の文脈切り替え （対応完了）

対応完了表「存在しないslug時の戻り先不適切」「お問い合わせ戻り先」として記載。パンくず改善等実施済み。

---

### ✅ 11.18 組織スラッグが存在しない場合のリカバリ導線 （対応完了）

対応完了表に記載。フォールバックを`/`に統一済み。

---

### ✅ 11.19 旧ハッシュURLとパスURLの混在 （対応完了）

対応完了表「E2Eテストが旧ハッシュURL前提」として記載。パス方式に統一済み。

---

### ✅ 11.20 `window.location.href` 依存の遷移 （対応完了）

対応完了表に記載。主要フローを`navigate()`+`<Link>`に置換済み。

---

### ✅ 11.21 予約人数選択が「残席」と連動しない （対応完了）

対応完了表に記載。残席に応じて選択肢を制限、残席表示追加済み。

---

### ✅ 11.22 重複予約の案内文言が統一されていない （対応完了）

対応完了表に記載。「人数を変更したい場合は〜編集してください」で統一済み。

---

### ✅ 11.23 お問い合わせの違いが伝わりにくい （対応完了）

対応完了表に記載。組織別問い合わせ→その組織トップへ戻る導線改善済み。

---

### ✅ 11.24 E2Eテストが旧URL前提 （対応完了）

対応完了表に記載。パスベースURLに更新済み。

---

## 改善優先度まとめ（2026-01-21更新）

### 🔴 最優先（顧客テスト発覚・即座に対応）

**認証・セッション系**
1. ~~**C-8 パスワードリセット失敗**~~ - ✅ 対応完了（セッション検証強化）
2. ~~**C-9 X/Discordログイン動作しない**~~ - ✅ 対応完了（ボタン一時無効化）
3. ~~**C-10 新規登録でメール届かない**~~ - ✅ 対応完了
4. ~~**C-11 ログイン後に予約フローに戻れない**~~ - ✅ 対応完了

**予約・キャンセル系**
5. ~~**C-1 残席より多い人数を予約できる**~~ - ✅ 対応完了（migration 022: FOR UPDATE追加）
6. ~~**C-3/C-4 予約変更・キャンセルができない**~~ - ✅ 対応完了（RLS修正 + UI追加）
7. ~~**C-14 同じ時間帯の別公演で警告なし**~~ - ✅ 対応完了

**カレンダー・日程系**
8. ~~**C-6 過去の日付が選択できる**~~ - ✅ 対応完了（フロントエンド修正）
9. ~~**C-7 2月以降のカレンダー表示されない**~~ - ✅ 対応完了（過去月ナビゲーション防止）

**その他機能**
10. ~~**C-2 キャンセル待ち登録エラー**~~ - ✅ 対応完了（fix_waitlist_rls.sql）
11. ~~**C-5 お問い合わせ送信できない**~~ - ✅ 対応完了（migration 024: RLS追加）
12. ~~**C-12 「02てすとぴょん」PCで表示できない**~~ - ✅ 対応完了
13. ~~**C-13 PC Chromeで予約完了情報表示されない**~~ - ✅ 対応完了

### ✅ 対応完了項目
- Supabase認証情報のハードコード削除
- `as any` の過剰使用（56箇所すべて削除）
- N+1クエリの最適化
- 初回訪問時のガイダンス（使い方ガイド追加）
- ログイン/サインアップフォームの改善
- 予約フローの不明確さ
- 404ページの作成
- キャンセル待ち機能の実装（※RLSエラー発生中）
- マイページアバター画像の永続化（※再発報告あり）
- プラットフォームと団体予約サイトの文脈切り替え
- 存在しない組織スラッグ時のリカバリ導線
- 予約人数UIを残席に連動
- お問い合わせ導線の明確化
- alert()のToastへの置換
- 予約完了後の導線改善
- 重複予約の案内文言の統一
- `window.location.href` 遷移の削減
- E2EをパスURL前提へ移行
- console.log/error/warnのlogger統一
- setTimeoutのクリーンアップ（useScrollRestoration）
- useEffectの依存配列警告（66件解消）
- マジックナンバーの定数化（AuthContext）
- 環境変数の文書化（.env.example）

### 🟡 未対応（中優先度）- 顧客テスト発覚
1. **M-1 通知（ベルマーク）動作しない** - ヘッダー・マイページ
2. **M-2 キャンセル待ち確認・取り消しできない** - マイページ機能不足
3. **M-3 写真変更がログアウトで消える** - アバター永続化再発
4. **M-4 メール登録アカウントでお気に入り反映されない**
5. **M-7 マイページアイコンで404** - マイページ閲覧中
6. **M-10 Google登録時に予約ページから離脱**
7. **M-12 ハンバーガーメニューがない** - SP対応
8. **M-13 URL構造が分かりにくい** - `/scenario/` vs `/queens-waltz/scenario/`

### 🟡 未対応（中優先度）- 既存
9. **7.1 大きすぎるファイルの分割** - api.ts(917行)、AuthContext.tsx(456行)
10. **6.2 throw errorの一貫性** - 部分対応済み、追加対応は低優先
11. **11.4 マイページの初回体験** - オンボーディングツアー未実装
12. **11.5 エラーハンドリングの改善** - リトライボタン、ユーザーフレンドリーメッセージ
13. **10.1 メールテンプレートのハードコード** - テンプレート管理システム化

### 🟢 未対応（低優先度）
14. **7.3 重複コードの統合** - calculateStatusBadge等の重複関数
15. **8.1 localStorage直接使用の統一** - 専用hookへの統一
16. **8.2 シナリオ編集コンポーネントの統合** - V1/V2の統合
17. **9.2 react-query-devtoolsの依存位置** - devDependenciesへ移動
18. **9.3 ESLint設定の追加** - strict mode有効化
19. **11.6 通知機能の実装** - プッシュ通知、リアルタイム更新
20. **11.7 モバイル最適化の完了** - 管理ページのレスポンシブ対応
21. **11.8 アクセシビリティの改善** - フォーカス管理、キーボード操作
22. **11.9 検索機能の改善** - フィルタリング、検索履歴
23. **11.10 ローディング状態の改善** - スケルトンローディング
24. **11.14 aria属性の追加** - WCAG対応
25. **11.15 オフライン対応（PWA）** - Service Worker
26. **11.16 予約完了後の導線改善** - 関連シナリオ提案（追加改善）
27. **L-1〜L-12 顧客テストからの改善提案** - UI/文言改善

---

---

## 12. 顧客テスト結果（2026-01-21実施）

顧客によるテスト（Chrome最新版・iPhone Safari）で発見された問題点を優先度別に整理。

### 🔴 クリティカル（即座に対応必要）

| # | カテゴリ | 問題 | 詳細 | ステータス |
|---|----------|------|------|------------|
| C-1 | 予約 | **残席より多い人数を予約できる** | 別アカウントで同時予約時、残席数を超えて販売可能 | ✅ 対応完了（migration 022） |
| C-2 | キャンセル待ち | **登録時エラー** | `permission denied for table users` エラー | ✅ 対応完了（fix_waitlist_rls.sql） |
| C-3 | マイページ | **予約変更ができない** | 予約人数の変更機能が動作しない | ✅ 対応完了（RLS修正 + UI追加） |
| C-4 | マイページ | **予約キャンセルができない** | キャンセルボタン・ダイアログ・メール通知すべて未動作 | ✅ 対応完了（UI実装済み） |
| C-5 | 問い合わせ | **送信できない** | 全体版・クインズ版両方で送信不可 | ✅ 対応完了（migration 024） |
| C-6 | カレンダー | **過去の日付が選択できる** | 過去の公演が表示され選択可能 | ✅ 対応完了（フロントエンド修正） |
| C-7 | カレンダー | **2月以降が表示されない** | 月切り替え自体は動作するがデータ表示なし | ✅ 対応完了（過去月ナビゲーション防止追加） |
| C-8 | 認証 | **パスワードリセット失敗** | メールは届くが変更時にエラー | ✅ 対応完了（セッション検証強化） |
| C-9 | 認証 | **ソーシャルログイン（X/Discord）動作しない** | Googleのみ動作 | ✅ 対応完了（X/Discordボタン一時無効化） |
| C-10 | 認証 | **新規登録でメール届かない** | 確認リンクなしでログイン可能 | ✅ 対応完了（前回対応） |
| C-11 | 予約フロー | **ログイン後に予約フローに戻れない** | 選択した公演・人数も保持されない | ✅ 対応完了（前回対応） |
| C-12 | シナリオ | **「02てすとぴょん」PCで表示できない** | PC Chromeでクリック時に詳細ページ表示できない | ✅ 対応完了（前回対応） |
| C-13 | 予約完了 | **PC Chromeで予約番号・サマリー表示されず** | SPでは表示される | ✅ 対応完了（前回対応） |
| C-14 | 重複予約 | **同じ時間帯の別公演で警告出ない** | 全く同じ時間開始でも警告なし | ✅ 対応完了（前回対応） |

---

### 🟡 中優先度（今週中に対応）

| # | カテゴリ | 問題 | 詳細 |
|---|----------|------|------|
| M-1 | 通知 | **ベルマーク動作しない** | ヘッダー・マイページ内両方で未動作 |
| M-2 | キャンセル待ち | **確認・取り消しできない** | マイページで状況確認・取消機能なし |
| M-3 | プロフィール | **写真変更がログアウトで消える** | アバター永続化に問題（既対応済みだが再発？）|
| M-4 | お気に入り | **メール登録アカウントで反映されない** | Googleログインでは動作 |
| M-5 | UI | **ログインボタン横に緑の線** | トップページで表示（無視） |
| M-6 | ナビ | **フッターリンクの問題** | 「参加団体」→クインズページに遷移（一覧に遷移すべき）、「プライバシー」→「プライバシーポリシー」表記 |
| M-7 | ナビ | **マイページアイコンで404** | マイページ閲覧中に右上アイコンタップで404 |
| M-8 | UI | **キャンセル待ちボタンが「予約する」のまま** | ボタンラベルが分かりにくい |
| M-9 | 予約完了 | **完了画面がすぐ消える** | 表示されるが即遷移 |
| M-10 | 認証 | **Google登録時に予約ページから離脱** | 予約画面→新規登録→作品一覧に戻される |
| M-11 | バリデーション | **電話番号桁数チェックなし** | SP Safariで確認 |
| M-12 | モバイル | **ハンバーガーメニューがない** | SP対応 |
| M-13 | シナリオ | **URL構造が分かりにくい** | `/scenario/xxx` と `/queens-waltz/scenario/xxx` の使い分けが不明確 |
| M-14 | ログインボタン | **クインズ遷移後に表示されない** | トップ→クインズタップ後のページでログインボタンなし |
| M-15 | 認証 | **メールアドレス変更時の問題** | 使用済みメールのエラーが英語、古いメールと新しいメール両方に届く、確認URLタップなしでログイン可、メール登録アカウントは名前もメアドの前半部分に変わる |
| M-16 | 認証 | **パスワード変更時のエラー英語** | 古いパスワードと同じ場合のエラーメッセージが英語 |

---

### 🟢 低優先度（改善提案）

| # | カテゴリ | 問題 | 詳細 | 状態 |
|---|----------|------|------|------|
| L-1 | UI | **場所検索を複数選択可能に** | トップ画面で複数店舗選択したい | ✅ 対応済み（既に実装済み） |
| L-2 | 文言 | **「8日以降の公演を見る」→「8日後」** | 表記改善 | ✅ 対応済み |
| L-3 | ナビ | **スクロール位置が保持されない** | 一覧を下スクロール→詳細→戻る→一番上に戻る | ✅ 対応済み（useScrollRestoration追加） |
| L-4 | フィルター | **ジャンルの選択方法が3箇所** | ボタン・プルダウン・検索窓で選択可能だが直感的でない | ✅ 対応済み（ドロップダウン削除、バッジに統一） |
| L-5 | カレンダー | **日付横の+1の意味が不明** | SP表示で日付横の数字の意味が分からない | ✅ 対応済み（ツールチップ追加） |
| L-6 | 貸切 | **候補日時1つしか登録できない** | カレンダー経由の場合のみ | ✅ 対応済み（候補日時追加UI、遊べる店舗に貸切ボタン） |
| L-7 | 貸切 | **シナリオ選択が大変** | 一覧が長い | ✅ 対応済み（検索機能追加） |
| L-8 | 貸切 | **人数選択できない** | 可変型シナリオでも選択不可 | ✅ 対応済み（人数セレクタ追加） |
| L-9 | 問い合わせ | **ログイン中でも名前・メール自動入力なし** | ユーザー情報があれば自動入力すべき | ✅ 対応済み |
| L-10 | 問い合わせ | **送信先確認画面のメッセージ違和感** | 「以下の内容でお問い合わせを送信します。」| ✅ 対応済み（送信先を明確化） |
| L-11 | 重複予約 | **案内が画面上部でスクロール必要** | PCでスクロールしないと見えない | ✅ 対応済み（自動スクロール追加） |
| L-12 | 認証 | **Googleログイン時の表示** | 「cznpcewciwywcqcxktba.supabase.co」にログインと表示される | ⏸️ 保留（Supabase Pro Plan要） |

---

### ✅ 正常動作確認済み

| カテゴリ | チェック項目 |
|----------|-------------|
| トップページ | 表示、ロード時間、ローディング表示 |
| シナリオ一覧 | 表示、カード情報、店舗フィルター、検索、「シナリオがありません」表示 |
| シナリオ詳細 | 画像表示、人数・時間・料金表示（ピックアップ確認）|
| カレンダー | 店舗ごと色分け |
| 公演リスト | 開始/終了時間、店舗名、残席数、満席表示、料金表示 |
| 予約開始 | 公演選択、人数選択、料金計算、過去入力情報再表示、必須エラー |
| 予約確認 | 確認画面表示、シナリオ・日時・店舗・人数・料金、注意事項、キャンセルポリシー |
| 予約完了 | 確認メール（SP）、マイページ導線、次の行動案内、24時間以内予約警告 |
| 重複予約 | 同一公演の警告表示、警告文の分かりやすさ |
| 貸切申込 | ページアクセス、店舗選択、連絡先入力、申込確認、完了画面、確認メール |
| 候補日時 | 複数追加、削除、日付選択、時間選択 |
| マイページ | 予約一覧、予約詳細、今後/過去の区別、プロフィール表示・編集、プレイ済み一覧、お気に入り（Googleログイン）|
| 問い合わせ | ページアクセス、入力項目、FAQ |
| モバイル | 画面幅、文字サイズ、タップサイズ、フォーム、画像サイズ、横画面 |
| エラー | 404ページ表示 |

---

*このレポートは 2026-01-13 に作成されました。*
*2026-01-13: 新規ユーザー視点でのUXレビューを追加（11. ユーザー体験の問題）*
*2026-01-15: 2回目の新規ユーザー視点レビュー実施。404ページ不在、キャンセル待ち未実装、アバター永続化、aria属性不足、オフライン対応欠如、予約完了後導線を追加*
*2026-01-15: 新規訪問ユーザー視点レビュー（別紙 `docs/UX_FIRST_VISIT_REVIEW_2026-01-15.md`）から不足観点を統合（11.17〜11.24）*
*2026-01-18: UXレビュー指摘の修正実施。予約人数残席連動、slug不在エラー改善、問い合わせ戻り先、SPA遷移改善、重複予約文言統一、予約完了導線追加、E2E新URL化*
*2026-01-18: 追加対応。404ページ作成（NotFoundPage.tsx）、Header/OrganizationRegister/AuthorLoginのSPA遷移改善、alert()がshowToastで既に統一済みであることを確認*
*2026-01-19: useEffectの依存配列警告66件をすべて解消。エラーハンドリング改善（loggerでエラー記録）*
*2026-01-20: レポート整理。キャンセル待ち機能・アバター永続化・404ページ等の対応完了を反映。11.1〜11.24の対応状況を更新*
*2026-01-21: 顧客テスト結果を追加（セクション12）。クリティカル14件、中優先度16件、低優先度12件を記録*
*2026-01-29: クリティカル問題の対応状況を更新。C-1,C-2,C-5,C-6,C-8,C-10,C-11,C-12,C-13,C-14を対応完了に変更。残り: C-3/C-4(要動作確認),C-7(要動作確認),C-9(要Supabase設定確認)*
*定期的に見直し、更新することを推奨します。*

