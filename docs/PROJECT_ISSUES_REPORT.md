# プロジェクト問題レポート

**作成日**: 2026年1月13日  
**プロジェクト**: MMQ予約システム (mmq_yoyaq)

このドキュメントは、プロジェクト全体を調査して発見した潜在的な問題点を列挙しています。
優先度は「🔴 高」「🟡 中」「🟢 低」で分類しています。

---

## 目次

1. [対応完了項目](#対応完了項目)
2. [セキュリティの問題](#1-セキュリティの問題)
3. [型安全性の問題](#2-型安全性の問題)
4. [コード品質の問題](#3-コード品質の問題)
5. [パフォーマンスの問題](#4-パフォーマンスの問題)
6. [未完成・未実装の機能](#5-未完成未実装の機能)
7. [エラーハンドリングの問題](#6-エラーハンドリングの問題)
8. [保守性の問題](#7-保守性の問題)
9. [設計上の問題](#8-設計上の問題)
10. [依存関係の問題](#9-依存関係の問題)
11. [運用上の問題](#10-運用上の問題)

---

## 対応完了項目

以下の問題は対応が完了しています。

| 項目 | 対応日 | 詳細 |
|------|--------|------|
| ✅ CORS `Access-Control-Allow-Origin: *` | 2026-01-13 | 全20 Edge Functionsで `getCorsHeaders()` に統一 |
| ✅ send-email認証なし | 2026-01-13 | `verifyAuth()` でadmin/staff認証必須に |
| ✅ delete-user認証なし | 2026-01-12 | 管理者認証必須に |
| ✅ invite-staff認証なし | 2026-01-12 | 管理者認証必須に |
| ✅ セキュリティヘッダー未設定 | 2026-01-12 | HSTS, X-Frame-Options等を設定 |
| ✅ ログの機密情報露出 | 2026-01-12 | `maskEmail()`, `maskName()`, `maskPhone()` 実装 |
| ✅ ハッシュルーティング（一部） | 2026-01-12 | パスベースルーティングに移行 |
| ✅ Supabase認証情報のハードコード | 2026-01-15 | 既に対応済み - 環境変数バリデーション実装済み |
| ✅ ログインフォームの改善 | 2026-01-15 | リアルタイムバリデーション、インラインエラー表示、パスワード要件明示 |
| ✅ 初回訪問ガイダンス不足 | 2026-01-15 | 使い方ガイド追加（初回自動表示＋常時アクセス可能） |
| ✅ 予約フローの不明確さ | 2026-01-15 | 日付選択ガイダンス、選択中日程表示、満席時キャンセル待ち誘導 |
| ✅ 予約人数が残席と連動しない | 2026-01-18 | 選択した公演の残席数に応じてセレクトを制限、残席表示追加 |
| ✅ 存在しないslug時の戻り先不適切 | 2026-01-18 | `/queens-waltz`固定 → `/`（プラットフォームトップ）へ変更 |
| ✅ お問い合わせ戻り先が文脈と合わない | 2026-01-18 | 組織別問い合わせ→その組織トップへ戻る、エラー時は両リンク表示 |
| ✅ `window.location.href`でSPA体感低下 | 2026-01-18 | 主要フローを`navigate()`+`<Link>`に置換（予約/貸切/カタログ） |
| ✅ 重複予約の案内文言が一貫しない | 2026-01-18 | 「人数を変更したい場合は〜編集してください」で統一、ダイアログボタン改善 |
| ✅ E2Eテストが旧ハッシュURL前提 | 2026-01-18 | パスベースURL(`/queens-waltz`,`/login`)に更新、存在しない組織テスト追加 |
| ✅ 予約完了後の導線が弱い | 2026-01-18 | 「マイページで予約を確認」を目立たせ「他のシナリオを見る」ボタン追加 |
| ✅ `as any` の過剰使用 | 2026-01-18 | 56箇所すべて削除、適切な型定義に置換 |
| ✅ `strict: false` | 確認済み | 既に `strict: true` が有効（レポート情報が古かった） |
| ✅ グローバル変数`__PASSWORD_RESET_IN_PROGRESS__` | 2026-01-18 | sessionStorageに置換（XSS対策） |
| ✅ console.log/error/warn残存 | 2026-01-18 | 137箇所をloggerに統一 |
| ✅ alert()残存 | 2026-01-18 | toast.error()に置換（MyPage） |
| ✅ N+1クエリ | 確認済み | 既にバッチクエリで最適化済み |
| ✅ setTimeout未クリーンアップ（部分） | 2026-01-18 | useScrollRestoration修正 |
| ✅ 予約フォーム遷移未実装 | 2026-01-18 | CustomerBookingPageでシナリオ詳細へ遷移 |
| ✅ 顧客情報表示 | 確認済み | 既に実装済み（レポート情報が古かった） |
| ✅ 営業時間制限 | 確認済み | 既に実装済み（レポート情報が古かった） |
| ✅ catchでのエラー無視 | 確認済み | 既に修正済み（レポート情報が古かった） |
| ✅ apiErrorHandlerの型問題 | 確認済み | 既に型定義で対応済み |
| ✅ Edge Functionsの型なしエラー | 確認済み | 既に修正済み |
| ✅ 未使用import（部分） | 2026-01-18 | 主要ファイルの未使用import削除 |
| ✅ Supabase認証情報のハードコード | 確認済み | 既に対応済み（フォールバック削除、エラー表示実装） |
| ✅ @types/date-fns不要 | 確認済み | 既に削除済み（date-fns v4は型内蔵） |
| ✅ 環境変数の文書化 | 2026-01-18 | .env.example作成 |

---

## 1. セキュリティの問題

### ✅ 1.1 Supabase認証情報のハードコード （対応完了）

**確認日**: 2026-01-18

**対応内容**:
- 確認済み：フォールバック値は既に削除されている
- 環境変数が未設定の場合はエラーをスロー
- 日本語で明確なエラーメッセージを表示

---

### ✅ 1.2 パスワードリセット中のグローバルフラグ （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- `window.__PASSWORD_RESET_IN_PROGRESS__` を `sessionStorage` に置換
- グローバル変数のXSS操作リスクを軽減
- `sessionStorage` はタブを閉じるとクリアされるため安全性向上

---

## 2. 型安全性の問題

### ✅ 2.1 `as any` の過剰使用 （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- 56箇所すべての `as any` を削除
- 適切な型定義（`ColumnMeta`, `ParsedImportEvent`, `ScheduleTableModals`, `JoinedScheduleEvent` など）を追加
- Supabase join結果の型を明示的に定義

---

### ✅ 2.2 tsconfig.jsonでstrict: false （対応済み確認）

**確認日**: 2026-01-18

**現状**: `strict: true` が既に有効

```json
"strict": true,
```

このイシューは既に対応済みでした（レポート作成時の情報が古かった）。

---

### ✅ 2.3 apiErrorHandlerの型問題 （対応完了）

**確認日**: 2026-01-18

**対応内容**:
- 確認済み：65行目で `const errorObj = error as { code?: string | number; status?: string | number; message?: string }` として安全に型定義されている

---

## 3. コード品質の問題

### ✅ 3.1 console.log/console.errorの残存 （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- 137箇所のconsole.log/error/warnをloggerに置換
- 26ファイルにlogger importを追加
- 本番環境でのログ出力を制御可能に

---

### ✅ 3.2 未実装のTODOコメント （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- CustomerBookingPageの予約ボタンを実装（シナリオ詳細ページへ遷移）
- その他のTODOは既に対応済み（レポート情報が古かった）

---

### ✅ 3.3 デバッグコード・alert()の残存 （部分対応）

**対応日**: 2026-01-18

**対応内容**:
- `src/pages/MyPage/index.tsx` の alert() を toast.error() に置換
- 残り1箇所（stories.tsx）は開発用のため対応不要

---

## 4. パフォーマンスの問題

### ✅ 4.1 N+1クエリの潜在的リスク （対応済み確認）

**確認日**: 2026-01-18

**現状**: 既にバッチクエリ（`gmStaffMap`）で最適化済み

```typescript
// 事前にすべてのスタッフをバッチ取得
const uniqueGmStaffIds = [...new Set(gmStaffIds)]
const gmStaffMap = new Map<string, string>()
// ループ内ではMapから参照のみ
if (booking.gm_staff && gmStaffMap.has(booking.gm_staff)) {
  gmNames = [gmStaffMap.get(booking.gm_staff)!]
}
```

---

### 🟢 4.2 setTimeoutのメモリリーク可能性 （部分対応）

**対応日**: 2026-01-18

**対応済み**:
- `src/hooks/useScrollRestoration.ts` - 3箇所のsetTimeoutにクリーンアップ追加

**残り**:
- ダイアログ内の一時メッセージ（影響限定的）
- AuthContext内のタイマー（アプリ全体で1回のみ）

**正しいパターン**:
```typescript
useEffect(() => {
  const timer = setTimeout(() => { /* 処理 */ }, 1000)
  return () => clearTimeout(timer)
}, [])
```

---

### 🟡 4.3 useEffectの過剰使用

**該当箇所**: 276箇所（108ファイル）

**問題点**:
- 一部のuseEffectは不要な再レンダリングを引き起こす可能性
- 依存配列の管理が複雑になりやすい

**推奨対応**:
- 可能な場合はuseMemoやuseCallbackで代替
- useEffectの依存配列を見直し

---

### ✅ 4.4 未使用import （部分対応）

**対応日**: 2026-01-18

**対応内容**:
- 主要ファイルの未使用importを削除（App.tsx, Footer.tsx, Header.tsx, MasterSelectDialog.tsx等）
- 残りはESLintで自動修正可能

---

## 5. 未完成・未実装の機能

### ✅ 5.1 予約フォーム遷移 （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- CustomerBookingPageの予約ボタンをシナリオ詳細ページへの遷移に実装

---

### ✅ 5.2 顧客情報の表示 （対応完了）

**確認日**: 2026-01-18

**対応内容**:
- 確認済み：顧客情報（名前、メール、電話番号）は既に実装済み

---

### ✅ 5.3 営業時間制限 （対応完了）

**確認日**: 2026-01-18

**対応内容**:
- 確認済み：TODOコメントは削除済み、営業時間制限は実装済み

---

## 6. エラーハンドリングの問題

### ✅ 6.1 catchブロックでのエラー無視 （対応完了）

**確認日**: 2026-01-18

**対応内容**:
- 確認済み：該当コードは既に修正済み（レポート情報が古かった）
- デバッグが困難になる

**推奨対応**:
- 最低限loggerでエラーを記録
- 必要に応じてユーザーへの通知

---

### 🟡 6.2 throw errorの一貫性

**該当箇所**: 221箇所

**問題点**:
- 一部でエラーをthrowし、一部でnullを返している
- 呼び出し側でのエラーハンドリングが複雑になる

**推奨対応**:
- 統一したエラーハンドリング戦略を策定
- `ApiError` クラスを一貫して使用

---

### ✅ 6.3 Edge Functionsでの型なしエラー （対応完了）

**確認日**: 2026-01-18

**対応内容**:
- 確認済み：`catch (error: any)` は既に修正済み（レポート情報が古かった）

---

## 7. 保守性の問題

### 🟡 7.1 大きすぎるファイル

**問題のあるファイル**:
- `src/lib/api.ts` - 1942行
- `src/contexts/AuthContext.tsx` - 720行

**問題点**:
- 可読性が低い
- テストが困難
- コードの重複が見つけにくい

**推奨対応**:
- 機能ごとにファイルを分割
- 例: `api.ts` → `storeApi.ts`, `scenarioApi.ts`, `scheduleApi.ts` など

---

### 🟡 7.2 マジックナンバー

**例**:
```typescript
// src/contexts/AuthContext.tsx (56行目)
if (now - lastRefreshRef.current < 30000) {

// src/contexts/AuthContext.tsx (91行目)
const loadingTimeout = setTimeout(() => { ... }, 300)

// src/contexts/AuthContext.tsx (298行目)
const timeoutMs = 1000
```

**問題点**:
- 数値の意味が分かりにくい
- 変更時に漏れが発生しやすい

**推奨対応**:
- 定数として定義
```typescript
const SESSION_REFRESH_INTERVAL_MS = 30000
const AUTH_LOADING_TIMEOUT_MS = 300
const ROLE_FETCH_TIMEOUT_MS = 1000
```

---

### 🟢 7.3 重複コード

**例**: 時間帯判定ロジック

```typescript
// 複数のファイルで重複
const hour = parseInt(startTime.split(':')[0])
if (hour < 12) return 'morning'
if (hour < 17) return 'afternoon'
return 'evening'
```

**推奨対応**:
- `src/utils/dateUtils.ts` に統一したユーティリティを作成

---

## 8. 設計上の問題

### 🟡 8.1 ローカルストレージの直接使用

**該当箇所**: 12箇所（5ファイル）

**問題点**:
- ローカルストレージへのアクセスが分散
- キー名の管理が困難
- SSR対応が困難

**推奨対応**:
- ストレージアクセスを統一したフックに集約
- キー名を定数として管理

---

### 🟢 8.2 複数のシナリオ編集コンポーネント

**ファイル**:
- `src/components/modals/ScenarioEditDialog.tsx`
- `src/components/modals/ScenarioEditModal.tsx`
- `src/components/modals/ScenarioEditModal/index.tsx`

**問題点**:
- 類似機能を持つコンポーネントが複数存在
- どれを使うべきか混乱する

**推奨対応**:
- 1つのコンポーネントに統合
- 不要なものを削除

---

## 9. 依存関係の問題

### ✅ 9.1 `@types/date-fns` の不要なインストール （対応完了）

**確認日**: 2026-01-18

**対応内容**:
- 確認済み：既に削除されている（date-fns v4は型定義を内蔵）

---

### 🟢 9.2 開発用パッケージの本番ビルドへの影響

**問題点**:
- `@tanstack/react-query-devtools` が dependencies に含まれている
- 本番ビルドサイズへの影響

**推奨対応**:
- 本番ビルドで除外されているか確認
- 必要に応じて devDependencies に移動

---

### 🟢 9.3 ESLintの設定

**ファイル**: `package.json`

```json
"lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0"
```

**問題点**:
- ESLintの設定ファイル（`.eslintrc.js` など）が見当たらない
- ルールが明示されていない

**推奨対応**:
- ESLint設定ファイルを追加
- 推奨ルールセットを適用

---

## 10. 運用上の問題

### 🟡 10.1 メールテンプレートのハードコード

**ファイル**: `src/pages/Settings/pages/EmailSettings.tsx` (162-164行目)

```typescript
company_name: 'クイーンズワルツ',
company_phone: '03-XXXX-XXXX',
company_email: 'info@queens-waltz.jp',
```

**問題点**:
- 電話番号がプレースホルダーのまま
- 実際の連絡先が設定されていない可能性

**推奨対応**:
- 正しい連絡先情報を設定
- 環境変数から取得するように変更

---

### ✅ 10.2 環境変数の文書化 （対応完了）

**対応日**: 2026-01-18

**対応内容**:
- `.env.example` を作成
- 必須のSupabase設定を記載
- 開発オプション（VITE_DEBUG）を記載
- セットアップ手順をコメントで記載

---

### 🟢 10.3 ログ出力の一貫性

**問題点**:
- `console.log` と `logger.log` が混在
- ログレベル（info, warn, error）の使い分けが不統一

**推奨対応**:
- すべてのログを `logger` ユーティリティ経由に統一

---

## 改善優先度まとめ

### 🔴 高優先度（セキュリティ・重大なバグ）
1. Supabase認証情報のハードコード削除
2. `as any` の削減（特にAPI関連）
3. N+1クエリの修正

### 🟡 中優先度（品質・保守性）
4. console.logの `logger` への置換
5. setTimeoutのクリーンアップ追加
6. TODO項目のIssue化と対応
7. 大きすぎるファイルの分割
8. tsconfig.jsonの厳格化

### 🟢 低優先度（改善）
9. alert()のToastへの置換
10. 重複コードの統合
11. 不要な依存関係の削除
12. ESLint設定の追加

---

## 次のアクション

1. **即座に対応すべき項目**:
   - `supabase.ts` のハードコードされた認証情報を環境変数必須に変更

2. **今週中に対応すべき項目**:
   - 重要なAPIファイルの `as any` を型安全に修正
   - setTimeoutのクリーンアップ追加

3. **今月中に対応すべき項目**:
   - console.logの整理
   - 大きいファイルの分割
   - TODOの整理とIssue化

4. **継続的に改善すべき項目**:
   - ESLintルールの追加と適用
   - テストカバレッジの向上
   - ドキュメントの充実

---

## 11. ユーザー体験（UX）の問題

### 🔴 11.1 初回訪問時のガイダンス不足

**問題点**:
- 予約サイトトップに「初めての方へ」や「使い方」の案内がない
- 新規ユーザーがどのように予約するかが不明確
- 予約フローの説明がない

**影響**:
- 初回訪問者の離脱率が高い可能性
- 予約完了率の低下

**推奨対応**:
- 予約サイトトップに「初めての方へ」セクションを追加
- 予約フローのステップバイステップガイドを追加
- よくある質問（FAQ）セクションを追加

---

### 🟡 11.2 ログイン/サインアップフォームの改善点

**問題点**:
- パスワード要件（6文字以上）が入力前に明示されていない
- エラーメッセージがフォームの上部に表示され、入力フィールドと離れている
- メールアドレスの形式チェックがリアルタイムで行われていない

**影響**:
- ユーザーが何度も入力し直す必要がある
- エラー原因が分かりにくい

**推奨対応**:
- パスワード入力欄の下に要件を明示（例: 「6文字以上で入力してください」）
- エラーメッセージを該当フィールドの下に表示
- メールアドレスの形式チェックをリアルタイムで実行

---

### 🟡 11.3 予約フローの不明確さ

**問題点**:
- シナリオ詳細ページで「予約確認へ進む」ボタンが無効化されている理由が不明確
- 「日付を選択してください」というメッセージがボタン内に表示されるが、どこで選択するかが分かりにくい
- 満席時のキャンセル待ち機能が初見では気づきにくい

**影響**:
- ユーザーが予約できない理由が分からない
- キャンセル待ち機能の利用率が低い

**推奨対応**:
- 日付選択エリアを視覚的に強調
- ボタンが無効化されている理由を明確に表示（例: 「日付を選択すると予約できます」）
- 満席時にキャンセル待ち機能を目立つように表示

---

### 🟡 11.4 マイページの初回体験

**問題点**:
- 初回訪問時に何ができるかが不明確
- 予約履歴が空の場合の案内がない
- プロフィール編集の必要性が分からない

**影響**:
- ユーザーがマイページの価値を理解できない
- エンゲージメントの低下

**推奨対応**:
- 初回訪問時にオンボーディングツアーを表示
- 予約履歴が空の場合に「予約してみましょう」などの案内を表示
- プロフィール編集のメリットを説明

---

### 🟡 11.5 エラーハンドリングの改善

**問題点**:
- ネットワークエラー時のリトライボタンがない
- 一部のエラーメッセージが技術的すぎる（例: "PGRST301"）
- エラー発生時の次のアクションが不明確

**影響**:
- ユーザーがエラーから回復できない
- サポートへの問い合わせが増える

**推奨対応**:
- ネットワークエラー時にリトライボタンを表示
- エラーメッセージをユーザーフレンドリーな表現に統一
- エラー発生時の推奨アクションを表示（例: 「ページを再読み込みしてください」）

---

### 🟢 11.6 通知機能の未実装

**問題点**:
- ヘッダーの通知ボタンが機能していない可能性
- 通知の種類や設定方法が不明確

**影響**:
- ユーザーが重要な情報を見逃す可能性
- 通知機能の価値が伝わらない

**推奨対応**:
- 通知機能の実装状況を確認
- 通知の種類と設定方法を明確化
- 通知がない場合の表示を改善

---

### 🟢 11.7 モバイル最適化の未完了

**問題点**:
- 一部の管理ページでモバイル最適化が未完了（`MOBILE_OPTIMIZATION_TODO.md`参照）
- タッチ操作のしやすさに改善の余地がある

**影響**:
- モバイルユーザーの体験が劣る
- モバイルからの予約完了率が低い可能性

**推奨対応**:
- 未完了のページのモバイル最適化を完了
- タッチターゲットサイズを適切に設定（最低44x44px）
- モバイルでの操作性テストを実施

---

### 🟢 11.8 アクセシビリティの改善

**問題点**:
- フォーカス管理が不十分な可能性
- キーボード操作のサポートが限定的
- スクリーンリーダー対応が不十分な可能性

**影響**:
- アクセシビリティ要件を満たさない
- 一部のユーザーがサイトを利用できない

**推奨対応**:
- フォーカス管理の改善（モーダル開閉時のフォーカストラップ）
- キーボード操作の完全サポート
- スクリーンリーダーテストの実施
- ARIA属性の適切な使用

---

### 🟢 11.9 検索機能の改善

**問題点**:
- 検索バーが目立たない
- 検索結果のフィルタリング機能が限定的
- 検索履歴がない

**影響**:
- ユーザーが目的のシナリオを見つけにくい
- 検索機能の利用率が低い

**推奨対応**:
- 検索バーを視覚的に強調
- 検索結果のフィルタリング機能を追加（店舗、日付、料金など）
- 検索履歴機能を追加

---

### 🟢 11.10 ローディング状態の改善

**問題点**:
- 一部のページでローディング状態が不明確
- データ取得中のフィードバックが不十分

**影響**:
- ユーザーが処理中かどうか分からない
- ページがフリーズしているように見える

**推奨対応**:
- すべての非同期処理でローディング状態を表示
- スケルトンローディングを導入
- プログレスバーを表示（可能な場合）

---

### 🟡 11.11 404ページの不在

**問題点**:
- 一般的な404エラーページが存在しない
- 組織が見つからない場合のエラー表示は存在するが、他のケース（存在しないURLなど）での404表示がない
- 不正なURLにアクセスした場合、何も表示されない可能性

**影響**:
- ユーザーが迷子になる
- SEO上の問題

**推奨対応**:
- 汎用の404ページを作成
- 適切な導線（トップページへのリンク、検索機能など）を提供
- robots.txtやサイトマップの整備

---

### 🟡 11.12 キャンセル待ち機能の未実装

**ファイル**: `src/pages/ScenarioDetailPage/components/EventList.tsx`

**問題点**:
- 満席時に「キャンセル待ち」ボタンが表示されるが、機能が未実装
- クリックするとalertが表示されるのみ

**影響**:
- ユーザーの期待を裏切る
- 満席シナリオへの予約機会を逃す

**推奨対応**:
- キャンセル待ち登録機能を実装
- 空きが出た際のメール通知機能を追加
- または、未実装であることを明示（ボタンを非表示にするなど）

---

### 🟡 11.13 マイページのアバター画像永続化

**ファイル**: `src/pages/MyPage/index.tsx`

**問題点**:
- アバター画像の選択機能があるが、`useState`のみで永続化されていない
- ページをリロードすると画像がリセットされる

**影響**:
- ユーザーがアバターを設定しても反映されない
- 機能が壊れているように見える

**推奨対応**:
- Supabase Storageにアバター画像をアップロード
- customersテーブルにavatar_url列を追加
- または機能を一時的に非表示にする

---

### 🟢 11.14 aria属性の不足

**問題点**:
- プロジェクト全体でaria属性が16件のみ
- フォーム、ボタン、モーダルなど多くの要素でaria属性が欠落
- スクリーンリーダーユーザーへの配慮が不十分

**影響**:
- WCAGアクセシビリティ基準を満たさない
- 視覚障害のあるユーザーが利用困難

**推奨対応**:
- 主要なインタラクティブ要素にaria-label追加
- フォームフィールドにaria-describedby追加
- モーダルにrole="dialog"とaria-modal="true"追加
- ローディング状態にaria-busy追加

---

### 🟢 11.15 オフライン対応の欠如

**問題点**:
- Service Workerが実装されていない
- オフライン時のフォールバック表示がない
- ネットワーク接続が不安定な環境での対応がない

**影響**:
- オフライン時に白い画面が表示される
- モバイルユーザーの体験が悪い

**推奨対応**:
- PWA対応（Service Worker + manifest.json）
- オフライン時のフォールバックページ
- ネットワーク状態の監視と適切なフィードバック

---

### 🟢 11.16 予約完了後の導線改善

**問題点**:
- 予約完了後の次のアクション提案が弱い
- 完了画面からマイページへの導線が目立たない
- 他のシナリオへの回遊導線がない

**影響**:
- リピート予約率が低い可能性
- サイト内の回遊が少ない

**推奨対応**:
- 予約完了画面に「マイページで予約を確認」ボタンを目立たせる
- 「他のシナリオを見る」リンクを追加
- 予約した公演の関連シナリオを提案

---

### 🟡 11.17 プラットフォーム（MMQ）と団体（組織）予約サイトの文脈切り替えが分かりにくい

**問題点**:
- `/`（プラットフォーム）→ `/{organizationSlug}`（団体予約サイト）と遷移した際に、「今どちらの文脈にいるか」が初見ユーザーに伝わりにくい
- ヘッダーの「MMQ」クリックで `/` に戻れる一方、ユーザーの期待する「前の画面へ戻る」と一致しないケースがある（探索が途切れる）

**影響**:
- 初見ユーザーが迷子になりやすい
- 予約前の比較・回遊が途切れ、離脱率が上がる可能性

**推奨対応**:
- パンくずや「団体予約サイト」ラベルなど、現在地の明確化
- 直前に閲覧していた団体へ戻る導線（履歴/直近訪問団体）をUIで提示

---

### 🟡 11.18 組織スラッグが存在しない場合のリカバリ導線が不自然

**問題点**:
- 存在しない `/{slug}` にアクセスした際の「戻る」導線が特定団体（例: `/queens-waltz`）固定になっているケースがある
- 初見ユーザーにとっては「関係ない団体に飛ばされた」ように感じ、信頼を損ねやすい

**影響**:
- 外部流入（共有URL/検索結果）での離脱率増加
- 問い合わせ増加（URLが壊れている/どこを見れば良いか不明）

**推奨対応**:
- フォールバックは **プラットフォームトップ（`/`）** または **団体一覧（`/stores`）** に統一
- 「団体を探す」CTAをエラー画面に明示

---

### 🟢 11.19 旧ハッシュURLとパスURLの混在により、共有/ブックマーク体験が不安定になりうる

**問題点**:
- 旧形式（`/#booking/...` 等）をパスへ変換する後方互換はあるが、外部露出が残るとURL形式が混在する

**影響**:
- 共有URLの見た目が悪い、ユーザーが「正しいURL」を判断できない
- 将来の回収時に意図しない導線が残りやすい

**推奨対応**:
- 公開導線・テスト・ドキュメント含めてパス方式に統一
- 旧URLの露出を段階的にゼロへ（必要ならサーバ側で301）

---

### 🟢 11.20 `window.location.href` 依存の遷移が多く、SPAとしての体感を損ねる

**問題点**:
- ヘッダー等の主要導線が `window.location.href` で遷移しており、全画面リロード/状態喪失が起きやすい

**影響**:
- 体感速度の低下、スクロール位置や状態がリセットされ「飛ばされた感」が出る

**推奨対応**:
- `react-router` の `navigate` / `Link` を優先し、可能な範囲でSPA遷移へ統一

---

### 🟡 11.21 予約人数選択が「残席」と連動しておらず、後段で弾かれて体験が悪い

**問題点**:
- 予約人数の選択肢が最大人数まで出るため、残席より大きい人数を選べる
- 次アクション時に警告で弾かれ、「選べたのに進めない」体験になる

**影響**:
- 予約確定直前でのストレス増加・離脱

**推奨対応**:
- 残席に合わせて選択肢を制限、または選択時点で分かりやすく警告/自動補正

---

### 🟢 11.22 重複予約の案内文言が統一されておらず、ユーザーが手順を誤解しやすい

**問題点**:
- 「人数を増やす場合はマイページから変更できる」旨と、「キャンセルして変更」旨が混在する箇所があり得る

**影響**:
- 予約ミス/問い合わせ増加
- 信頼低下（仕様が分からない）

**推奨対応**:
- 正しい仕様に合わせて文言と手順を統一（変更可能なら「変更」、不可なら「キャンセル→再予約」）

---

### 🟡 11.23 お問い合わせ（MMQ宛）と団体別お問い合わせの違いが初見に伝わりにくい

**問題点**:
- `/contact`（MMQ宛）と `/org/{slug}/contact`（団体宛）が併存し、初見ユーザーが「どこに届くか」を判断しにくい
- 送信後の戻り先が文脈（団体ページ閲覧中）と一致しないケースがある

**影響**:
- 誤送信/たらい回し、問い合わせ対応コスト増

**推奨対応**:
- リンク文言を明確化（例:「店舗へ問い合わせ」「MMQ運営へ問い合わせ」）
- 送信後は直前の文脈（団体トップ等）に戻れる導線を用意

---

### 🟢 11.24 E2Eテストが旧URL（ハッシュ形式）前提で、実導線の退行を検知しにくい

**問題点**:
- Playwright等が `/#booking/...` を叩くと、パス方式の実導線の問題を取りこぼす可能性がある

**影響**:
- 重要導線（`/{slug}` など）の退行がCIで検知されない

**推奨対応**:
- E2Eのベースをパス形式に移行し、旧URLは互換テストとして別枠に分離

---

## 改善優先度まとめ（更新）

### 🔴 高優先度（セキュリティ・重大なバグ・UX）
1. ~~Supabase認証情報のハードコード削除~~ ✅対応完了
2. `as any` の削減（特にAPI関連）
3. N+1クエリの修正
4. ~~初回訪問時のガイダンス不足~~ ✅対応完了
5. ~~ログイン/サインアップフォームの改善~~ ✅対応完了

### 🟡 中優先度（品質・保守性・UX）
6. console.logの `logger` への置換
7. setTimeoutのクリーンアップ追加
8. TODO項目のIssue化と対応
9. 大きすぎるファイルの分割
10. tsconfig.jsonの厳格化
11. ~~予約フローの不明確さ~~ ✅対応完了
12. ~~404ページの作成~~ ✅対応完了（新規）
13. ~~キャンセル待ち機能の実装~~ ✅対応完了（新規）
14. ~~マイページアバター画像の永続化~~ ✅対応完了（新規）
15. **エラーハンドリングの改善**
16. ~~プラットフォームと団体予約サイトの文脈切り替え改善~~ ✅対応完了（新規）
17. ~~存在しない組織スラッグ時のリカバリ導線改善~~ ✅対応完了
18. ~~予約人数UIを残席に連動~~ ✅対応完了
19. ~~お問い合わせ導線（MMQ宛/団体宛）の明確化~~ ✅対応完了

### 🟢 低優先度（改善・UX）
20. ~~alert()のToastへの置換~~ ✅対応完了（showToastユーティリティで既に統一済み）
21. 重複コードの統合
22. 不要な依存関係の削除
23. ESLint設定の追加
24. **aria属性の追加**（新規）
25. **オフライン対応（PWA）**（新規）
26. ~~予約完了後の導線改善~~ ✅対応完了
27. ~~重複予約の案内文言の統一~~ ✅対応完了
28. **旧ハッシュURL露出の削減（URL形式の統一）**（新規）
29. ~~`window.location.href` 遷移の削減（SPA体感改善）~~ ✅対応完了
30. ~~E2EをパスURL前提へ移行~~ ✅対応完了
31. **通知機能の実装**
32. **モバイル最適化の完了**
33. **検索機能の改善**
34. **ローディング状態の改善**

---

*このレポートは 2026-01-13 に作成されました。*
*2026-01-13: 新規ユーザー視点でのUXレビューを追加（11. ユーザー体験の問題）*
*2026-01-15: 2回目の新規ユーザー視点レビュー実施。404ページ不在、キャンセル待ち未実装、アバター永続化、aria属性不足、オフライン対応欠如、予約完了後導線を追加*
*2026-01-15: 新規訪問ユーザー視点レビュー（別紙 `docs/UX_FIRST_VISIT_REVIEW_2026-01-15.md`）から不足観点を統合（11.17〜11.24）*
*2026-01-18: UXレビュー指摘の修正実施。予約人数残席連動、slug不在エラー改善、問い合わせ戻り先、SPA遷移改善、重複予約文言統一、予約完了導線追加、E2E新URL化*
*2026-01-18: 追加対応。404ページ作成（NotFoundPage.tsx）、Header/OrganizationRegister/AuthorLoginのSPA遷移改善、alert()がshowToastで既に統一済みであることを確認*
*定期的に見直し、更新することを推奨します。*

