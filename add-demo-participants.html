<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>デモ参加者追加ツール</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #2563eb;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    #log {
      margin-top: 20px;
      padding: 15px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-line {
      margin: 4px 0;
    }
    .log-success {
      color: #10b981;
    }
    .log-error {
      color: #ef4444;
    }
    .log-info {
      color: #3b82f6;
    }
    .log-skip {
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📋 デモ参加者追加ツール</h1>
    <p>今日以前の中止になっていない公演で、定員に達していない公演にデモ参加者を追加します。</p>
    <button id="startBtn" onclick="start()">デモ参加者を追加</button>
    <div id="log"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    const SUPABASE_URL = 'https://cznpcewciwywcqcxktba.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6bnBjZXdjaXd5d2NxY3hrdGJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjMzNDM0NzcsImV4cCI6MjAzODkxOTQ3N30.yPd9Ej3PoC8oXEsmSw_lQi2WF5hcW8Pq31DFWRfIBvM'
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log')
      const line = document.createElement('div')
      line.className = `log-line log-${type}`
      line.textContent = message
      logDiv.appendChild(line)
      logDiv.scrollTop = logDiv.scrollHeight
    }

    window.start = async function() {
      const btn = document.getElementById('startBtn')
      btn.disabled = true
      document.getElementById('log').innerHTML = ''
      
      log('処理を開始します...', 'info')
      
      try {
        const result = await addDemoParticipants()
        log('━━━━━━━━━━━━━━━━━━━━━━━━', 'info')
        log(`処理完了: 成功 ${result.success}件, スキップ ${result.skipped}件, 失敗 ${result.failed}件`, 'info')
        log('━━━━━━━━━━━━━━━━━━━━━━━━', 'info')
      } catch (error) {
        log(`エラー: ${error.message}`, 'error')
      } finally {
        btn.disabled = false
      }
    }

    async function addDemoParticipants() {
      const today = new Date()
      today.setHours(23, 59, 59, 999)
      
      let successCount = 0
      let failedCount = 0
      let skippedCount = 0
      
      // デモ顧客を取得
      log('デモ顧客を検索中...', 'info')
      const { data: demoCustomer, error: customerError } = await supabase
        .from('customers')
        .select('id, name')
        .or('name.ilike.%デモ%,email.ilike.%demo%')
        .limit(1)
        .single()
      
      if (customerError || !demoCustomer) {
        log('デモ顧客が見つかりません', 'error')
        throw new Error('デモ顧客が見つかりません')
      }
      
      log(`デモ顧客: ${demoCustomer.name} (ID: ${demoCustomer.id})`, 'success')
      
      // 今日以前の公演を取得
      log('公演を取得中...', 'info')
      const { data: pastEvents, error: eventsError } = await supabase
        .from('schedule_events')
        .select('id, date, venue, scenario, gms, start_time, end_time, category, is_cancelled, current_participants, capacity')
        .lte('date', today.toISOString().split('T')[0])
        .eq('is_cancelled', false)
        .in('category', ['open', 'gmtest'])
        .order('date', { ascending: false })
      
      if (eventsError) {
        log('公演取得エラー', 'error')
        throw eventsError
      }
      
      if (!pastEvents || pastEvents.length === 0) {
        log('対象の公演がありません', 'skip')
        return { success: 0, failed: 0, skipped: 0 }
      }
      
      log(`対象公演: ${pastEvents.length}件`, 'info')
      
      for (const event of pastEvents) {
        const currentParticipants = event.current_participants || 0
        const maxParticipants = event.capacity || 8
        
        if (currentParticipants >= maxParticipants) {
          skippedCount++
          continue
        }
        
        // 既存のデモ予約チェック
        const { data: existingReservations } = await supabase
          .from('reservations')
          .select('id, participant_names, reservation_source')
          .eq('schedule_event_id', event.id)
          .in('status', ['confirmed', 'pending'])
        
        const hasDemoParticipant = existingReservations?.some(r => 
          r.reservation_source === 'demo_auto' ||
          !r.participant_names || 
          r.participant_names.length === 0
        )
        
        if (hasDemoParticipant) {
          skippedCount++
          continue
        }
        
        const shortfall = maxParticipants - currentParticipants
        
        if (!event.scenario || event.scenario.trim() === '') {
          log(`⏭️  シナリオ名が空 [${event.date}]`, 'skip')
          skippedCount++
          continue
        }

        const { data: scenario } = await supabase
          .from('scenarios')
          .select('id, title, duration, participation_fee, gm_test_participation_fee')
          .eq('title', event.scenario.trim())
          .maybeSingle()
        
        if (!scenario) {
          log(`⏭️  シナリオ未登録 [${event.scenario}]`, 'skip')
          skippedCount++
          continue
        }
        
        const isGmTest = event.category === 'gmtest'
        const participationFee = isGmTest 
          ? (scenario.gm_test_participation_fee || scenario.participation_fee || 0)
          : (scenario.participation_fee || 0)
        
        const { data: store } = await supabase
          .from('stores')
          .select('id')
          .or(`name.eq.${event.venue},short_name.eq.${event.venue}`)
          .single()
        
        if (!store) {
          log(`❌ 店舗ID取得エラー [${event.venue}]`, 'error')
          failedCount++
          continue
        }
        
        let durationMinutes = 120
        if (scenario.duration) {
          const parsed = parseInt(String(scenario.duration), 10)
          if (!isNaN(parsed) && parsed > 0) {
            durationMinutes = parsed
          }
        }

        const demoReservation = {
          schedule_event_id: event.id,
          title: event.scenario || '',
          scenario_id: scenario.id || null,
          store_id: store.id || null,
          customer_id: demoCustomer.id,
          customer_notes: `デモ参加者（自動追加） - ${shortfall}名`,
          requested_datetime: `${event.date}T${event.start_time}+09:00`,
          duration: durationMinutes,
          participant_count: shortfall,
          participant_names: [],
          assigned_staff: event.gms || [],
          base_price: participationFee * shortfall,
          options_price: 0,
          total_price: participationFee * shortfall,
          discount_amount: 0,
          final_price: participationFee * shortfall,
          payment_method: 'onsite',
          payment_status: 'paid',
          status: 'confirmed',
          reservation_source: 'demo_auto'
        }
        
        const { error: insertError } = await supabase
          .from('reservations')
          .insert(demoReservation)
        
        if (insertError) {
          log(`❌ エラー [${event.date} ${event.scenario}]: ${insertError.message}`, 'error')
          failedCount++
        } else {
          log(`✅ 追加成功: ${event.date} ${event.scenario} (${shortfall}名追加)`, 'success')
          successCount++
        }
      }
      
      return { success: successCount, failed: failedCount, skipped: skippedCount }
    }
  </script>
</body>
</html>

