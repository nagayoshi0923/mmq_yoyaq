name: Deploy Supabase

on:
  push:
    branches: [staging, main]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - 'supabase/config.toml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  # ============================================================================
  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  # stagingãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«å®Ÿè¡Œ
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/staging' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Staging Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_STAGING_PROJECT_ID }}

      - name: Run Database Migrations
        run: |
          echo "ğŸ“¦ Running database migrations on staging..."
          supabase db push

      - name: Deploy Edge Functions
        run: |
          echo "âš¡ Deploying Edge Functions to staging..."
          supabase functions deploy --all

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Staging deployment completed successfully!"
          echo "ğŸ”— Staging URL: https://${{ secrets.SUPABASE_STAGING_PROJECT_ID }}.supabase.co"

  # ============================================================================
  # æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«å®Ÿè¡Œ
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Production Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROD_PROJECT_ID }}

      - name: Run Database Migrations
        run: |
          echo "ğŸ“¦ Running database migrations on production..."
          supabase db push

      - name: Deploy Edge Functions
        run: |
          echo "âš¡ Deploying Edge Functions to production..."
          supabase functions deploy --all

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Production deployment completed successfully!"
          echo "ğŸ”— Production URL: https://${{ secrets.SUPABASE_PROD_PROJECT_ID }}.supabase.co"

  # ============================================================================
  # PRã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¤œè¨¼ï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰
  # ============================================================================
  validate-migrations:
    name: Validate Migrations (PR)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase Local
        run: |
          supabase start

      - name: Validate Migrations
        run: |
          echo "ğŸ” Validating migrations locally..."
          supabase db reset

      - name: Stop Supabase Local
        if: always()
        run: |
          supabase stop
