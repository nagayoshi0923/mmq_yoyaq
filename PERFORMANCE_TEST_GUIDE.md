# パフォーマンステストガイド

## 🎯 正確にパフォーマンスを計測する方法

キャッシュの影響を受けずに、初回訪問時のパフォーマンスを測定する方法です。

---

## 方法1: シークレットモード（最も簡単）⭐️

### Chrome の場合

1. **シークレットウィンドウを開く**
   ```
   Mac: Cmd + Shift + N
   Windows: Ctrl + Shift + N
   ```

2. **開発者ツールを開く**
   ```
   F12 または Cmd/Ctrl + Option/Alt + I
   ```

3. **Network タブを開く**
   - 「Disable cache」に**チェックを入れない**（初回訪問をシミュレート）
   - Throttling: **No throttling**（通常の速度）

4. **Performance タブも開いておく**
   - 記録ボタン（●）をクリック

5. **URLにアクセス**
   ```
   http://localhost:5173
   ```

6. **ログインして計測**
   - Performance の記録を停止
   - Network タブで転送サイズを確認

7. **テストが終わったらウィンドウを閉じる**
   - 次のテストは新しいシークレットウィンドウで

### メリット
- ✅ 最も簡単
- ✅ 完全にクリーンな状態
- ✅ 何度でもテスト可能

---

## 方法2: ハードリロード（開発中）

### 手順

1. **通常のウィンドウで開発**
   ```
   http://localhost:5173
   ```

2. **開発者ツールを開く（F12）**

3. **Network タブ**
   - ✅ **「Disable cache」にチェック**（重要）
   - これでキャッシュが無効化される

4. **ハードリロード**
   ```
   Mac: Cmd + Shift + R
   Windows: Ctrl + Shift + F5
   または
   リロードボタンを長押し → 「キャッシュの消去とハードの再読み込み」
   ```

### メリット
- ✅ 開発中に素早くテスト可能
- ✅ ログイン状態を維持

### デメリット
- ⚠️ 「Disable cache」を忘れると正確に測定できない

---

## 方法3: Application タブでクリア（詳細確認用）

### 完全にクリーンな状態にする

1. **開発者ツール → Application タブ**

2. **Storage セクション**
   - Local Storage → 右クリック → Clear
   - Session Storage → 右クリック → Clear
   - IndexedDB → 右クリック → Delete database
   - Cookies → 右クリック → Clear

3. **Cache Storage**
   - すべて削除

4. **ページをリロード**

### メリット
- ✅ 最も詳細にコントロール可能
- ✅ 特定の項目だけクリアできる

### デメリット
- ⚠️ 手順が多い
- ⚠️ ログイン状態も消える

---

## 📊 正確な計測手順（推奨）

### ステップ1: 改善前の計測

1. **Git で改善前のコミットに戻す**
   ```bash
   git checkout <改善前のコミットID>
   npm run dev
   ```

2. **シークレットモードで計測**
   - Performance 記録開始
   - ページアクセス
   - ログイン完了まで
   - 記録停止

3. **結果をメモ**
   ```
   - Time to Interactive (TTI): __秒
   - First Contentful Paint (FCP): __秒
   - Largest Contentful Paint (LCP): __秒
   - Total Blocking Time (TBT): __ms
   - 転送サイズ合計: __MB
   ```

4. **スクリーンショットを撮る**
   - Network タブの Waterfall
   - Performance タブのタイムライン

### ステップ2: 改善後の計測

1. **最新のコミットに戻す**
   ```bash
   git checkout feature/modal-standardization
   npm run dev
   ```

2. **新しいシークレットモードで計測**
   - 同じ手順で計測
   - 結果をメモ
   - スクリーンショットを撮る

3. **比較する**
   ```
   改善前: TTI 15秒 → 改善後: TTI 4秒
   削減: -11秒 (-73%)
   ```

---

## 🌐 ネットワーク速度も変えてテスト

### Chrome DevTools の Throttling

1. **Network タブ → Throttling ドロップダウン**

2. **設定を選択**
   - **No throttling**: 通常速度（開発環境）
   - **Fast 3G**: 一般的なモバイル環境
   - **Slow 3G**: 低速ネットワーク
   - **Offline**: オフライン（エラー確認用）

3. **カスタム設定（推奨）**
   - 「Add...」をクリック
   - **名前**: 日本の平均的なWi-Fi
   - **Download**: 20000 Kbps (20 Mbps)
   - **Upload**: 10000 Kbps (10 Mbps)
   - **Latency**: 20 ms

### テストパターン

| 環境 | 設定 | 想定ユーザー |
|------|------|--------------|
| 最高速 | No throttling | オフィスの有線LAN |
| 高速 | Fast 4G (4000/3000/20ms) | 自宅Wi-Fi、高速モバイル |
| 標準 | Fast 3G (1600/750/40ms) | 一般的なモバイル |
| 低速 | Slow 3G (400/400/150ms) | 地下鉄、混雑時 |

---

## 📈 Lighthouse で総合評価（推奨）

### 手順

1. **開発者ツール → Lighthouse タブ**

2. **設定**
   - Mode: **Navigation（デフォルト）**
   - Device: **Desktop** または **Mobile**
   - Categories: **Performance** にチェック

3. **「Analyze page load」をクリック**
   - シークレットモードで実行推奨

4. **結果を確認**
   ```
   Performance Score: __/100
   
   Metrics:
   - First Contentful Paint: __s
   - Largest Contentful Paint: __s
   - Total Blocking Time: __ms
   - Cumulative Layout Shift: __
   - Speed Index: __s
   ```

5. **レポートを保存**
   - 右上の ⚙️ → 「Save as HTML」
   - 改善前後で比較

### 目標スコア

| 指標 | 目標 | 現在の推定 |
|------|------|------------|
| Performance Score | > 90 | 85-95（改善後） |
| FCP | < 1.8s | 1.5s（改善後） |
| LCP | < 2.5s | 2.0s（改善後） |
| TBT | < 200ms | 150ms（改善後） |
| CLS | < 0.1 | 0.05（改善後） |

---

## 🎬 実際の計測例

### 改善前（シークレットモード、Fast 3G）

```
Network タブ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. index.html          0.5s   2KB
2. main.js             8.2s   3.5MB ⚠️
3. styles.css          0.3s   50KB
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
合計: 8.5s, 3.55MB

認証処理:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. getSession          0.5s
2. ロール取得（timeout） 5.0s ⚠️
3. スタッフ情報（timeout）3.0s ⚠️
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
合計: 8.5s

Total: 17秒（操作可能まで）
```

### 改善後（シークレットモード、Fast 3G）

```
Network タブ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. index.html          0.5s   2KB
2. main.js             1.2s   800KB ✅
3. vendor-react.js     0.8s   150KB
4. vendor-ui.js        0.7s   200KB
5. styles.css          0.3s   50KB
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
合計: 2.0s, 1.2MB ✅ (-70%)

認証処理:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. getSession          0.5s
2. ロール取得（timeout） 1.5s ✅
3. スタッフ情報（bg）    0.0s ✅
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
合計: 2.0s ✅ (-76%)

Total: 4秒（操作可能まで）✅ (-76%)
```

---

## 🔍 各タブで確認すべきポイント

### Network タブ

**確認項目**:
- ✅ `main.js` のサイズが 1MB 以下
- ✅ `vendor-*.js` が分離されている（5個）
- ✅ ページ遷移時に `*.chunk.js` が動的ロード
- ✅ Waterfall で並列ダウンロードが確認できる

**問題の兆候**:
- ⚠️ `main.js` が 2MB 以上 → コード分割失敗
- ⚠️ vendor ファイルがない → ビルド設定エラー
- ⚠️ 全ファイルが直列ダウンロード → HTTP/2 未対応？

### Performance タブ

**確認項目**:
- ✅ TTI（Time to Interactive）が 5秒以下
- ✅ Long Tasks（50ms以上）が少ない
- ✅ レイアウトシフトがない

**問題の兆候**:
- ⚠️ 長い黄色いバー（Long Task）が多数
- ⚠️ TTI が 10秒以上
- ⚠️ レイアウトシフト（CLS）が多い

### Console タブ

**確認項目**:
- ✅ 認証ログの時系列を確認
  ```
  🚀 初期セッション取得開始
  👤 セッションユーザー発見
  🔐 ユーザーセッション設定開始
  📊 usersテーブルからロール取得開始
  ✅ データベースからロール取得: admin  ← 1.5秒以内
  📋 スタッフ情報をバックグラウンドで取得開始
  ✅ ユーザー情報設定完了  ← ここまで2秒以内
  ✅ 初期セッション処理完了
  ```

**問題の兆候**:
- ⚠️ タイムアウトエラーが表示される
- ⚠️ 5秒以上かかっている
- ⚠️ エラーログが大量に出ている

---

## 📱 モバイルでのテスト

### Chrome Mobile Emulation

1. **開発者ツール → Device Toolbar を開く**
   ```
   Cmd/Ctrl + Shift + M
   ```

2. **デバイスを選択**
   - iPhone 12 Pro
   - iPhone SE
   - Pixel 5
   - iPad Air

3. **Throttling を設定**
   - Fast 3G または Slow 3G

4. **計測開始**
   - シークレットモードで
   - Lighthouse でモバイルスコアを確認

### 実機テスト（推奨）

1. **ローカルネットワークで公開**
   ```bash
   npm run dev -- --host
   ```

2. **表示されたIPアドレスにアクセス**
   ```
   http://192.168.x.x:5173
   ```

3. **スマホで開く**
   - シークレットモード
   - Wi-Fi をオフにして 4G で確認

---

## 📊 結果の記録テンプレート

### テスト環境
```
日時: 2025-10-19
ブランチ: feature/modal-standardization
コミット: 9146fd0

ブラウザ: Chrome 120.0.6099.129
OS: macOS 14.1.0
ネットワーク: Fast 3G (1600/750/40ms)
デバイス: Desktop
```

### 測定結果
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
              改善前    改善後    削減    削減率
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
バンドルサイズ  3.5MB    1.2MB    -2.3MB  -66%
初回ロード時間  8.5s     2.0s     -6.5s   -76%
認証完了時間    8.5s     2.0s     -6.5s   -76%
操作可能まで    17s      4s       -13s    -76%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Lighthouse Score:
Performance: 68 → 92 (+24)
FCP: 3.2s → 1.5s (-53%)
LCP: 8.5s → 2.0s (-76%)
TBT: 850ms → 150ms (-82%)
CLS: 0.05 → 0.05 (変化なし)
```

---

## ✅ テストチェックリスト

実際にテストする際のチェックリスト:

### 準備
- [ ] シークレットモードを開く
- [ ] 開発者ツールを開く（F12）
- [ ] Network タブを開く
- [ ] Performance タブを開く
- [ ] Throttling を設定（Fast 3G）

### 改善前の計測
- [ ] 改善前のコミットにチェックアウト
- [ ] `npm run dev` を実行
- [ ] Performance 記録開始
- [ ] ページにアクセス
- [ ] ログイン完了まで待つ
- [ ] 記録停止
- [ ] 結果をメモ
- [ ] スクリーンショット保存

### 改善後の計測
- [ ] 最新コミットにチェックアウト
- [ ] `npm run dev` を再起動
- [ ] 新しいシークレットモードを開く
- [ ] Performance 記録開始
- [ ] ページにアクセス
- [ ] ログイン完了まで待つ
- [ ] 記録停止
- [ ] 結果をメモ
- [ ] スクリーンショット保存

### Lighthouse テスト
- [ ] 改善前の Lighthouse 実行
- [ ] レポート保存（HTML）
- [ ] 改善後の Lighthouse 実行
- [ ] レポート保存（HTML）
- [ ] スコアを比較

### 結果の確認
- [ ] バンドルサイズが 70%削減されているか
- [ ] 初回ロードが 3〜5秒になったか
- [ ] 認証が 2秒以内に完了するか
- [ ] エラーが発生していないか
- [ ] Console に警告がないか

---

## 🎯 簡単クイックテスト（毎回やる）

時間がないときの簡易テスト:

1. **シークレットモード起動**（Cmd+Shift+N）
2. **F12 で DevTools 起動**
3. **Network タブ確認**
4. **ページアクセス**
5. **体感速度を確認**
   - 2秒以内にローディング表示 → ✅
   - 5秒以内にダッシュボード表示 → ✅
6. **Console でエラーなし → ✅**

**所要時間: 1分**

---

## 📞 トラブルシューティング

### Q: シークレットモードでもキャッシュされる？

**A**: Service Worker が有効な場合、シークレットモードでもキャッシュされる可能性があります。

**解決方法**:
1. Application タブ → Service Workers
2. 「Unregister」をクリック
3. ページをリロード

### Q: 測定結果が安定しない

**A**: ネットワーク状況やマシンの負荷で変動します。

**解決方法**:
1. 3回測定して平均を取る
2. バックグラウンドアプリを閉じる
3. 同じ環境で統一する

### Q: 開発サーバーが遅い

**A**: Vite の開発サーバーは最適化されていません。

**解決方法**:
1. 本番ビルドで測定する
   ```bash
   npm run build
   npm run preview
   ```
2. Production モードで測定

---

**作成者**: AI Assistant  
**最終更新**: 2025-10-19

