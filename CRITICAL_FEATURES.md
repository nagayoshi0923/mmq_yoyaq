# é‡è¦æ©Ÿèƒ½ãƒªã‚¹ãƒˆï¼ˆå‰Šé™¤ãƒ»å¤‰æ›´å³ç¦ï¼‰

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­ã§**çµ¶å¯¾ã«å‰Šé™¤ãƒ»åŠ£åŒ–ã•ã›ã¦ã¯ã„ã‘ãªã„é‡è¦æ©Ÿèƒ½**ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’ä¿®æ­£ã™ã‚‹éš›ã¯ã€å¿…ãšã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã€æ©Ÿèƒ½ãŒå¤±ã‚ã‚Œãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

---

## ğŸš¨ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é‡è¤‡é˜²æ­¢æ©Ÿèƒ½

### æ¦‚è¦
åŒã˜æ—¥ä»˜ãƒ»åº—èˆ—ãƒ»æ™‚é–“å¸¯ã«è¤‡æ•°ã®å…¬æ¼”ãŒç™»éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã®é‡è¦æ©Ÿèƒ½ã€‚

### å®Ÿè£…ç®‡æ‰€

#### 1. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ç”»é¢ã§ã®æ‰‹å‹•è¿½åŠ ãƒ»ç·¨é›†
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/pages/ScheduleManager.tsx`
**é–¢æ•°**: `handleSavePerformance` (827è¡Œç›®ï½)

**æ©Ÿèƒ½**:
- å…¬æ¼”ã‚’ä¿å­˜ã™ã‚‹å‰ã«ã€åŒã˜æ—¥ä»˜ãƒ»åº—èˆ—ãƒ»æ™‚é–“å¸¯ã«æ—¢å­˜ã®å…¬æ¼”ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
- é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯ `ConflictWarningModal` ã‚’è¡¨ç¤º
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰¿èªã—ãŸå ´åˆã®ã¿ã€æ—¢å­˜å…¬æ¼”ã‚’å‰Šé™¤ã—ã¦æ–°è¦å…¬æ¼”ã‚’ä¿å­˜

**ãƒã‚§ãƒƒã‚¯é …ç›®**:
```typescript
// ä»¥ä¸‹ã®æ¡ä»¶ã§é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
- event.date === performanceData.date
- event.venue === performanceData.venue
- getTimeSlot(event.start_time) === timeSlot
- !event.is_cancelled
```

**æ³¨æ„äº‹é …**:
- âš ï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ã€ç·¨é›†ä¸­ã®å…¬æ¼”è‡ªèº«ã‚’é™¤å¤–ã™ã‚‹ã“ã¨
- âš ï¸ æ™‚é–“å¸¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ`getTimeSlot`ï¼‰ã¯ä»¥ä¸‹ã®é€šã‚Šï¼š
  - æœ: 0-11æ™‚
  - æ˜¼: 12-16æ™‚
  - å¤œ: 17æ™‚ä»¥é™

---

#### 2. è²¸åˆ‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªæ™‚ã®ç«¶åˆãƒã‚§ãƒƒã‚¯
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/pages/PrivateBookingManagement.tsx`
**é–¢æ•°**: `loadConflictInfo` (308è¡Œç›®ï½)

**æ©Ÿèƒ½**:
- è²¸åˆ‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ‰¿èªã™ã‚‹éš›ã€åº—èˆ—ã¨GMã®é¸æŠè‚¢ã‹ã‚‰æ—¢ã«äºˆç´„æ¸ˆã¿ã®æ—¥æ™‚ã‚’é™¤å¤–
- é¸æŠä¸å¯ã®åº—èˆ—ãƒ»GMã«ã¯ã€Œäºˆç´„æ¸ˆã¿ã€ã¨è¡¨ç¤º

**é‡è¦**: ã“ã®é–¢æ•°ã¯**2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«**ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

1. **`reservations` ãƒ†ãƒ¼ãƒ–ãƒ«** (ç¢ºå®šæ¸ˆã¿è²¸åˆ‡äºˆç´„)
   ```typescript
   const { data: confirmedReservations } = await supabase
     .from('reservations')
     .select('id, store_id, gm_staff, candidate_datetimes')
     .eq('status', 'confirmed')
   ```

2. **`schedule_events` ãƒ†ãƒ¼ãƒ–ãƒ«** (æ‰‹å‹•è¿½åŠ ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸå…¨å…¬æ¼”)
   ```typescript
   const { data: scheduleEvents } = await supabase
     .from('schedule_events')
     .select('id, store_id, date, start_time, gms, is_cancelled')
     .eq('is_cancelled', false)
   ```

**âš ï¸ é‡å¤§ãªæ³¨æ„äº‹é …**:
- **ã©ã¡ã‚‰ã‹ä¸€æ–¹ã ã‘ã®ãƒã‚§ãƒƒã‚¯ã§ã¯ä¸ååˆ†ã§ã™ï¼**
- éå»ã« `reservations` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ç°¡æ˜“ç‰ˆãŒå®Ÿè£…ã•ã‚Œã€`schedule_events` ã®ãƒã‚§ãƒƒã‚¯ãŒæ¼ã‚ŒãŸäº‹ä¾‹ãŒã‚ã‚Šã¾ã™
- ã“ã®æ©Ÿèƒ½ã‚’ä¿®æ­£ãƒ»å†å®Ÿè£…ã™ã‚‹éš›ã¯ã€å¿…ãšä¸¡æ–¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ãã ã•ã„

**æ™‚é–“å¸¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯**:
```typescript
const getTimeSlot = (startTime: string): string => {
  const hour = parseInt(startTime.split(':')[0])
  if (hour < 12) return 'æœ'
  if (hour < 17) return 'æ˜¼'
  return 'å¤œ'
}
```

**ç«¶åˆæƒ…å ±ã®å½¢å¼**:
```typescript
// åº—èˆ—ã®ç«¶åˆ: `${store_id}-${date}-${timeSlot}`
storeDateConflicts.add('bef973a7-faa2-466d-afcc-c6466f24474f-2025-10-15-å¤œ')

// GMã®ç«¶åˆ: `${gm_id}-${date}-${timeSlot}`
gmDateConflicts.add('some-gm-uuid-2025-10-15-å¤œ')
```

---

#### 3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/schedule/ImportScheduleModal.tsx`

**æ©Ÿèƒ½**:
- ã€Œæ—¢å­˜ã®åŒæœˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ç™»éŒ²ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰
- ONã®å ´åˆ: æœˆå…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæ¨å¥¨ï¼‰
- OFFã®å ´åˆ: é‡è¤‡ãƒã‚§ãƒƒã‚¯ãªã—ã§è¿½åŠ ï¼ˆéæ¨å¥¨ï¼‰

**æ³¨æ„äº‹é …**:
- âš ï¸ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹OFFæ™‚ã¯é‡è¤‡ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œæ¨å¥¨ã€ã¨ã—ã¦å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ˜ç¤ºã—ã¦ã„ã‚‹

---

## ğŸ“‹ å¤‰æ›´å±¥æ­´

### 2025-10-17
- **ä¿®æ­£**: è²¸åˆ‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªæ™‚ã®ç«¶åˆãƒã‚§ãƒƒã‚¯ã‚’å¼·åŒ–
- **è©³ç´°**: `loadConflictInfo` é–¢æ•°ãŒ `reservations` ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ãŸå•é¡Œã‚’ä¿®æ­£
- **å¤‰æ›´å†…å®¹**: `schedule_events` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚å«ã‚ã¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ã«æ”¹å–„
- **ä¿®æ­£è€…**: AI Assistant
- **ç†ç”±**: éå»ã«å®Ÿè£…ã—ãŸæ©Ÿèƒ½ãŒå¤±ã‚ã‚Œã¦ã„ãŸãŸã‚ã€å†å®Ÿè£…ã¨ã¨ã‚‚ã«ä¿è­·ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 

### 2025-10-17
- **è¿½åŠ **: é‡è¦æ©Ÿèƒ½ã«ä¿è­·ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆğŸš¨ CRITICALï¼‰ã‚’è¿½åŠ 
- **å¯¾è±¡é–¢æ•°**:
  - `ScheduleManager.handleSavePerformance`
  - `PrivateBookingManagement.loadConflictInfo`
- **ç›®çš„**: å°†æ¥çš„ãªæ©Ÿèƒ½ã®å‰Šé™¤ãƒ»åŠ£åŒ–ã‚’é˜²ã

### 2025-10-17
- **ä½œæˆ**: ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆ`CRITICAL_FEATURES.md`ï¼‰ã‚’ä½œæˆ
- **ç›®çš„**: é‡è¦æ©Ÿèƒ½ã‚’æ˜æ–‡åŒ–ã—ã€å‰Šé™¤ãƒ»å¤‰æ›´æ™‚ã®å‚ç…§è³‡æ–™ã¨ã™ã‚‹

---

## ğŸ›¡ï¸ æ©Ÿèƒ½ä¿è­·ãƒ«ãƒ¼ãƒ«

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§é‡è¦æ©Ÿèƒ½ã‚’ä¿®æ­£ãƒ»å†å®Ÿè£…ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã£ã¦ãã ã•ã„ï¼š

1. **ã‚³ãƒ¼ãƒ‰ã«ä¿è­·ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã€å¿…ãšèª­ã‚“ã§ç†è§£ã™ã‚‹ã“ã¨**
   - `ğŸš¨ CRITICAL` ãƒãƒ¼ã‚¯ãŒã‚ã‚‹æ©Ÿèƒ½ã¯ç‰¹ã«æ³¨æ„
   - ã‚³ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚ŒãŸè¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ç¢ºèª

2. **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹ã“ã¨**
   - é‡è¦æ©Ÿèƒ½ã‚’ä¿®æ­£ã™ã‚‹å‰ã«ã€å¿…ãšã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
   - éå»ã®å¤‰æ›´å±¥æ­´ã‚„æ³¨æ„äº‹é …ã‚’ç†è§£ã™ã‚‹

3. **å¤‰æ›´å±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹ã“ã¨**
   - é‡è¦æ©Ÿèƒ½ã‚’ä¿®æ­£ã—ãŸå ´åˆã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´å±¥æ­´ã‚’è¿½è¨˜
   - æ—¥ä»˜ã€å¤‰æ›´å†…å®¹ã€ç†ç”±ã‚’æ˜è¨˜

4. **ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨**
   - æ©Ÿèƒ½ã‚’ä¿®æ­£ã—ãŸå¾Œã¯ã€å¿…ãšå‹•ä½œç¢ºèªã‚’è¡Œã†
   - ç‰¹ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã¯ã€å®Ÿéš›ã«é‡è¤‡ã‚’è©¦ã—ã¦ç¢ºèªã™ã‚‹ã“ã¨

5. **ç°¡æ˜“ç‰ˆãƒ»é€€åŒ–ç‰ˆã‚’å®Ÿè£…ã—ãªã„ã“ã¨**
   - ã€Œã¨ã‚Šã‚ãˆãšå‹•ãã€ç°¡æ˜“ç‰ˆã‚’å®Ÿè£…ã™ã‚‹ã¨ã€ä»¥å‰ã®å®Œå…¨ç‰ˆãŒå¤±ã‚ã‚Œã‚‹
   - æ—¢å­˜å®Ÿè£…ã‚’å¿…ãšç¢ºèªã—ã€åŒç­‰ä»¥ä¸Šã®æ©Ÿèƒ½ã‚’ç¶­æŒã™ã‚‹ã“ã¨

---

## ğŸ“ ä»Šå¾Œã®èª²é¡Œ

- [ ] é‡è¦æ©Ÿèƒ½ã«å¯¾ã™ã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®è¿½åŠ 
- [ ] E2Eãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹è‡ªå‹•ãƒã‚§ãƒƒã‚¯
- [ ] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
- [ ] é‡è¦é–¢æ•°ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†é›¢ï¼ˆ`utils/conflictChecker.ts` ãªã©ï¼‰

