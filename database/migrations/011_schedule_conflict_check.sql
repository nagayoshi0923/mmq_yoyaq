-- =============================================================================
-- マイグレーション 011: スケジュール競合チェック
-- =============================================================================
-- 
-- 作成日: 2026-01-28
-- 
-- 目的:
--   同一日時・店舗・時間帯に複数の公演が登録されることを防止
--   貸切予約承認時のダブルブッキングを防ぐ
-- 
-- =============================================================================

-- 同一日時・店舗・時間帯の重複を防止する一意制約
-- 中止済み(is_cancelled = true)の公演は対象外
CREATE UNIQUE INDEX IF NOT EXISTS idx_schedule_events_unique_slot
ON schedule_events (date, store_id, time_slot, organization_id)
WHERE is_cancelled = false;

-- 完了確認
DO $$ 
BEGIN
  RAISE NOTICE '✅ マイグレーション 011 完了: スケジュール競合チェック制約を追加';
END $$;

-- =============================================================================
-- ロールバックSQL（必要な場合のみ実行）
-- =============================================================================
/*
DROP INDEX IF EXISTS idx_schedule_events_unique_slot;
*/

