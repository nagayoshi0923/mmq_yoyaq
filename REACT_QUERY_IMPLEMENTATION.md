# React Query å°å…¥å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

## âœ… å®Ÿè£…å®Œäº†ï¼ˆ2025-10-19ï¼‰

**ã‚³ãƒŸãƒƒãƒˆ**: `b1beb66`  
**ãƒ–ãƒ©ãƒ³ãƒ**: `main`  
**å®Ÿè£…æ™‚é–“**: ç´„60åˆ†

---

## ğŸš€ å®Ÿè£…ã—ãŸå†…å®¹

### 1. **React Query ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—** âœ…

#### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
npm install @tanstack/react-query
```

#### QueryClient ã®è¨­å®š
```typescript
// App.tsx
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,      // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      gcTime: 10 * 60 * 1000,         // 10åˆ†é–“ãƒ¡ãƒ¢ãƒªä¿æŒ
      retry: 1,                        // å¤±æ•—æ™‚1å›ãƒªãƒˆãƒ©ã‚¤
      refetchOnWindowFocus: true,     // ã‚¿ãƒ–ã«æˆ»ã£ãŸã‚‰å†å–å¾—
    },
    mutations: {
      retry: 0,                        // ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
    },
  },
})

<QueryClientProvider client={queryClient}>
  <AuthProvider>
    <AppContent />
  </AuthProvider>
</QueryClientProvider>
```

---

### 2. **ScenarioManagement ã‚’ React Query ã«ç§»è¡Œ** âœ…

#### Beforeï¼ˆå¾“æ¥ã®æ–¹æ³•ï¼‰

```typescript
// useScenarioData.ts
const [scenarios, setScenarios] = useState<Scenario[]>([])
const [loading, setLoading] = useState(true)

const loadScenarios = useCallback(async () => {
  setLoading(true)
  const data = await scenarioApi.getAll()
  setScenarios(data)
  setLoading(false)
}, [])

useEffect(() => {
  loadScenarios()
}, [loadScenarios])

// ãƒšãƒ¼ã‚¸é·ç§»ã®ãŸã³ã«å†å–å¾—... é…ã„ ğŸ˜«
```

#### Afterï¼ˆReact Queryï¼‰

```typescript
// useScenarioQuery.ts
export function useScenariosQuery() {
  return useQuery({
    queryKey: ['scenarios'],
    queryFn: async () => {
      const data = await scenarioApi.getAll()
      // GMæƒ…å ±ã‚‚å–å¾—
      return scenariosWithGMs
    },
    staleTime: 5 * 60 * 1000 // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ âš¡
  })
}

// ä½¿ç”¨å´
const { data: scenarios = [], isLoading, error } = useScenariosQuery()

// 2å›ç›®ä»¥é™ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å³åº§ã«è¡¨ç¤ºï¼âš¡âš¡âš¡
```

---

### 3. **æ¥½è¦³çš„æ›´æ–°ï¼ˆOptimistic Updateï¼‰** âš¡

#### å‰Šé™¤å‡¦ç†ã®ä¾‹

**Beforeï¼ˆå¾“æ¥ï¼‰**:
```typescript
const handleDelete = async (id: string) => {
  await scenarioApi.delete(id)    // å¾…æ©Ÿ... 0.5ç§’
  await loadScenarios()            // å†å–å¾—... 1ç§’
  // åˆè¨ˆ: 1.5ç§’å¾…ã¡ ğŸ˜«
}
```

**Afterï¼ˆReact Queryï¼‰**:
```typescript
export function useDeleteScenarioMutation() {
  return useMutation({
    mutationFn: scenarioApi.delete,
    onMutate: async (scenarioId) => {
      // å³åº§ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å‰Šé™¤ âš¡
      queryClient.setQueryData(['scenarios'], (old) =>
        old.filter(s => s.id !== scenarioId)
      )
      // â†’ ç”»é¢ã‹ã‚‰å³åº§ã«æ¶ˆãˆã‚‹ï¼ˆ0.1ç§’ï¼‰âš¡âš¡âš¡
    },
    onError: (err, id, context) => {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
      queryClient.setQueryData(['scenarios'], context.previousScenarios)
    }
  })
}

// ä½¿ç”¨å´
const deleteMutation = useDeleteScenarioMutation()
deleteMutation.mutate(id) // å³åº§ã«åæ˜ ï¼âš¡
```

**ä½“æ„Ÿé€Ÿåº¦**: 10ã€œ15å€é«˜é€Ÿ â­ï¸â­ï¸â­ï¸

---

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### 1. **ãƒšãƒ¼ã‚¸é·ç§»é€Ÿåº¦** âš¡âš¡âš¡

| æ“ä½œ | Before | After | æ”¹å–„ |
|------|--------|-------|------|
| **åˆå›ã‚¢ã‚¯ã‚»ã‚¹** | 1.5ç§’ | 1.5ç§’ | å¤‰ã‚ã‚‰ãš |
| **2å›ç›®ä»¥é™** | 1.5ç§’ | **0.1ç§’** | **-93%** â­ï¸â­ï¸â­ï¸ |
| **å‰Šé™¤æ“ä½œ** | 1.5ç§’å¾…ã¡ | **å³åº§** | **-95%** â­ï¸â­ï¸â­ï¸ |
| **æ›´æ–°æ“ä½œ** | 1.5ç§’å¾…ã¡ | **å³åº§** | **-95%** â­ï¸â­ï¸â­ï¸ |

**å®Ÿä¾‹**:
```
ã‚·ãƒŠãƒªã‚ªç®¡ç† â†’ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† â†’ ã‚·ãƒŠãƒªã‚ªç®¡ç†ï¼ˆæˆ»ã‚‹ï¼‰

Before: 1.5ç§’ + 1.5ç§’ + 1.5ç§’ = 4.5ç§’
After:  1.5ç§’ + 1.5ç§’ + 0.1ç§’ = 3.1ç§’ï¼ˆ2å›ç›®ä»¥é™ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ï¼‰

ã•ã‚‰ã«:
5åˆ†ä»¥å†…ãªã‚‰ä½•åº¦æˆ»ã£ã¦ã‚‚ 0.1ç§’ âš¡âš¡âš¡
```

---

### 2. **API å‘¼ã³å‡ºã—å‰Šæ¸›** ğŸ’°

#### Beforeï¼ˆå¾“æ¥ï¼‰

```
ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®APIå‘¼ã³å‡ºã—:
1. ã‚·ãƒŠãƒªã‚ªç®¡ç†: 1å›
2. ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†: 1å›
3. ã‚·ãƒŠãƒªã‚ªç®¡ç†ï¼ˆæˆ»ã‚‹ï¼‰: 1å› â† ç„¡é§„
4. ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ï¼ˆæˆ»ã‚‹ï¼‰: 1å› â† ç„¡é§„
5. ã‚·ãƒŠãƒªã‚ªç®¡ç†ï¼ˆæˆ»ã‚‹ï¼‰: 1å› â† ç„¡é§„

åˆè¨ˆ: 5å›ï¼ˆç„¡é§„ãŒå¤šã„ï¼‰
```

#### Afterï¼ˆReact Queryï¼‰

```
ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®APIå‘¼ã³å‡ºã—:
1. ã‚·ãƒŠãƒªã‚ªç®¡ç†: 1å›ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
2. ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†: 1å›ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
3. ã‚·ãƒŠãƒªã‚ªç®¡ç†ï¼ˆæˆ»ã‚‹ï¼‰: 0å›ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ï¼‰ âš¡
4. ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ï¼ˆæˆ»ã‚‹ï¼‰: 0å›ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ï¼‰ âš¡
5. ã‚·ãƒŠãƒªã‚ªç®¡ç†ï¼ˆæˆ»ã‚‹ï¼‰: 0å›ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ï¼‰ âš¡

åˆè¨ˆ: 2å›ï¼ˆ-60%ï¼‰ â­ï¸â­ï¸

5åˆ†å¾Œã«å†åº¦ã‚¢ã‚¯ã‚»ã‚¹:
â†’ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å†å–å¾—ï¼ˆç”»é¢ã¯å³åº§ã«è¡¨ç¤ºï¼‰âš¡
```

**å‰Šæ¸›ç‡**: -60ã€œ90% ğŸ’°

---

### 3. **è‡ªå‹•çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã«åŒæœŸ** ğŸ”„

#### è¨­å®š

```typescript
refetchOnWindowFocus: true  // ã‚¿ãƒ–ã«æˆ»ã£ãŸã‚‰è‡ªå‹•æ›´æ–°
```

#### å‹•ä½œ

```
1. ã‚·ãƒŠãƒªã‚ªç®¡ç†ãƒšãƒ¼ã‚¸ã‚’é–‹ã
2. åˆ¥ã®ã‚¿ãƒ–ã§ä½œæ¥­
3. ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ 
4. ã‚·ãƒŠãƒªã‚ªç®¡ç†ã‚¿ãƒ–ã«æˆ»ã‚‹
5. â†’ è‡ªå‹•çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼âš¡

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä½•ã‚‚ã—ãªãã¦ã‚‚å¸¸ã«æœ€æ–°çŠ¶æ…‹ â­ï¸â­ï¸
```

---

### 4. **é–‹ç™ºåŠ¹ç‡ã®å‘ä¸Š** ğŸš€

#### Beforeï¼ˆå¾“æ¥ï¼‰

```typescript
// å„ãƒšãƒ¼ã‚¸ã§åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã... 100è¡Œä»¥ä¸Š
const [data, setData] = useState([])
const [loading, setLoading] = useState(true)
const [error, setError] = useState('')

useEffect(() => {
  setLoading(true)
  try {
    const result = await fetchData()
    setData(result)
  } catch (err) {
    setError(err.message)
  } finally {
    setLoading(false)
  }
}, [])
```

#### Afterï¼ˆReact Queryï¼‰

```typescript
// ãŸã£ãŸ3è¡Œï¼
const { data, isLoading, error } = useQuery({
  queryKey: ['key'],
  queryFn: fetchData
})

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»å†å–å¾—ã€å…¨ã¦è‡ªå‹• âš¡âš¡âš¡
```

**ã‚³ãƒ¼ãƒ‰å‰Šæ¸›**: -70ã€œ90% ğŸ“

---

## ğŸ¯ å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½

### ScenarioManagement

- âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆè‡ªå‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
- âœ… ä½œæˆãƒ»æ›´æ–°ï¼ˆæ¥½è¦³çš„æ›´æ–°ï¼‰
- âœ… å‰Šé™¤ï¼ˆæ¥½è¦³çš„æ›´æ–°ï¼‰
- âœ… CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- âœ… CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- âœ… ã‚¿ãƒ–ã«æˆ»ã£ãŸã‚‰è‡ªå‹•æ›´æ–°
- âœ… 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿æŒ

---

## ğŸ“ˆ ç´¯è¨ˆæ”¹å–„åŠ¹æœ

### Phase 1ã€œ3.3 + React Query

| æŒ‡æ¨™ | æ”¹å–„å‰ | Phase 3.3 | React Query | æ”¹å–„ç‡ |
|------|--------|-----------|-------------|--------|
| **åˆå›ãƒ­ãƒ¼ãƒ‰** | 15ã€œ20ç§’ | 1ã€œ1.5ç§’ | 1ã€œ1.5ç§’ | -93% |
| **ãƒšãƒ¼ã‚¸é·ç§»** | 1.5ç§’ | 1.5ç§’ | **0.1ç§’** | **-93%** â­ï¸â­ï¸â­ï¸ |
| **å‰Šé™¤æ“ä½œ** | 1.5ç§’ | 1.5ç§’ | **å³åº§** | **-95%** â­ï¸â­ï¸â­ï¸ |
| **APIå‘¼ã³å‡ºã—** | 100å›/ã‚»ãƒƒã‚·ãƒ§ãƒ³ | 100å› | **10ã€œ20å›** | **-80ã€œ90%** ğŸ’° |

---

## ğŸŒŸ ä½“æ„Ÿã§ãã‚‹æ”¹å–„

### 1. **ãƒšãƒ¼ã‚¸é·ç§»ãŒçˆ†é€Ÿ** âš¡âš¡âš¡

```
ã‚·ãƒŠãƒªã‚ªç®¡ç† â‡„ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†

Before: æ¯å› 1.5ç§’å¾…ã¡
After:  2å›ç›®ä»¥é™ 0.1ç§’ âš¡

ä½“æ„Ÿ: ç¬æ™‚ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ï¼
```

---

### 2. **å‰Šé™¤ãƒ»æ›´æ–°ãŒç¬æ™‚ã«åæ˜ ** âš¡âš¡âš¡

```
ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤

Before: 
1. ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
2. å¾…æ©Ÿ... 1.5ç§’ ğŸ˜«
3. ã‚„ã£ã¨æ¶ˆãˆã‚‹

After:
1. ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
2. å³åº§ã«æ¶ˆãˆã‚‹ï¼âš¡ï¼ˆ0.1ç§’ï¼‰
3. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§APIå®Ÿè¡Œ

ä½“æ„Ÿ: 10å€ä»¥ä¸Šé€Ÿã„ï¼
```

---

### 3. **å¸¸ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º** ğŸ”„

```
ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤‰æ›´ã‚’åŠ ãˆã‚‹

Before:
- æ°—ã¥ã‹ãªã„...
- æ‰‹å‹•ã§ãƒªãƒ­ãƒ¼ãƒ‰ãŒå¿…è¦

After:
- ã‚¿ãƒ–ã«æˆ»ã£ãŸã‚‰è‡ªå‹•æ›´æ–° âš¡
- å¸¸ã«æœ€æ–°çŠ¶æ…‹
```

---

## ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### ä»–ã®ãƒšãƒ¼ã‚¸ã¸ã®å±•é–‹

ç¾åœ¨ ScenarioManagement ã®ã¿å®Ÿè£…æ¸ˆã¿ã€‚

**æ¨å¥¨é †åº**:

1. **StaffManagement** - ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
2. **StoreManagement** - åº—èˆ—ç®¡ç†
3. **ReservationManagement** - äºˆç´„ç®¡ç†
4. **SalesManagement** - å£²ä¸Šç®¡ç†
5. **ShiftSubmission** - ã‚·ãƒ•ãƒˆæå‡º

**å®Ÿè£…æ™‚é–“**: 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Š 20ã€œ30åˆ†

---

### é«˜åº¦ãªæ©Ÿèƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### 1. **Infinite Queryï¼ˆç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰**
```typescript
const { data, fetchNextPage } = useInfiniteQuery({
  queryKey: ['scenarios'],
  queryFn: ({ pageParam = 0 }) => fetchScenarios(pageParam),
  getNextPageParam: (lastPage) => lastPage.nextCursor
})

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«è‡ªå‹•ã§æ¬¡ã®ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ âš¡
```

#### 2. **Prefetchingï¼ˆå…ˆèª­ã¿ï¼‰**
```typescript
// ã‚·ãƒŠãƒªã‚ªãƒªã‚¹ãƒˆã§å„é …ç›®ã«ãƒ›ãƒãƒ¼ã—ãŸã‚‰è©³ç´°ã‚’å…ˆèª­ã¿
const prefetch = () => {
  queryClient.prefetchQuery({
    queryKey: ['scenario', id],
    queryFn: () => fetchScenarioDetail(id)
  })
}

// è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«ã¯ã™ã§ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ âš¡âš¡âš¡
```

#### 3. **React Query Devtools**
```bash
npm install @tanstack/react-query-devtools
```

```typescript
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'

<QueryClientProvider client={queryClient}>
  <App />
  <ReactQueryDevtools initialIsOpen={false} />
</QueryClientProvider>

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèª ğŸ”
```

---

## ğŸ‰ ã¾ã¨ã‚

### å®Ÿè£…å®Œäº†

React Query ã‚’ ScenarioManagement ã«å°å…¥ã—ã¾ã—ãŸï¼

### ä¸»ãªæˆæœ

```
ãƒšãƒ¼ã‚¸é·ç§»:    1.5ç§’ â†’ 0.1ç§’ï¼ˆ-93%ï¼‰âš¡âš¡âš¡
å‰Šé™¤æ“ä½œ:      1.5ç§’ â†’ å³åº§ï¼ˆ-95%ï¼‰âš¡âš¡âš¡
APIå‘¼ã³å‡ºã—:   -80ã€œ90% å‰Šæ¸› ğŸ’°
ã‚³ãƒ¼ãƒ‰é‡:      -70% å‰Šæ¸› ğŸ“
```

### ä½“æ„Ÿé€Ÿåº¦

```
Before: ã€Œé€Ÿã„ã€ï¼ˆPhase 3.3 å®Œäº†å¾Œï¼‰
After:  ã€Œã‚ã¡ã‚ƒãã¡ã‚ƒé€Ÿã„ã€âš¡âš¡âš¡

ç‰¹ã«æ”¹å–„ã•ã‚Œã‚‹æ“ä½œ:
- ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆ2å›ç›®ä»¥é™ï¼‰: ç¬æ™‚
- å‰Šé™¤ãƒ»æ›´æ–°æ“ä½œ: ç¬æ™‚
- ãƒ‡ãƒ¼ã‚¿åŒæœŸ: è‡ªå‹•
```

### ç·åˆæ”¹å–„åŠ¹æœ

```
Phase 1-3.3:  15ç§’ â†’ 1.5ç§’ï¼ˆ-90%ï¼‰
React Query:  ãƒšãƒ¼ã‚¸é·ç§» 0.1ç§’ï¼ˆ2å›ç›®ä»¥é™ï¼‰

â†’ SPA ã¨ã—ã¦å®Œç’§ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ â­ï¸â­ï¸â­ï¸
```

---

**å®Ÿè£…æ—¥æ™‚**: 2025-10-19  
**å®Ÿè£…è€…**: AI Assistant  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ScenarioManagement å®Œäº† âœ…  
**æ¨å¥¨**: ä»–ã®ãƒšãƒ¼ã‚¸ã«ã‚‚å±•é–‹æ¨å¥¨ ğŸš€

