import os
import re
from datetime import datetime, time, timedelta
from supabase import create_client, Client
from dotenv import load_dotenv

# 環境変数の読み込み（.env.localも読み込む）
load_dotenv('.env.local')
load_dotenv()

# Supabaseクライアントの初期化（環境変数が設定されていない場合はNone）
SUPABASE_URL = os.getenv("VITE_SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_SERVICE_ROLE_KEY") or os.getenv("VITE_SUPABASE_ANON_KEY")

if not SUPABASE_URL:
    print("警告: VITE_SUPABASE_URLが設定されていません")
    print("環境変数を設定するか、.envファイルを作成してください")
    print("\n使い方:")
    print("  export VITE_SUPABASE_URL='your-url'")
    print("  export SUPABASE_SERVICE_ROLE_KEY='your-key'")
    print("  python3 import_schedule_from_spreadsheet.py")
    SUPABASE_URL = None
    SUPABASE_KEY = None
    supabase = None
else:
    supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# 店舗名→store_id のマッピング
STORE_MAPPING = {
    "大久保": "bef973a7-faa2-466d-afcc-c6466f24474f",
    "馬場": "45e39d14-061f-4d01-ae8a-5d4f8893e3cd",
    "別館①": "0269032f-6059-440b-a429-9a56dbb027be",
    "別館②": "95ac6d74-56df-4cac-a67f-59fff9ab89b9",
    "大塚": "f94256c3-e992-4723-b965-9df5cd54ea81",
    "埼玉大宮": "8a254b6d-9293-42c6-b634-e872c83fc4fd",
    "京都出張": None  # 出張はstore_idなし（offsite）
}

# スプレッドシートデータ（提供されたデータ）
SCHEDULE_DATA = """
11/1	土	ジノ	馬場	GMテスト・エイダ（9-13)3000円	渚咲(そら）🈵	貸・赤の導線(14-18.5)てんてんわん様 5000円	ぴよな	GMテスト・・作品未定	だいこん
11/1	土	ジノ	別館①	貸・立方館(9-16)大和果鈴様　9000円	ぽったー			貸・inthebox〜長い熱病(17-22.5)崎会　 6000円	じの（崎、シラヤマ参加）
11/1	土	ジノ	大久保	貸・クロノフォビア(9-13)Tamura Yuki様　5000円	つばめ	貸・超特急の呪いの館で撮れ高足りてますか？(14-18)近藤千里様　5000円	ソラ→つばめ	貸・曙光のエテルナ(19-23) 高塚 友紀様　4500円	つばめ
11/1	土	ジノ	大塚	貸・シノポロ(9-12.5)石川つかさ様　4000円	りえぞー（指定）	貸・朱き亡国に捧げる祈り(13.5-17)岩村様　4500円	れいにー	貸・テセウスの方舟(18.5-22.5)えっちゃん様　4500円	ほがらか
11/1	土	ジノ	埼玉大宮			貸・或ル胡蝶ノ夢(15-19.5)小松麻里様　5000円	りえぞー	募・invisible(20.5-22.5)　3500円に変更✅	りえぞー
11/2	日	ジノ	馬場	貸・シノポロ(9-12.5)  大久保 沙奈様　4000円	さき（指定）	貸・或ル胡蝶ノ夢(14-18.5)新井紫緒様　5000円	りえぞー	募・燔祭のジェミニ(19.5-23)✅	りえぞー
11/2	日	ジノ	別館①	貸・超特急の呪いの館で撮れ高足りてますか？(9-13)川崎 希望様　5000円	つばめ	貸・探ぱんマーダーミステリー・ノーショーツトルダム学園殺人事件(14-17.5)大久保 沙奈様　4500円	じの	貸・ENIGMACODE廃棄ミライの犠牲者たち(18.5-22.5)おゆき様　4500円	れみあ
11/2	日	ジノ	大久保	貸・土牢は悲鳴に谺して(9-13) Tamura Yuki様　4500円	まつい	貸・或ル胡蝶ノ夢(14-18.5)後藤　幸矩様　5000円※観戦一名	まつい	貸・漣の向こう側(19.5-22.5)内藤 璃歩様　4500円	じの
11/2	日	ジノ	大塚	貸・赤の導線(9-13)及川 歩起様　5000円	しらやま	貸・百鬼の夜、月光の影(14-18)鍵谷春奈様　4500円	しらやま	貸・黒と白の狭間に(19-22.5)石橋美弓様　4000円	しらやま
11/2	日	ジノ	埼玉大宮	募・オペレーションゴーストウィング（10-13)　4500円✅	そら	貸・銀世界のアシアト(14-18)新川春様　5000円	そら	募・テセウスの方舟・(19-23)　4500円✅	そら
11/3	月	ツバメ	馬場	GMテスト・境界線のカーサスベリ(9-13.5)3500円	さき（BB参加）🈵	貸・超特急の呪いの館で撮れ高足りてますか？(14.5-18)小野唯奈様　5000円	そら→きゅう	貸・シノポロ(19-22.5)ぎゅうタン様　4000円	きゅう（指定）
11/3	月	ツバメ	別館①	募・赤鬼が泣いた夜(9-12.5)✅	まつかさ	貸・5DIVE(13.5-17.5)後藤 菜緒美様	キュウ（デカホワイトボード用意する）→ぴよな	貸・ENIGMACODE廃棄ミライの犠牲者たち(18.5-22.5)あんこ様　4500円	じの
11/3	月	ツバメ	大久保	貸・漣の向こう側(10-13)小倉彩記子様　4500円	じの	貸・天使は花明かりの下で(14-18)渡邉麻衣子様　450０円	しらやま	貸・花街リグレット(19-23)五十嵐春緋様　4500円	しらやま
11/3	月	ツバメ	大塚	貸・或ル胡蝶ノ夢(9-13.5)吉田志穂様　5000円	まつい	貸・MurderWonderLand(15-18)太田千裕様※８名予定　4000円	ツバメ→みずき	募・百鬼の夜月光の影（19-23)　4500円 ✅	みずき
11/3	月	ツバメ	埼玉大宮	募・クロノフォビア・(9-13)　5000円✅	つばめ	募・藍雨廻逢・(14-18)　4500円✅	つばめ	募・曙光のエテルナ(19-23)　4500円✅	つばめ
11/4	火	ツバメ	馬場			GMテスト・魂を運ぶ飛行船（12-16)	かなう（つばめ見学）@3	GMテスト・超特急の呪いの館で撮れ高足りてますか？（19-23）	ぴよな（@7人）
11/4	火	ツバメ	別館①					GMテスト・絆の永逝（18-22.5)　再生機器必要	つばめ（ソルト、らく、リンナ、ジノ、まつかさ、温風リン、小川はねか）（カナデ見学）
11/4	火	ツバメ	大久保			募・違人（13-17)　5000円✅	きゅう	貸・違人（19-23)藤澤 七海様	きゅう（指定）
11/4	火	ツバメ	大塚			GMテスト・藍雨廻逢(13-17)	じの（りえぞー参加）	募・アンフィスバエナと聖女の祈り（19-23)　5000円✅	りえぞー
11/5	水	ツバメ	馬場	MTG				貸・invisible -亡霊列車-(19-21)野村 理博様	じの
11/5	水	ツバメ	別館①			GMテスト・帰路に降り立つ（13-17)	らぼ	GMテスト・ある悪魔の儀式について（19.5-22.5)	れみあ（らぼ→奏兎、りえぞー、そると、ほがらか、みずき、まつかさ）
11/5	水	ツバメ	大久保			募・異能特区シンギュラリティ(13.5-17)　4500円　✅告知待ち	あんころ	貸・マーダー・オブ・エクスプローラー　失われし大秘宝(19-22)豊田裕子様	そら
11/5	水	ツバメ	大塚			GMテスト・この闇をあなたと（12-17)事前配役教える	らの（セッティング教える＝ソラ）	貸・曙光のエテルナ(19-23)厚谷 昇汰様	つばめ
11/6	木	ツバメ	馬場			GMテスト・機巧人形の心臓（3500円〜4000円）12-16.5	りえぞー	貸・学校の解談(18.5-23)若林宗一郎様	りえぞー（指定）
11/6	木	ツバメ	別館①			GMテスト・作品未定	カナデ・江波見学	募・赤鬼が泣いた夜（19.5-22.5)　4500円✅	まつかさ
11/6	木	ツバメ	大久保			(仮)GMテスト・作品未定	みかのは	(仮)GMテスト・曙光のエテルナ(19-23)	えりん
11/6	木	ツバメ	大塚			募・テセウスの方舟（13-17)　4500円✅	ほがらか	募・月光の偽桜（19-23)　4500円✅	しらやま
11/7	金	ツバメ	馬場			GMテスト・超特急の呪いの館で撮れ高足りてますか？(13~17)	あんころ@6	貸・Invisible-亡霊列車-(19.5-21.5)有山 みやこ様	そら
11/7	金	ツバメ	別館①			GMテスト・絆の永逝（11.5-16.5)　再生機器必要	つばめ(ミカノハ見学)	募・異能特区シンギュラリティ（19-22.5)　4500円 未告知	あんころ
11/7	金	ツバメ	大久保			GMテスト・妖怪たちとと月夜の刀（13-17)	そら	GMテスト・オペレーションゴーストウィング（19.5-22.5)	まつかさ(そら見学）
11/7	金	ツバメ	大塚			貸・立方館(12-19）おおもと様　9000円	まつい	募・あるマーダーミステリーについて(20-23)　4000円 ✅	まつい
11/7	金	ツバメ	埼玉大宮					募・テセウスの方舟（19-23)✅	つばめ
11/7	金	ツバメ	京都出張	朝・じの新幹線		出張・	じの	出張・	じの
11/8	土	ツバメ	馬場	貸・電脳の檻のアリス(9-13)長原史枝様　5000円	りえぞー	貸・或ル胡蝶ノ夢(14-18.5)えは様　5000円	まつい	募・小暮事件に関する考察(19.5-23)　4500円✅	まつい
11/8	土	ツバメ	別館①	貸・狂気山脈　星降る天辺（２）(9-13)坂本夏奈様　4500円	れみあ	貸・モノクローム(14-18)即寝様※観戦3名　5500円	メイン:さき サブ:もりし	募・ツグミドリ(19-22.5)　4500円✅	りえぞー
11/8	土	ツバメ	大久保	貸・シノポロ(9.5-13)ひかる様　4000円	えりん	貸・シノポロ(14-17.5)後藤明花莉様　4000円	えりん	貸・月光の偽桜(18.5-22,5)笠間　成美 様　4500円	ぴよな
11/8	土	ツバメ	大塚	貸・テセウスの方舟(9-13)向坪智聡様　4500円	つばめ	貸・エデンの審判(14-18)pocket様　4500円	きゅう	貸・テセウスの方舟(19-23)工藤 遼亮様　4500円	つばめ(みずき参加)
11/8	土	ツバメ	埼玉大宮	募・殺人鬼Xの独白(10-13)	そら	貸・殺人鬼Xの独白(14-17)大竹信輔様　4500円	そら	貸・オペレーションゴーストウィング(19-22)秋山 優太様　4500円	そら
11/8	土	ツバメ	京都出張	出張・新世界のユキサキ(8.5-12.5)	じの	出張・エニグマコード(13.5-17.5)	じの	出張・エニグマコード(18.5-22.5)	じの
11/9	日	ツバメ	馬場	貸・超特急の呪いの館で撮れ高足りてますか？(9-13)鈴木嘉世様　5000円	ソラ→ぴよな	貸・超特急の呪いの館で撮れ高足りてますか？(14-18)安達瑞姫様　5000円	ソラ→ぴよな	貸・或ル胡蝶ノ夢(19-23)斉藤 厚志様 5000円	みずき
11/9	日	ツバメ	別館①	GMテスト・inthebox〜長い熱病(9-15)揃揃〜！4500円案内です	さき	テストプレイ・雲の子ライチとびいどろの花（17-22)	江波、れみあ、だいこん、崎、まつかさ仮、まつぼう、らの、なう	テストプレイ・雲の子ライチとびいどろの花（17-22)	江波
11/9	日	ツバメ	大久保	貸・フェイクドナー(9-13)坂口 真也様※８名　4500円	しらやま	貸・月光の偽桜(14-18)盧森海藍様　4500円	ピヨナ→しらやま	募・月光の偽桜（19-23)✅	しらやま
11/9	日	ツバメ	大塚	GMテスト▪️鳴神様の言うとおり（9-14)▪️3000円▪️揃	渚咲(つばめ）	貸・Murder Wonder land(15-18)高島梨杏様　4000円	つばめ（渚咲見学）	募・テセウスの方舟(19-23)✅	つばめ
11/9	日	ツバメ	埼玉大宮	募・ブルーダイヤ（9.5-12.5)✅告知待	そら	貸・NOVAK様　殺意の特異点　貸し出し(13:30-18:30)	そら受付	募・ブルーダイヤ(19.5-22.5)✅	そら
11/9	日	ツバメ	京都出張	出張・機巧人形の心臓(9-13.5)	じの	出張・テセウスの方舟(14.5-18.5)	じの	出張・彗星蘭の万朶	じの
11/10	月	ソラ	馬場			(仮)GMテスト・妖怪たちと月夜の刀（13-17)	あんころ	GMテスト・オペレーションゴーストウィング（19.5-22.5)	まつかさ（マネージャー見学なし）
11/10	月	ソラ	別館①			GMテスト・オペレーションゴーストウィング（14-17)	ようむき（ソラ見学）	募・あるマーダーミステリーについて（19.5-22.5)✅	えりん
11/10	月	ソラ	大久保	貸・月光の偽桜(10-14)三枝 玉輝様　4500円	つばめ	GMテスト・ある悪魔の儀式について（15-18)	温風リン（ツバメ参加）	貸・ナナイロの迷宮 緑 アペイロン研究所殺人事件(19-22.5)角 聡様　4500円	つばめ(ソルト参加)
11/10	月	ソラ	大塚			募・蟻集（13-17.5)✅	きゅう	募・超特急マダミス(19-23)✅	きゅう
11/10	月	ソラ	埼玉大宮					募・ブルーダイヤの不在証明（19.5-22.5)✅告知待	そら
11/11	火	ソラ	馬場			（仮）GMテスト・作品未定	そうたん	貸・Invisible-亡霊列車-(19-21)金子 周平様 3000円	そら
11/11	火	ソラ	別館①			GMテスト・異能特区シンギュラリティ（13-17)	楽（アンコロ見学	募・殺人鬼Xの独白（19.5-22.5)✅	まつい
11/11	火	ソラ	大久保			募・漣の向こう側（13-16）✅	じの	GMテスト・作品未定	おむ・じの見学
11/11	火	ソラ	大塚			GMテスト・作品未定	そると	GMテスト・ある悪魔の儀式について（20-)	BB（江波見学）@満席
11/12	水	ソラ	馬場	MTG				貸・傲慢女王とアリスの不条理裁判(19-23)吉成 慶美様 4500円	しらやま
11/12	水	ソラ	別館①			テストプレイ・夏目	ホガラカ、ソルト、アンコロ、ポッター、レミア、温風リン	GMテスト・ブルーダイヤの不在証明	じの（らぼ
11/12	水	ソラ	大久保			募・花街リグレット（13-17)✅	きゅう	貸・花街リグレット(19-23)阿部 友梨加様 4500円	きゅう（指定）
11/12	水	ソラ	大塚			GMテスト・REDRUM01泉涌館の変転	らぼ	貸・或ル胡蝶ノ夢(19-23)厚谷 昇汰様 5000円	りえぞー
11/12	水	ソラ	埼玉大宮					募・ブルーダイヤの不在証明（19.5-22.5）✅告知待	そら
11/13	木	ソラ	馬場			GMテスト・ENIGMA CODE（12.5-17)	らの（じの見学）	貸・ツグミドリ(19-22.5)若林宗一郎様　4500円	ソラ
11/13	木	ソラ	別館①			体験会・キアロスクーロ（10-15)	江波、ソラ、ほがらか、マツケン、ラク、りんな、かなで	募・赤鬼が泣いた夜(19.5-22.5)✅	まつかさ
11/13	木	ソラ	大久保			GMテスト・赤鬼が泣いた夜	みかのは	募・あくなき世界で嘘をうたう(19.5-23)✅	みずき
11/13	木	ソラ	大塚			GMテスト・赤の導線（12.5-17)	つばめ	（仮）GMテスト・テセウスの方舟(19-23)	まつい
11/14	金	ソラ	馬場			GMテスト・カノケリ	りんな	貸・Invisible-亡霊列車-(20-22)さく会　3000円	じの
11/14	金	ソラ	別館①			GMテスト・作品未定	N・江波見学	募・ある悪魔の儀式について(19.5-22)✅	れみあ
11/14	金	ソラ	大久保			募・異能特区シンギュラリティ（13.5-17)✅告知待	あんころ	GMテスト・作品未定	松坊・つばめ見学
11/14	金	ソラ	大塚			貸・シノポロ(13-16.5)佐藤 文香様　4000円	きゅう（指定）	貸・藍雨廻逢(19-23)小倉 彩記子様　4500円	そら
11/15	土	ソラ	馬場	貸・超特急の呪いの館で撮れ高足りてますか？(9-12.5) 茂木 美優様　5000円	そら	貸・モノクローム(14-18)小沼武司様　5500円	メイン：しらやま サブ：もりし	貸・或ル胡蝶ノ夢(19-23) 伊東 直人様　5000円	しらやま
11/15	土	ソラ	別館①	貸・学校の解談(9-13.5)にあぐりっど様　5000円	えりん	貸・超特急の呪いの館で撮れ高足りてますか？(14.5-18.5)池田奈央 様　5000円	ぴよな	募・裂き子さん（19.5-22.5)　4500円✅	ぴよな
11/15	土	ソラ	大久保	貸・境界線のカーサスベリ(8.5-13)鍵屋 正篤様　5000円	さき	貸・土牢に悲鳴は谺して(14-18)　4500円	まつい	貸・曙光のエテルナ(19-23)小林 謙斗様　4500円	つばめ⚪︎
11/15	土	ソラ	大塚	貸・曙光のエテルナ(9-13)中村 紗乃様　4500円	つばめ	貸・土牢に悲鳴は谺して(14-18)ととさん様　4500円	そら（ここまでに覚える）	貸・魂を運ぶ飛行船(19-23)苺もち様　4500円	そると
11/15	土	ソラ	埼玉大宮	貸・テセウスの方舟(9-13)もね様　4500円	じの	貸・曙光のエテルナ(14-18)もね様　4500円	じの	募・曙光のエテルナ(19-23)　4500円✅	じの
11/16	日	ソラ	馬場	貸・超特急の呪いの館で撮れ高足りてますか？(9-13)阿曽 妃陽様　5000円	ぴよな	貸・シノポロ(14.5-18)五十嵐春緋様　4000円	きゅう（指定）	貸・シノポロ(19-22.5)矢口 千紗様　4000円	きゅう
11/16	日	ソラ	別館①	貸・霧に眠るは幾つの罪(9-15)小野 拓磨様　6500円	さき			募・霧に眠るは幾つの罪（17-23) 6500円✅	崎
11/16	日	ソラ	大久保	貸・超特急の呪いの館で撮れ高足りてますか？(9-13)佐藤瑶子様 5000円	そら	貸・或ル胡蝶ノ夢(14-18.5)小林祐哉様 5000円	あんころ	募・くずの葉のもり（19.5-22.5)　4500円	じの
11/16	日	ソラ	大塚	貸・エンドロールは流れない(9-13)小澤 翔太様　5000円	そると	貸・燔祭のジェミニ(14.5-18)猫杜様　4500円	じの	貸・リトルワンダー(19.5-23)中川瞳様　4000円	つばめ
11/16	日	ソラ	埼玉大宮	募・藍雨廻逢(9-13) 4500円✅	らの	貸・藍雨廻逢(14-18)眞田 塁様　4500円	らの（ここまでに覚える）	募・藍雨廻逢(19-23) 4500円✅	らの
11/17	月	ジノ	馬場			募・機巧人形の心臓（13-17.5) 5000円✅	じの	貸・invisible(19-21)藤井 康介様　3000円	じの
11/17	月	ジノ	別館①	える18人用テスプ・レガストリアの玉座（10-18)		える18人用テスプ・レガストリアの玉座（10-18)	エナミ、ソルト、雨宮ラノ、温風リン、ヨウムキ、カナウ、崎、ダイコン、シラヤマ、リンナ、アンコロ、ツバメ、マツケン、ひなどり、kanade、ぽったー、ナウ、ソラ、ピヨナ、さく仮		
11/17	月	ジノ	別館②	える18人用テスプ・レガストリアの玉座（10-18)		える18人用テスプ・レガストリアの玉座（10-18)			
11/17	月	ジノ	大久保					募・漣の向こう側（20-23）　4500円✅	つばめ
11/17	月	ジノ	大塚			募・蝉散（13-17.5) 5500円✅	きゅう	募・超特急マダミス(19-23)　5000円✅	きゅう
11/18	火	ジノ	馬場			GMテスト・凪の鬼籍	つばめ（カナデ、ヒナドリ、あんころ、えなみ、そうたん、えぬ、ほがらか）	GMテスト・全能のパラドックス(18.5-23)	BB（じの参加）
11/18	火	ジノ	別館①			工事予定		貸・ある悪魔の儀式について(19-21.5)シラヤマ会　4500円	れみあ？(シラヤマ参加)
11/18	火	ジノ	大久保			募・流年（12-18)✅	もりし	募・あくなき世界で嘘をうたう(19.5-23)　4500円✅	りんな
11/18	火	ジノ	大塚			GMテスト・オーバーキル	じの	GMテスト・月光の偽桜（19-23)or（18.5-23)	まつかさ（ツバメ見学）
11/19	水	ジノ	馬場	MTG		ヒナドリさんきてもらう？		貸・ENIGMA CODE 廃棄ミライの犠牲者たち(19-23)ATK様　4500円	じの
11/19	水	ジノ	別館①			工事予定		GMテスト・曙光のエテルナ（19-23)	温風リン（そら見学）
11/19	水	ジノ	大久保			募・違人(13-17)5000円✅	きゅう	募・岐路に降り立つ(19-23) 4500円✅	きゅう
11/19	水	ジノ	大塚			GMテスト・・作品未定	ぽったー	貸・黒と白の狭間に(19-22.5)大澤 翔平様　4000円	れみあ
11/19	水	ジノ	埼玉大宮					募・あるマーダーミステリーについて（19.5-22.5) 4000円✅	らぼ
11/20	木	ジノ	馬場			（仮）GMテスト・作品未定	そうたん	貸・曙光のエテルナ(19-23)馬場園 祐己様 4500円	じの（参加：BBです）
11/20	木	ジノ	別館①			工事予定		GMテスト・作品未定	ひなどり（そら見学）
11/20	木	ジノ	大久保			GMテスト・凪の鬼籍（みかのはさん、温風リンさん参加できる時間帯で調整する）	つばめ（カナデ見学）、りんな、みかのは、ジノ、もりし、らく、ようむき、温風リン）	貸・くずの葉のもり(19-22)いろはす様4500円	つばめ
11/20	木	ジノ	大塚			GMテスト・蟻集（13-17）	ぴよな（参加者募集中！希望の方はぴよなまで）	テストプレイ・女王と偽りのマテリアル	そら
11/21	金	ジノ	馬場			GMテスト・作品未定	ひなどり（ソラ見学）	GMテスト・曙光のエテルナ（19-23)	そら
11/21	金	ジノ	別館①			工事予定		GMテスト・作品未定	松坊（じの見学）
11/21	金	ジノ	大久保			GMテスト・作品未定	カナデ（ツバメ見学）	GMテスト・月光の偽桜（19-23)or（18.5-23)	まつかさ（ツバメ見学）
11/21	金	ジノ	大塚			募・蟻集(13-17)5000円✅	きゅう	募・蝉散（18.5-23)　5500円　✅	きゅう
11/22	土	ジノ	馬場	貸・機巧人形の心臓(9-13.5)小西達也様　5000円	じの（指定）	貸・機巧人形の心臓(14.5-19)みかちゅう様　5000円	じの	貸・オペレーションゴーストウィング(20-23)キュウ貸切　4500円	そら
11/22	土	ジノ	別館①	貸・シノポロ(9-12.5)室井　里佳子 様　4000円	れみあ	貸・ロスト／リメンブランス(13.5-18)野村 太一様　5500円	れみあ	GMテスト・ある悪魔の儀式について(19.5-22.5)	らの（じの見学）
11/22	土	ジノ	大久保	GMテスト・殺神罪（9-13)	おむ（つばめ見学）	貸・くずの葉のもり(14-17)安間海斗様　4500円	つばめ	貸・月光の偽桜(18-22)むぎ様　4500円	つばめ
11/22	土	ジノ	大塚	募・ロスト／リメンブランス（9-13.5)　5500円✅	らぼ	貸・立方館(15-23)山﨑鈴乃様　9000円	らぼ		
11/22	土	ジノ	埼玉大宮	募・境界線のカーサスベリ(9-13.5)　5000円✅	そら→かなで	募・オペレーションゴーストウィング（14.5-17.5)　4500円✅	そら→かなで		かなで
11/23	日	ジノ	馬場	貸・曙光のエテルナ(9-13)木村 美友様　4500円	つばめ	貸・或ル胡蝶ノ夢(14-18.5)瀬戸美月様　5000円	りんな	募・傲慢女王とアリスの不条理裁判(19.5-23)　4500円✅	りんな
11/23	日	ジノ	別館①	募・In the box 〜長い熱病(10-15.5)　6000円✅	さき			貸・ In the box〜長い熱病(17-22.5)大堀 国広様　6000円	さき
11/23	日	ジノ	大久保	貸・超特急の呪いの館で撮れ高足りてますか？(9-12.5)樺島 桃子様　5000円	そら	貸・流年(13.5-19)しまにゅー様　6000円	えりん	貸・ある悪魔の儀式について(20-22.5)大野 龍仁様　4500円	れみあ
11/23	日	ジノ	大塚	貸・狂気山脈 3.0 薄明三角点(9-13)栗崎華菜子 様　4500円	れみあ	貸・機巧人形の心臓(14-18.5)松井優果様　5000円	ぴよな	貸・超特急の呪いの館で撮れ高足りてますか？(19.5-23)室山 愛実様　5000円	ぴよな
11/23	日	ジノ	埼玉大宮		かなで	打診・月光の偽桜（14.5-18.5)　4500円	そら→かなで	打診・殺人鬼Xの独白(19.5-22.5)　4500円	そら→かなで
11/24	月	ツバメ	馬場	貸・立方館(9-16)栗山千妃呂様　9000円	まつい			貸・境界線のカーサスベリ(17.5-22)むぎ様　5000円	さき
11/24	月	ツバメ	別館①	貸・霧に眠るは幾つの罪(9-15)大堀様　6500円	さき			貸・違人(18.5-22.5)ひかる様　5000円	らぼ
11/24	月	ツバメ	大久保	募・ゼロの爆弾（10-12.5)　4000円✅	らの	貸・超特急の呪いの館で撮れ高足りてますか？(13.5-17.5)清水果帆子様　5000円	きゅう	貸・Recollection　(18.5-23)笠間成美様　5000円	そら
11/24	月	ツバメ	大塚	貸・ニィホン(9-13)加瀬 朝望様　4500円	えりん（指定）	貸・不思議の国の童話裁判　(14-18)エリン経由　5500円	アリス:えりん（指定） 黒子:じの（指定）	貸・藍雨廻逢(19-23)とも様　5000円	じの
11/24	月	ツバメ	埼玉大宮	貸・曙光のエテルナ(8.5-12.5)酒巻 憲二様　4500円	つばめ	貸・赤の導線(13.5-18)金子様　5000円	つばめ	貸・黒と白の狭間に(19-22.5）しろの様　4000円	つばめ
11/25	火	ツバメ	馬場			GMテスト・作品未定	かなう・つばめ見学	募・アンフィスバエナと聖女の祈り(19-23)✅	りえぞー
11/25	火	ツバメ	別館①		工事入ったら別場所確保	テストプレイ・夏目さん新作（12-17)	キュウ、リエゾー、ヒナドリ、さく、えいきち仮、	募・超特急の呪いの館で撮れ高足りてますか？(19-22.5)✅	キュウ
11/25	火	ツバメ	大久保			GMテスト・作品未定	そると	GMテスト・全能のパラドックス(18.5-23)	BB
11/25	火	ツバメ	大塚			EGGさん出張	じの受付	EGGさん出張	蝿の王（じの参加・受付）
11/26	水	ツバメ	馬場	MTG				貸・モノクローム(19-23)細井 梓様　5000円	メイン：しらやま(指定) サブ：もりし
11/26	水	ツバメ	別館①			工事予定		貸・藍雨廻逢(19-23)太田 拓哉様　4500円	そら
11/26	水	ツバメ	大久保			EGGさん出張	マネージャー受付時に行く	EGGさん出張	じの受付
11/26	水	ツバメ	大塚			募・立方館（10-17)✅	らぼ	貸・ヨスメガポーカー	labo参加
11/27	木	ツバメ	馬場			(仮)GMテスト・藍雨廻逢(13-17)	りんな	貸・シノポロ(19.5-23）相馬 悠子様　4000円	えりん（指定）
11/27	木	ツバメ	別館①			工事予定		GMテスト・ある悪魔の儀式について（19.5-22.5)	BB（マネージャー見学なし）
11/27	木	ツバメ	大久保	EGGさん出張	そらorつばめ受付	EGGさん出張	そらorつばめ受付	貸・赤鬼が泣いた夜(19-22.5)古賀会	つばめ
11/27	木	ツバメ	大塚			GMテスト・ひなどり	じの	貸・機巧人形の心臓(18.5-23）栗本 英理子様　5000円	じの
11/28	金	ツバメ	馬場			(仮)GMテスト・藍雨廻逢(13-17)	あんころ	貸・Invisible-亡霊列車-(19-21）リエゾー経由　3000円	りえぞー(指定)
11/28	金	ツバメ	別館①		工事入ったら別場所	える18人用テスプ・レガストリアの玉座（15-23)	しも、ジェシカ、まどか、ゆうすけ、りゅぁ、前ちゃん、夏目、ほがらか、そうたん、ジノ、N、らく（りんな見学)@8	える18人用テスプ・レガストリアの玉座（15-23)	
11/28	金	ツバメ	別館②			える18人用テスプ・レガストリアの玉座（15-23)		える18人用テスプ・レガストリアの玉座（15-23)	
11/28	金	ツバメ	大久保			GMテスト・ゼロの爆弾(14-17)（3500円）	ようむき（そら見学）	貸・THE REAL FOLK '30s(19.5-22.5)五十嵐春緋 様　4500円	そら
11/28	金	ツバメ	大塚			募・機巧人形の心臓（12.5-17)✅	ぴよな	募・電脳の檻のアリス（19-23)✅	ぴよな
11/28	金	ツバメ	埼玉大宮					募・岐路に降り立つ（19-23）	らぼ
11/29	土	ツバメ	馬場	貸・或ル胡蝶ノ夢(9-13)松尾 悠様　　5000円	りんな	貸・赤の導線(14-18.5)坂口真也様　　5000円	ぴよな	募・スターループ→裂き子さん(19.5-22.5)　4500円✅	ぴよな
11/29	土	ツバメ	別館①	貸・超特急の呪いの館で撮れ高足りてますか？(9-13)吉澤こころ 様	そら	貸・藍雨廻逢(14-18)千様　4500円	そら	募・藍雨廻逢(19-23)　4500円✅	そら
11/29	土	ツバメ	大久保	貸・シノポロ(9-12.5)ほっとぷりん/温風リン様　4000円	れいにー（指定）	貸・機巧人形の心臓(13.5-18)キムラ様	つばめ	貸・くずの葉のもり(19-22)堀内崇様　4500円	つばめ
11/29	土	ツバメ	大塚	貸・或ル胡蝶ノ夢(9-13)飯塚 美颯様　　5000円	えりん	貸・不思議の国の童話裁判(14-18)上田浩太郎様※見学一名　4500円／1500円	メイン:みずき アリス:えりん	貸・或ル胡蝶ノ夢(19-23)横井 智哉様　　5000円	まつい
11/29	土	ツバメ	埼玉大宮	貸・機巧人形の心臓(8.5-13)佐々木 玲花様　　5000円	じの（崎参加）	貸・曙光のエテルナ(14-18)安部 なみ子様　4500円	じの	募・曙光のエテルナ(19-23)　4500円✅	じの
11/30	日	ツバメ	馬場	貸・彗星蘭の万朶(9-13.5)矢吹凪彩様　　5000円	あんころ（指定）	貸・小暮事件に関する考察(14.5-18)魚住 智子様　4500円	まつい	募・（19-23)	まつい
11/30	日	ツバメ	別館①	貸・岐路に降り立つ(9-13)山田遥香様　4500円	まつい	貸・百鬼の夜、月光の影(14-18)山田遥香様　4500円	しらやま	募・百鬼の夜、月光の影(19-23)✅	しらやま
11/30	日	ツバメ	大久保	貸・ナナイロの迷宮　緑　アペイロン研究所殺人事件(9-12.5)上垣実瑞様　4500円	つばめ	貸・花街リグレット(13.5-17.5)米谷麻美様　4500円	じの	貸・機巧人形の心臓(18.5-23)suuuu。様　　5000円	じの
11/30	日	ツバメ	大塚	貸・天使は花明かりの下で(9-13)荒井 彩花様　　4500円	みずき（指定）	貸・グロリアメモリーズ(14-18)美梁あずな様　　4500円	きゅう	貸・シノポロ(19-22.5)ましろ様　4000円	きゅう
11/30	日	ツバメ	埼玉大宮	募・（9-13)	りえぞー	貸・機巧人形の心臓(14-18.5)清水 美里様※馬場夜と検討中　　5000円	りえぞー	募・（19.5-23)	りえぞー
"""

def parse_time_from_title(title: str):
    """
    タイトルから時間を抽出
    例: "貸・シノポロ(9-12.5)" → ("09:00", "12:30")
    """
    time_match = re.search(r'\((\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)\)', title)
    if time_match:
        start = float(time_match.group(1))
        end = float(time_match.group(2))
        
        start_hour = int(start)
        start_min = int((start - start_hour) * 60)
        end_hour = int(end)
        end_min = int((end - end_hour) * 60)
        
        return (f"{start_hour:02d}:{start_min:02d}", f"{end_hour:02d}:{end_min:02d}")
    
    return None

def determine_category(title: str) -> str:
    """カテゴリを判定"""
    if title.startswith('貸・'):
        return 'private'
    elif title.startswith('募・'):
        return 'open'
    elif 'GMテスト' in title or 'テスト' in title:
        return 'gmtest'
    elif 'テストプレイ' in title or 'テスプ' in title:
        return 'testplay'
    elif title.startswith('出張・'):
        return 'offsite'
    elif 'MTG' in title:
        return 'gmtest'  # MTGもgmtestとして扱う
    else:
        return 'open'

def extract_scenario_name(title: str) -> str:
    """シナリオ名を抽出"""
    if not title or title.strip() == '':
        return ''
    
    # プレフィックスを除去
    text = re.sub(r'^(貸・|募・|出張・|GMテスト・|テストプレイ・)', '', title)
    
    # MTGの場合
    if 'MTG' in text:
        return 'MTG（マネージャーミーティング）'
    
    # 時間表記の括弧で区切って、最初の部分（シナリオ名）のみを取得
    # 例: "赤の導線(14-18.5)てんてんわん様 5000円" → ["赤の導線", "てんてんわん様 5000円"]
    match = re.match(r'^([^(（]+)', text)
    if match:
        scenario = match.group(1).strip()
    else:
        scenario = text
    
    # さらに※や✅などの記号の前で切る
    scenario = scenario.split('※')[0]
    scenario = scenario.split('✅')[0]
    scenario = scenario.split('🈵')[0]
    
    return scenario.strip()

def extract_reservation_info(title: str) -> str:
    """予約情報を抽出"""
    info_parts = []
    
    # お客様名
    customer_match = re.search(r'([^(]+様)', title)
    if customer_match:
        customer = customer_match.group(1).strip()
        # 価格などを除去
        customer = re.sub(r'\d+円', '', customer)
        info_parts.append(customer)
    
    # 価格
    price_match = re.search(r'(\d+円)', title)
    if price_match:
        info_parts.append(price_match.group(1))
    
    return ' / '.join(info_parts) if info_parts else None

def extract_notes(title: str) -> str:
    """注記を抽出"""
    notes = []
    
    if '※' in title:
        note_parts = title.split('※')
        for part in note_parts[1:]:
            # 次の区切りまでを抽出
            note = part.split('　')[0].strip()
            notes.append('※' + note)
    
    if '✅' in title:
        notes.append('告知済み')
    
    if '🈵' in title:
        notes.append('満席')
    
    if '@' in title and '人' in title:
        participant_match = re.search(r'@(\d+)(?:人)?', title)
        if participant_match:
            notes.append(f'参加者募集中(@{participant_match.group(1)})')
    
    if '指定' in title:
        notes.append('GM指定')
    
    if '見学' in title:
        notes.append('見学あり')
    
    return ' / '.join(notes) if notes else None

def parse_gm_names(gm_text: str) -> list:
    """GM名を配列に分割"""
    if not gm_text or gm_text.strip() == '':
        return []
    
    # 括弧内の情報を除去
    gm_text = re.sub(r'\([^)]+\)', '', gm_text)
    gm_text = re.sub(r'（[^）]+）', '', gm_text)
    
    # 絵文字を除去
    gm_text = re.sub(r'[🈵✅@]', '', gm_text)
    
    # 矢印で分割（GM変更の場合）
    if '→' in gm_text:
        gm_text = gm_text.split('→')[-1]  # 最終的なGMを取得
    
    # カンマやスラッシュで分割
    gms = re.split(r'[,、/]', gm_text)
    
    # クリーンアップ
    gms = [gm.strip() for gm in gms if gm.strip()]
    
    return gms

def parse_date(date_str: str) -> str:
    """日付を解析（2025年11月として）"""
    month, day = date_str.split('/')
    return f"2025-{int(month):02d}-{int(day):02d}"

def parse_schedule_data():
    """スプレッドシートデータを解析"""
    events = []
    lines = SCHEDULE_DATA.strip().split('\n')
    
    for line in lines:
        if not line.strip():
            continue
        
        parts = [p.strip() for p in line.split('\t')]
        
        if len(parts) < 4:
            continue
        
        date_str = parts[0]
        weekday = parts[1]
        manager_type = parts[2]  # ジノ、ツバメ、ソラ
        venue = parts[3]
        
        # 時間帯別のデータを処理
        time_slots = []
        
        # 朝（9:00~）
        if len(parts) > 5 and parts[4]:
            time_slots.append({
                'title': parts[4],
                'gm': parts[5] if len(parts) > 5 else '',
                'default_start': '09:00',
                'default_end': '13:00'
            })
        
        # 昼（13:00~ or 14:00~）
        if len(parts) > 7 and parts[6]:
            time_slots.append({
                'title': parts[6],
                'gm': parts[7] if len(parts) > 7 else '',
                'default_start': '14:00' if weekday in ['土', '日'] else '13:00',
                'default_end': '18:00'
            })
        
        # 夜（19:00~）
        if len(parts) > 9 and parts[8]:
            time_slots.append({
                'title': parts[8],
                'gm': parts[9] if len(parts) > 9 else '',
                'default_start': '19:00',
                'default_end': '23:00'
            })
        
        # 各時間帯のイベントを作成
        for slot in time_slots:
            title = slot['title']
            
            if not title or title.strip() == '':
                continue
            
            # タイトルから時間を抽出、なければデフォルト使用
            times = parse_time_from_title(title)
            if times:
                start_time, end_time = times
            else:
                start_time = slot['default_start']
                end_time = slot['default_end']
            
            # 店舗IDを取得（京都出張などの場合はNone）
            store_id = STORE_MAPPING.get(venue)
            
            event = {
                'date': parse_date(date_str),
                'venue': venue,  # 表示用に店舗名も保持
                'store_id': store_id,  # UIが期待するstore_id
                'scenario': extract_scenario_name(title),
                'gms': parse_gm_names(slot['gm']),
                'start_time': start_time,
                'end_time': end_time,
                'category': determine_category(title),
                'reservation_info': extract_reservation_info(title),
                'notes': extract_notes(title),
                'is_cancelled': False
            }
            
            events.append(event)
    
    return events

def import_to_database(events: list, dry_run=False):
    """データベースに登録"""
    if not supabase:
        print("\nエラー: Supabaseクライアントが初期化されていません")
        print("環境変数を設定してから再度実行してください")
        return
    
    success_count = 0
    error_count = 0
    
    for i, event in enumerate(events, 1):
        try:
            if dry_run:
                print(f"[DRY RUN] {i}. {event['date']} {event['venue']} - {event['scenario']}")
            else:
                result = supabase.table('schedule_events').insert(event).execute()
                success_count += 1
                print(f"✓ {i}. 登録成功: {event['date']} {event['venue']} - {event['scenario']}")
        except Exception as e:
            error_count += 1
            print(f"✗ {i}. 登録失敗: {event['date']} {event['venue']} - {event['scenario']}")
            print(f"   エラー: {str(e)}")
    
    print(f"\n{'=== DRY RUN 完了 ===' if dry_run else '=== 移植完了 ==='}")
    print(f"{'想定' if dry_run else ''}成功: {success_count if not dry_run else len(events)}件")
    print(f"{'想定' if dry_run else ''}失敗: {error_count}件")

def main():
    print("=" * 60)
    print("スプレッドシートデータのインポート")
    print("=" * 60)
    
    # データを解析
    print("\nデータを解析中...")
    events = parse_schedule_data()
    
    print(f"✓ 解析完了: {len(events)}件のイベントを検出しました\n")
    
    # プレビュー表示
    print("=" * 60)
    print("解析結果プレビュー（最初の10件）")
    print("=" * 60)
    
    for i, event in enumerate(events[:10], 1):
        print(f"\n{i}. 【{event['category']}】 {event['date']} {event['venue']}")
        print(f"   シナリオ: {event['scenario']}")
        print(f"   GM: {', '.join(event['gms']) if event['gms'] else '未定'}")
        print(f"   時間: {event['start_time']} - {event['end_time']}")
        if event['reservation_info']:
            print(f"   予約情報: {event['reservation_info']}")
        if event['notes']:
            print(f"   備考: {event['notes']}")
    
    if len(events) > 10:
        print(f"\n... 他 {len(events) - 10}件")
    
    # 確認
    print("\n" + "=" * 60)
    print("データベースへの登録")
    print("=" * 60)
    
    response = input(f"\n{len(events)}件のイベントをデータベースに登録しますか？ (y/n): ")
    
    if response.lower() == 'y':
        print("\n登録を開始します...\n")
        import_to_database(events, dry_run=False)
        print("\n完了しました！")
    else:
        print("\nキャンセルしました。")

if __name__ == "__main__":
    main()

